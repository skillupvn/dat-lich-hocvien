<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω H·ªçc Vi√™n - V3.0 (8 Tab + 5 Tr·∫°ng Th√°i)</title>
    
    <!-- Th∆∞ vi·ªán b√™n ngo√†i -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* ==========================================
           üé® CSS RESET & BASE
        ========================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* ==========================================
           üè† CONTAINER & HEADER
        ========================================== */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .header-actions {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        /* ==========================================
           üìë TABS NAVIGATION
        ========================================== */
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 18px 15px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
            border: none;
            background: none;
            font-size: 0.9em;
            white-space: nowrap;
            min-width: 120px;
        }

        .tab:hover {
            background: #e9ecef;
            color: #495057;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        /* ==========================================
           üì¶ CONTENT AREA
        ========================================== */
        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ==========================================
           üìù FORMS
        ========================================== */
        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .form-section h3 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        /* ==========================================
           üîò BUTTONS
        ========================================== */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-sm {
            padding: 8px 14px;
            font-size: 0.85em;
        }

        .btn-xs {
            padding: 5px 10px;
            font-size: 0.8em;
        }

        /* ==========================================
           üè∑Ô∏è STATUS BADGES (5 Tr·∫°ng th√°i)
        ========================================== */
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-hoc-thu {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status-cho-dang-ky {
            background: #fff8e1;
            color: #f57c00;
        }

        .status-da-dang-ky {
            background: #e8f5e9;
            color: #388e3c;
        }

        .status-hoan-thanh {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .status-cancel {
            background: #ffebee;
            color: #c62828;
        }

        /* ==========================================
           üîç FILTER BAR
        ========================================== */
        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-btn {
            padding: 10px 18px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            background: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .filter-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .filter-btn .count {
            background: rgba(0,0,0,0.1);
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 5px;
            font-size: 0.85em;
        }

        .filter-btn.active .count {
            background: rgba(255,255,255,0.3);
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 0.95em;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* ==========================================
           üìä TABLES
        ========================================== */
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        /* ==========================================
           ‚ö° ACTION BUTTONS (Thao t√°c nhanh)
        ========================================== */
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .action-btn:hover {
            transform: scale(1.05);
        }

        .action-btn-view {
            background: #e3f2fd;
            color: #1976d2;
        }

        .action-btn-schedule {
            background: #fff8e1;
            color: #f57c00;
        }

        .action-btn-edit {
            background: #e8f5e9;
            color: #388e3c;
        }

        .action-btn-delete {
            background: #ffebee;
            color: #c62828;
        }

        .action-btn-register {
            background: #e8f5e9;
            color: #388e3c;
        }

        .action-btn-cancel {
            background: #ffebee;
            color: #c62828;
        }

        .action-btn-receipt {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .action-btn-restore {
            background: #e0f7fa;
            color: #00838f;
        }

        .action-btn-confirm {
            background: #c8e6c9;
            color: #2e7d32;
        }

        /* ==========================================
           üìà STATS CARDS
        ========================================== */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            font-size: 2.2em;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 1em;
        }

        .stat-card.stat-hoc-thu {
            background: linear-gradient(135deg, #42a5f5 0%, #1976d2 100%);
        }

        .stat-card.stat-cho-dang-ky {
            background: linear-gradient(135deg, #ffb74d 0%, #f57c00 100%);
        }

        .stat-card.stat-da-dang-ky {
            background: linear-gradient(135deg, #66bb6a 0%, #388e3c 100%);
        }

        .stat-card.stat-hoan-thanh {
            background: linear-gradient(135deg, #ab47bc 0%, #7b1fa2 100%);
        }

        .stat-card.stat-cancel {
            background: linear-gradient(135deg, #ef5350 0%, #c62828 100%);
        }

        .stat-card.stat-revenue {
            background: linear-gradient(135deg, #26c6da 0%, #00838f 100%);
        }

        /* ==========================================
           üìä CHART
        ========================================== */
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 30px;
        }

        .chart-container h3 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .chart-bars {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 200px;
            padding: 20px 0;
            border-bottom: 2px solid #e9ecef;
        }

        .chart-bar-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .chart-bar {
            width: 50px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px 8px 0 0;
            transition: all 0.3s;
            position: relative;
        }

        .chart-bar:hover {
            opacity: 0.8;
        }

        .chart-bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75em;
            font-weight: 600;
            color: #667eea;
            white-space: nowrap;
        }

        .chart-bar-label {
            margin-top: 10px;
            font-size: 0.85em;
            color: #6c757d;
        }

        /* ==========================================
           üîî MODALS
        ========================================== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalSlideIn 0.3s;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-header h2 {
            color: #667eea;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #6c757d;
            padding: 5px;
            line-height: 1;
        }

        .modal-close:hover {
            color: #dc3545;
        }

        .modal-footer {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* ==========================================
           üìã QUICK VIEW MODAL
        ========================================== */
        .quick-view-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .quick-view-section h4 {
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }

        .quick-view-row {
            display: flex;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .quick-view-row:last-child {
            border-bottom: none;
        }

        .quick-view-label {
            font-weight: 600;
            color: #495057;
            min-width: 140px;
        }

        .quick-view-value {
            color: #212529;
            flex: 1;
        }

        /* ==========================================
           üßæ RECEIPT STYLES
        ========================================== */
        .receipt-preview {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            margin: 0 auto;
        }

        .receipt-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }

        .receipt-logo {
            width: 80px;
            height: 80px;
        }

        .receipt-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .receipt-title {
            text-align: center;
            margin: 20px 0;
        }

        .receipt-title h2 {
            color: #667eea;
            font-size: 1.8em;
        }

        .receipt-amount {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        .receipt-amount-value {
            font-size: 2em;
            color: #667eea;
            font-weight: bold;
        }

        /* ==========================================
           üîî NOTIFICATIONS
        ========================================== */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            background: white;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 2000;
            display: none;
            max-width: 400px;
            animation: slideInRight 0.3s;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .notification.show {
            display: block;
        }

        .notification.success {
            border-left: 4px solid #28a745;
        }

        .notification.error {
            border-left: 4px solid #dc3545;
        }

        .notification.info {
            border-left: 4px solid #17a2b8;
        }

        .notification.warning {
            border-left: 4px solid #ffc107;
        }

        /* ==========================================
           ‚öôÔ∏è SETTINGS
        ========================================== */
        .settings-group {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .settings-group h3 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .logo-preview {
            width: 120px;
            height: 120px;
            border: 2px dashed #e9ecef;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px 0;
            overflow: hidden;
        }

        .logo-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* ==========================================
           üìö CATEGORY TABS
        ========================================== */
        .category-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .category-tab {
            padding: 12px 20px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .category-tab:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .category-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .category-content {
            display: none;
        }

        .category-content.active {
            display: block;
        }

        /* ==========================================
           üì± RESPONSIVE
        ========================================== */
        @media (max-width: 768px) {
            .form-row,
            .form-row-3 {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.6em;
            }

            .header-actions {
                position: static;
                justify-content: center;
                margin-top: 15px;
            }

            .tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
            }

            .tab {
                min-width: 100px;
                padding: 12px 10px;
                font-size: 0.8em;
            }

            .filter-bar {
                flex-direction: column;
            }

            .filter-btn {
                width: 100%;
                justify-content: center;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .stat-card {
                padding: 15px;
            }

            .stat-card h3 {
                font-size: 1.6em;
            }

            .modal-content {
                padding: 20px;
                margin: 10px;
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* ==========================================
           üñ®Ô∏è PRINT STYLES
        ========================================== */
        @media print {
            body * {
                visibility: hidden;
            }

            .print-area,
            .print-area * {
                visibility: visible;
            }

            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }

        /* ==========================================
           üéØ UTILITY CLASSES
        ========================================== */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-muted { color: #6c757d; }
        .text-success { color: #28a745; }
        .text-danger { color: #dc3545; }
        .text-warning { color: #ffc107; }
        .text-info { color: #17a2b8; }
        .text-primary { color: #667eea; }

        .mt-10 { margin-top: 10px; }
        .mt-20 { margin-top: 20px; }
        .mt-30 { margin-top: 30px; }
        .mb-10 { margin-bottom: 10px; }
        .mb-20 { margin-bottom: 20px; }
        .mb-30 { margin-bottom: 30px; }

        .d-flex { display: flex; }
        .gap-10 { gap: 10px; }
        .gap-20 { gap: 20px; }
        .justify-between { justify-content: space-between; }
        .align-center { align-items: center; }
        .flex-wrap { flex-wrap: wrap; }

        .hidden { display: none !important; }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 15px;
        }

        .subject-tag {
            display: inline-block;
            padding: 3px 10px;
            background: #e9ecef;
            border-radius: 15px;
            font-size: 0.85em;
            margin: 2px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .checkbox-item input {
            width: auto;
        }

        /* Upcoming appointments */
        .upcoming-item {
            background: #fff8e1;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #ffc107;
            margin-bottom: 10px;
        }

        .upcoming-item strong {
            color: #f57c00;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ==========================================
             üè† HEADER
        ========================================== -->
        <div class="header">
            <div class="header-actions">
                <button class="btn btn-warning btn-sm" onclick="createManualBackup()">
                    üíæ Backup
                </button>
            </div>
            <h1>üìö H·ªá Th·ªëng Qu·∫£n L√Ω Trung T√¢m</h1>
            <p>Version 3.0 - 8 Tab + 5 Tr·∫°ng Th√°i H·ªçc Vi√™n</p>
        </div>

        <!-- ==========================================
             üìë TABS NAVIGATION (8 Tabs)
        ========================================== -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">
                üìä T·ªïng Quan
            </button>
            <button class="tab" onclick="switchTab('students')">
                üë©‚Äçüéì H·ªçc Vi√™n
            </button>
            <button class="tab" onclick="switchTab('trial')">
                üéì H·ªçc Th·ª≠
            </button>
            <button class="tab" onclick="switchTab('appointments')">
                üìÖ L·ªãch H·∫πn
            </button>
            <button class="tab" onclick="switchTab('receipts')">
                üßæ Bi√™n Lai
            </button>
            <button class="tab" onclick="switchTab('categories')">
                üìö Danh M·ª•c
            </button>
            <button class="tab" onclick="switchTab('export')">
                üì§ Xu·∫•t Data
            </button>
            <button class="tab" onclick="switchTab('settings')">
                ‚öôÔ∏è C√†i ƒê·∫∑t
            </button>
        </div>

        <!-- ==========================================
             üì¶ CONTENT AREA
        ========================================== -->
        <div class="content">
            
            <!-- ==========================================
                 TAB 1: üìä T·ªîNG QUAN (Dashboard)
            ========================================== -->
            <div id="dashboard" class="tab-content active">
                <h2 class="mb-20">üìä T·ªïng Quan H·ªá Th·ªëng</h2>
                
                <!-- Stats Cards -->
                <div class="stats" id="dashboardStats">
                    <!-- Render by JS -->
                </div>

                <!-- Revenue Chart -->
                <div class="chart-container">
                    <h3>üìà Doanh Thu 6 Th√°ng G·∫ßn Nh·∫•t</h3>
                    <div class="chart-bars" id="revenueChart">
                        <!-- Render by JS -->
                    </div>
                </div>

                <!-- Upcoming Appointments -->
                <div class="mt-30">
                    <h3 class="mb-20">üìÖ L·ªãch H·∫πn S·∫Øp T·ªõi</h3>
                    <div id="upcomingAppointments">
                        <!-- Render by JS -->
                    </div>
                </div>
            </div>

            <!-- ==========================================
                 TAB 2: üë©‚Äçüéì H·ªåC VI√äN (Form + DS)
            ========================================== -->
            <div id="students" class="tab-content">
                <h2 class="mb-20">üë©‚Äçüéì Qu·∫£n L√Ω H·ªçc Vi√™n</h2>
                
                <!-- Form Section (Collapsible) -->
                <div class="form-section" id="studentFormSection">
                    <h3>
                        <span id="formTitle">‚ûï Th√™m H·ªçc Vi√™n M·ªõi</span>
                        <button class="btn btn-sm btn-secondary" style="float: right;" onclick="toggleStudentForm()">
                            <span id="toggleFormIcon">‚ñº</span>
                        </button>
                    </h3>
                    
                    <form id="studentForm" onsubmit="saveStudent(event)">
                        <input type="hidden" id="editStudentId" value="">
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>T√™n H·ªçc Vi√™n *</label>
                                <input type="text" id="studentName" required placeholder="Nh·∫≠p t√™n h·ªçc vi√™n">
                            </div>
                            <div class="form-group">
                                <label>Tu·ªïi *</label>
                                <input type="number" id="studentAge" required min="3" max="18" placeholder="Nh·∫≠p tu·ªïi">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>T√™n Ph·ª• Huynh *</label>
                                <input type="text" id="parentName" required placeholder="Nh·∫≠p t√™n ph·ª• huynh">
                            </div>
                            <div class="form-group">
                                <label>S·ªë ƒêi·ªán Tho·∫°i *</label>
                                <input type="tel" id="parentPhone" required placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Email Ph·ª• Huynh</label>
                                <input type="email" id="parentEmail" placeholder="Nh·∫≠p email (t√πy ch·ªçn)">
                            </div>
                            <div class="form-group">
                                <label>Tr·∫°ng Th√°i *</label>
                                <select id="studentStatus" required>
                                    <option value="H·ªçc Th·ª≠">üÜï H·ªçc Th·ª≠</option>
                                    <option value="Ch·ªù ƒêƒÉng K√Ω">‚è≥ Ch·ªù ƒêƒÉng K√Ω</option>
                                    <option value="ƒê√£ ƒêƒÉng K√Ω">‚úÖ ƒê√£ ƒêƒÉng K√Ω</option>
                                    <option value="Ho√†n Th√†nh">üéì Ho√†n Th√†nh</option>
                                    <option value="Cancel">‚ùå Cancel</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>M√¥n H·ªçc Quan T√¢m *</label>
                            <div class="checkbox-group" id="subjectCheckboxes">
                                <!-- Render by JS t·ª´ danh m·ª•c -->
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Ghi Ch√∫</label>
                            <textarea id="studentNotes" rows="3" placeholder="Nh·∫≠p ghi ch√∫ (t√πy ch·ªçn)"></textarea>
                        </div>

                        <div class="d-flex gap-10">
                            <button type="submit" class="btn btn-primary" id="saveStudentBtn">
                                üíæ L∆∞u H·ªçc Vi√™n
                            </button>
                            <button type="button" class="btn btn-secondary hidden" id="cancelEditBtn" onclick="cancelEdit()">
                                ‚ùå H·ªßy
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Filter Bar -->
                <div class="filter-bar">
                    <button class="filter-btn active" onclick="filterStudents('all')" data-filter="all">
                        üìã T·∫•t c·∫£ <span class="count" id="countAll">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterStudents('H·ªçc Th·ª≠')" data-filter="H·ªçc Th·ª≠">
                        üÜï H·ªçc Th·ª≠ <span class="count" id="countHocThu">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterStudents('Ch·ªù ƒêƒÉng K√Ω')" data-filter="Ch·ªù ƒêƒÉng K√Ω">
                        ‚è≥ Ch·ªù ƒêK <span class="count" id="countChoDangKy">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterStudents('ƒê√£ ƒêƒÉng K√Ω')" data-filter="ƒê√£ ƒêƒÉng K√Ω">
                        ‚úÖ ƒê√£ ƒêK <span class="count" id="countDaDangKy">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterStudents('Ho√†n Th√†nh')" data-filter="Ho√†n Th√†nh">
                        üéì Ho√†n Th√†nh <span class="count" id="countHoanThanh">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterStudents('Cancel')" data-filter="Cancel">
                        ‚ùå Cancel <span class="count" id="countCancel">0</span>
                    </button>
                    <div class="search-box">
                        <input type="text" id="searchStudent" placeholder="üîç T√¨m ki·∫øm h·ªçc vi√™n..." oninput="searchStudents()">
                    </div>
                </div>

                <!-- Students Table -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>T√™n HV</th>
                                <th>Tu·ªïi</th>
                                <th>Ph·ª• Huynh</th>
                                <th>SƒêT</th>
                                <th>M√¥n H·ªçc</th>
                                <th>Tr·∫°ng Th√°i</th>
                                <th>Thao T√°c</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody">
                            <!-- Render by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ==========================================
                 TAB 3: üéì H·ªåC TH·ª¨
            ========================================== -->
            <div id="trial" class="tab-content">
                <h2 class="mb-20">üéì Danh S√°ch H·ªçc Th·ª≠ & Ch·ªù ƒêƒÉng K√Ω</h2>
                
                <!-- Filter for Trial Tab -->
                <div class="filter-bar">
                    <button class="filter-btn active" onclick="filterTrialStudents('all')" data-filter="all">
                        üìã T·∫•t c·∫£ <span class="count" id="trialCountAll">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterTrialStudents('H·ªçc Th·ª≠')" data-filter="H·ªçc Th·ª≠">
                        üÜï H·ªçc Th·ª≠ <span class="count" id="trialCountHocThu">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterTrialStudents('Ch·ªù ƒêƒÉng K√Ω')" data-filter="Ch·ªù ƒêƒÉng K√Ω">
                        ‚è≥ Ch·ªù ƒêƒÉng K√Ω <span class="count" id="trialCountChoDangKy">0</span>
                    </button>
                    <div class="search-box">
                        <input type="text" id="searchTrialStudent" placeholder="üîç T√¨m ki·∫øm..." oninput="searchTrialStudents()">
                    </div>
                </div>

                <!-- Trial Students Table -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>T√™n HV</th>
                                <th>Tu·ªïi</th>
                                <th>Ph·ª• Huynh</th>
                                <th>SƒêT</th>
                                <th>M√¥n H·ªçc</th>
                                <th>Tr·∫°ng Th√°i</th>
                                <th>L·ªãch H·∫πn</th>
                                <th>Thao T√°c</th>
                            </tr>
                        </thead>
                        <tbody id="trialStudentsTableBody">
                            <!-- Render by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ==========================================
                 TAB 4: üìÖ L·ªäCH H·∫∏N
            ========================================== -->
            <div id="appointments" class="tab-content">
                <h2 class="mb-20">üìÖ Qu·∫£n L√Ω L·ªãch H·∫πn</h2>
                
                <!-- Filter Bar -->
                <div class="filter-bar">
                    <button class="filter-btn active" onclick="filterAppointments('all')">
                        üìã T·∫•t c·∫£
                    </button>
                    <button class="filter-btn" onclick="filterAppointments('upcoming')">
                        ‚è∞ S·∫Øp t·ªõi
                    </button>
                    <button class="filter-btn" onclick="filterAppointments('past')">
                        ‚úÖ ƒê√£ qua
                    </button>
                    <div class="search-box">
                        <input type="text" id="searchAppointment" placeholder="üîç T√¨m ki·∫øm l·ªãch h·∫πn..." oninput="searchAppointments()">
                    </div>
                </div>

                <!-- Appointments Table -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>H·ªçc Vi√™n</th>
                                <th>Ph·ª• Huynh</th>
                                <th>SƒêT</th>
                                <th>M√¥n H·ªçc</th>
                                <th>Ng√†y</th>
                                <th>Gi·ªù</th>
                                <th>Tr·∫°ng Th√°i</th>
                                <th>Thao T√°c</th>
                            </tr>
                        </thead>
                        <tbody id="appointmentsTableBody">
                            <!-- Render by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ==========================================
                 TAB 5: üßæ BI√äN LAI
            ========================================== -->
            <div id="receipts" class="tab-content">
                <h2 class="mb-20">üßæ Qu·∫£n L√Ω Bi√™n Lai</h2>
                
                <div class="d-flex justify-between align-center mb-20 flex-wrap gap-10">
                    <button class="btn btn-success" onclick="openReceiptModal()">
                        ‚ûï T·∫°o Bi√™n Lai M·ªõi
                    </button>
                    <div class="search-box" style="flex: 1; max-width: 300px;">
                        <input type="text" id="searchReceipt" placeholder="üîç T√¨m ki·∫øm bi√™n lai..." oninput="searchReceipts()">
                    </div>
                </div>

                <!-- Receipts Table -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>M√£ BL</th>
                                <th>Lo·∫°i</th>
                                <th>H·ªçc Vi√™n</th>
                                <th>N·ªôi Dung</th>
                                <th>S·ªë Ti·ªÅn</th>
                                <th>Ng√†y</th>
                                <th>Thao T√°c</th>
                            </tr>
                        </thead>
                        <tbody id="receiptsTableBody">
                            <!-- Render by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ==========================================
                 TAB 6: üìö DANH M·ª§C
            ========================================== -->
            <div id="categories" class="tab-content">
                <h2 class="mb-20">üìö Qu·∫£n L√Ω Danh M·ª•c</h2>
                
                <!-- Category Sub-tabs -->
                <div class="category-tabs">
                    <button class="category-tab active" onclick="switchCategoryTab('subjects')">
                        üìñ M√¥n H·ªçc
                    </button>
                    <button class="category-tab" onclick="switchCategoryTab('packages')">
                        üì¶ G√≥i H·ªçc Ph√≠
                    </button>
                    <button class="category-tab" onclick="switchCategoryTab('promotions')">
                        üéÅ Khuy·∫øn M√£i
                    </button>
                </div>

                <!-- Subjects Content -->
                <div id="subjectsContent" class="category-content active">
                    <div class="d-flex justify-between align-center mb-20">
                        <h3>üìñ Danh S√°ch M√¥n H·ªçc</h3>
                        <button class="btn btn-success" onclick="openSubjectModal()">
                            ‚ûï Th√™m M√¥n H·ªçc
                        </button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Icon</th>
                                    <th>T√™n M√¥n</th>
                                    <th>H·ªçc Ph√≠ M·∫∑c ƒê·ªãnh</th>
                                    <th>Thao T√°c</th>
                                </tr>
                            </thead>
                            <tbody id="subjectsTableBody">
                                <!-- Render by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Packages Content -->
                <div id="packagesContent" class="category-content">
                    <div class="d-flex justify-between align-center mb-20">
                        <h3>üì¶ Danh S√°ch G√≥i H·ªçc Ph√≠</h3>
                        <button class="btn btn-success" onclick="openPackageModal()">
                            ‚ûï Th√™m G√≥i
                        </button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>T√™n G√≥i</th>
                                    <th>M√¥n H·ªçc</th>
                                    <th>S·ªë Bu·ªïi</th>
                                    <th>H·ªçc Ph√≠</th>
                                    <th>Thao T√°c</th>
                                </tr>
                            </thead>
                            <tbody id="packagesTableBody">
                                <!-- Render by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Promotions Content -->
                <div id="promotionsContent" class="category-content">
                    <div class="d-flex justify-between align-center mb-20">
                        <h3>üéÅ Danh S√°ch Khuy·∫øn M√£i</h3>
                        <button class="btn btn-success" onclick="openPromotionModal()">
                            ‚ûï Th√™m Khuy·∫øn M√£i
                        </button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>T√™n KM</th>
                                    <th>Lo·∫°i</th>
                                    <th>Gi√° Tr·ªã</th>
                                    <th>Th·ªùi H·∫°n</th>
                                    <th>Tr·∫°ng Th√°i</th>
                                    <th>Thao T√°c</th>
                                </tr>
                            </thead>
                            <tbody id="promotionsTableBody">
                                <!-- Render by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ==========================================
                 TAB 7: üì§ XU·∫§T DATA
            ========================================== -->
            <div id="export" class="tab-content">
                <h2 class="mb-20">üì§ Xu·∫•t D·ªØ Li·ªáu & Sao L∆∞u</h2>
                
                <!-- Export Excel -->
                <div class="settings-group">
                    <h3>üìä Xu·∫•t File Excel</h3>
                    <div class="d-flex gap-10 flex-wrap">
                        <button class="btn btn-success" onclick="exportAllToExcel()">
                            üìä Xu·∫•t T·∫•t C·∫£
                        </button>
                        <button class="btn btn-info" onclick="exportStudentsToExcel()">
                            üë©‚Äçüéì H·ªçc Vi√™n
                        </button>
                        <button class="btn btn-warning" onclick="exportAppointmentsToExcel()">
                            üìÖ L·ªãch H·∫πn
                        </button>
                        <button class="btn btn-primary" onclick="exportReceiptsToExcel()">
                            üßæ Bi√™n Lai
                        </button>
                    </div>
                </div>

                <!-- Backup/Restore -->
                <div class="settings-group">
                    <h3>üíæ Sao L∆∞u & Kh√¥i Ph·ª•c</h3>
                    <div class="d-flex gap-10 flex-wrap">
                        <button class="btn btn-success" onclick="exportBackupJSON()">
                            üíæ T·∫£i Backup JSON
                        </button>
                        <label class="btn btn-info" style="cursor: pointer;">
                            üìÅ Kh√¥i Ph·ª•c JSON
                            <input type="file" accept=".json" onchange="restoreFromJSON(event)" style="display: none;">
                        </label>
                    </div>
                </div>

                <!-- Backup History -->
                <div class="settings-group">
                    <h3>üìú L·ªãch S·ª≠ Backup T·ª± ƒê·ªông</h3>
                    <div id="backupHistoryList">
                        <!-- Render by JS -->
                    </div>
                </div>
            </div>

            <!-- ==========================================
                 TAB 8: ‚öôÔ∏è C√ÄI ƒê·∫∂T
            ========================================== -->
            <div id="settings" class="tab-content">
                <h2 class="mb-20">‚öôÔ∏è C√†i ƒê·∫∑t H·ªá Th·ªëng</h2>
                
                <!-- Center Info -->
                <div class="settings-group">
                    <h3>üè¢ Th√¥ng Tin Trung T√¢m</h3>
                    <form id="centerInfoForm" onsubmit="saveCenterInfo(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>T√™n Trung T√¢m *</label>
                                <input type="text" id="centerName" placeholder="VD: Trung T√¢m Gi√°o D·ª•c ABC">
                            </div>
                            <div class="form-group">
                                <label>S·ªë ƒêi·ªán Tho·∫°i *</label>
                                <input type="tel" id="centerPhone" placeholder="VD: 0912345678">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>ƒê·ªãa Ch·ªâ *</label>
                            <input type="text" id="centerAddress" placeholder="VD: 123 ƒê∆∞·ªùng ABC, Qu·∫≠n XYZ">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="centerEmail" placeholder="VD: contact@abc.edu.vn">
                            </div>
                            <div class="form-group">
                                <label>Website</label>
                                <input type="url" id="centerWebsite" placeholder="VD: https://abc.edu.vn">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Logo Trung T√¢m</label>
                            <input type="file" id="centerLogo" accept="image/*" onchange="previewLogo(event)">
                            <div class="logo-preview" id="logoPreview">
                                <span class="text-muted">Ch∆∞a c√≥ logo</span>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">üíæ L∆∞u Th√¥ng Tin</button>
                    </form>
                </div>

                <!-- Bank Info -->
                <div class="settings-group">
                    <h3>üí≥ Th√¥ng Tin Ng√¢n H√†ng</h3>
                    <form id="bankInfoForm" onsubmit="saveBankInfo(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>T√™n Ng√¢n H√†ng *</label>
                                <input type="text" id="bankName" placeholder="VD: Vietcombank">
                            </div>
                            <div class="form-group">
                                <label>S·ªë T√†i Kho·∫£n *</label>
                                <input type="text" id="bankAccount" placeholder="VD: 1234567890">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Ch·ªß T√†i Kho·∫£n *</label>
                                <input type="text" id="bankAccountName" placeholder="VD: NGUYEN VAN A">
                            </div>
                            <div class="form-group">
                                <label>Chi Nh√°nh</label>
                                <input type="text" id="bankBranch" placeholder="VD: Chi nh√°nh T√¢n B√¨nh">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">üíæ L∆∞u Th√¥ng Tin Ng√¢n H√†ng</button>
                    </form>
                    <div class="mt-20">
                        <h4>M√£ QR Chuy·ªÉn Kho·∫£n:</h4>
                        <div id="bankQRCode" class="mt-10"></div>
                    </div>
                </div>

                <!-- Auto Backup -->
                <div class="settings-group">
                    <h3>üîÑ Sao L∆∞u T·ª± ƒê·ªông</h3>
                    <div class="d-flex align-center gap-20">
                        <label class="d-flex align-center gap-10">
                            <input type="checkbox" id="autoBackupToggle" onchange="toggleAutoBackup()">
                            <span>B·∫≠t sao l∆∞u t·ª± ƒë·ªông</span>
                        </label>
                        <span id="autoBackupStatus" class="text-muted">Ch∆∞a k√≠ch ho·∫°t</span>
                    </div>
                </div>

                <!-- Clear Data -->
                <div class="settings-group">
                    <h3>üóëÔ∏è X√≥a D·ªØ Li·ªáu</h3>
                    <p class="text-muted mb-10">‚ö†Ô∏è C·∫£nh b√°o: H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</p>
                    <button class="btn btn-danger" onclick="clearAllData()">
                        üóëÔ∏è X√≥a To√†n B·ªô D·ªØ Li·ªáu
                    </button>
                </div>
            </div>

        </div><!-- End .content -->
    </div><!-- End .container -->

    <!-- ==========================================
         üîî MODALS
    ========================================== -->
    
    <!-- Quick View Modal -->
    <div id="quickViewModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>üëÅÔ∏è Th√¥ng Tin Chi Ti·∫øt</h2>
                <button class="modal-close" onclick="closeModal('quickViewModal')">&times;</button>
            </div>
            <div id="quickViewContent">
                <!-- Render by JS -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('quickViewModal')">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- Appointment Modal -->
    <div id="appointmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìÖ ƒê·∫∑t L·ªãch H·∫πn</h2>
                <button class="modal-close" onclick="closeModal('appointmentModal')">&times;</button>
            </div>
            <form id="appointmentForm" onsubmit="saveAppointment(event)">
                <input type="hidden" id="appointmentStudentId">
                <input type="hidden" id="editAppointmentId">
                
                <div class="form-group">
                    <label>H·ªçc Vi√™n</label>
                    <input type="text" id="appointmentStudentName" readonly style="background: #f8f9fa;">
                </div>
                
                <div class="form-group">
                    <label>M√¥n H·ªçc *</label>
                    <select id="appointmentSubject" required>
                        <option value="">-- Ch·ªçn m√¥n h·ªçc --</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Ng√†y H·∫πn *</label>
                        <input type="date" id="appointmentDate" required>
                    </div>
                    <div class="form-group">
                        <label>Gi·ªù H·∫πn *</label>
                        <input type="time" id="appointmentTime" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Ghi Ch√∫</label>
                    <textarea id="appointmentNotes" rows="3" placeholder="Ghi ch√∫ v·ªÅ bu·ªïi h·ªçc th·ª≠"></textarea>
                </div>
                
                <div id="appointmentConflictWarning" class="hidden" style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                    <!-- Conflict warning -->
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('appointmentModal')">H·ªßy</button>
                    <button type="submit" class="btn btn-success">üíæ L∆∞u L·ªãch H·∫πn</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Registration Modal (Phi·∫øu ƒêƒÉng K√Ω) -->
    <div id="registrationModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>‚úÖ T·∫°o Phi·∫øu ƒêƒÉng K√Ω</h2>
                <button class="modal-close" onclick="closeModal('registrationModal')">&times;</button>
            </div>
            <form id="registrationForm" onsubmit="saveRegistration(event)">
                <input type="hidden" id="regStudentId">
                
                <div class="form-group">
                    <label>H·ªçc Vi√™n</label>
                    <input type="text" id="regStudentName" readonly style="background: #f8f9fa;">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>M√¥n H·ªçc *</label>
                        <select id="regSubject" required onchange="loadPackagesForSubject()">
                            <option value="">-- Ch·ªçn m√¥n h·ªçc --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>G√≥i H·ªçc Ph√≠</label>
                        <select id="regPackage" onchange="applyPackageFee()">
                            <option value="">-- Nh·∫≠p th·ªß c√¥ng --</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>H·ªçc Ph√≠ (VNƒê) *</label>
                    <input type="text" id="regTuitionFee" required placeholder="VD: 2,000,000" oninput="formatCurrencyInput(this); calculateFinalAmount()">
                </div>
                
                <div class="form-group">
                    <label>Khuy·∫øn M√£i (ch·ªçn nhi·ªÅu)</label>
                    <div id="regPromotionList" class="checkbox-group">
                        <!-- Render by JS -->
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>T·ªïng Gi·∫£m Gi√°</label>
                        <input type="text" id="regDiscountAmount" readonly style="background: #ffebee; color: #c62828; font-weight: 600;">
                    </div>
                    <div class="form-group">
                        <label>Th√†nh Ti·ªÅn</label>
                        <input type="text" id="regFinalAmount" readonly style="background: #e8f5e9; color: #388e3c; font-weight: 600; font-size: 1.2em;">
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('registrationModal')">H·ªßy</button>
                    <button type="submit" class="btn btn-success">‚úÖ X√°c Nh·∫≠n ƒêƒÉng K√Ω</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receiptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üßæ T·∫°o Bi√™n Lai</h2>
                <button class="modal-close" onclick="closeModal('receiptModal')">&times;</button>
            </div>
            <form id="receiptForm" onsubmit="saveReceipt(event)">
                <input type="hidden" id="editReceiptId">
                
                <div class="form-group">
                    <label>Lo·∫°i Bi√™n Lai *</label>
                    <select id="receiptType" required>
                        <option value="">-- Ch·ªçn lo·∫°i --</option>
                        <option value="Bi√™n Lai ƒêi·ªán T·ª≠">üí≥ Bi√™n Lai ƒêi·ªán T·ª≠ (Chuy·ªÉn kho·∫£n)</option>
                        <option value="Phi·∫øu Thu">üíµ Phi·∫øu Thu (Ti·ªÅn m·∫∑t)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>H·ªçc Vi√™n * (ch·ªâ hi·ªán HV "ƒê√£ ƒêƒÉng K√Ω")</label>
                    <select id="receiptStudentId" required onchange="fillReceiptStudentInfo()">
                        <option value="">-- Ch·ªçn h·ªçc vi√™n --</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Ph·ª• Huynh</label>
                        <input type="text" id="receiptParentName" readonly style="background: #f8f9fa;">
                    </div>
                    <div class="form-group">
                        <label>SƒêT</label>
                        <input type="text" id="receiptParentPhone" readonly style="background: #f8f9fa;">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>N·ªôi Dung Thu *</label>
                    <input type="text" id="receiptDescription" required placeholder="VD: H·ªçc ph√≠ th√°ng 1 - C·ªù Vua">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>S·ªë Ti·ªÅn (VNƒê) *</label>
                        <input type="text" id="receiptAmount" required placeholder="VD: 2,000,000" oninput="formatCurrencyInput(this)">
                    </div>
                    <div class="form-group">
                        <label>Ng√†y Thu *</label>
                        <input type="date" id="receiptDate" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Ghi Ch√∫</label>
                    <textarea id="receiptNotes" rows="2" placeholder="Ghi ch√∫ (t√πy ch·ªçn)"></textarea>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('receiptModal')">H·ªßy</button>
                    <button type="submit" class="btn btn-success">üíæ L∆∞u Bi√™n Lai</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Receipt Modal -->
    <div id="viewReceiptModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>üßæ Xem Bi√™n Lai</h2>
                <button class="modal-close" onclick="closeModal('viewReceiptModal')">&times;</button>
            </div>
            <div id="receiptPreviewContent" class="print-area">
                <!-- Render by JS -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-info" onclick="printReceipt()">üñ®Ô∏è In</button>
                <button class="btn btn-primary" onclick="downloadReceiptPDF()">üìÑ T·∫£i PDF</button>
                <button class="btn btn-secondary" onclick="closeModal('viewReceiptModal')">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- Subject Modal -->
    <div id="subjectModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="subjectModalTitle">üìñ Th√™m M√¥n H·ªçc</h2>
                <button class="modal-close" onclick="closeModal('subjectModal')">&times;</button>
            </div>
            <form id="subjectForm" onsubmit="saveSubject(event)">
                <input type="hidden" id="editSubjectId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Icon (Emoji) *</label>
                        <input type="text" id="subjectIcon" required placeholder="VD: ‚ôüÔ∏è">
                    </div>
                    <div class="form-group">
                        <label>T√™n M√¥n *</label>
                        <input type="text" id="subjectName" required placeholder="VD: C·ªù Vua">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>H·ªçc Ph√≠ M·∫∑c ƒê·ªãnh (VNƒê) *</label>
                    <input type="text" id="subjectDefaultFee" required placeholder="VD: 2,000,000" oninput="formatCurrencyInput(this)">
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('subjectModal')">H·ªßy</button>
                    <button type="submit" class="btn btn-success">üíæ L∆∞u</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Package Modal -->
    <div id="packageModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="packageModalTitle">üì¶ Th√™m G√≥i H·ªçc Ph√≠</h2>
                <button class="modal-close" onclick="closeModal('packageModal')">&times;</button>
            </div>
            <form id="packageForm" onsubmit="savePackage(event)">
                <input type="hidden" id="editPackageId">
                
                <div class="form-group">
                    <label>T√™n G√≥i *</label>
                    <input type="text" id="packageName" required placeholder="VD: G√≥i C∆° B·∫£n">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>M√¥n H·ªçc *</label>
                        <select id="packageSubject" required>
                            <option value="">-- Ch·ªçn m√¥n --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>S·ªë Bu·ªïi *</label>
                        <input type="number" id="packageSessions" required min="1" placeholder="VD: 8">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>H·ªçc Ph√≠ (VNƒê) *</label>
                    <input type="text" id="packageFee" required placeholder="VD: 1,600,000" oninput="formatCurrencyInput(this)">
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('packageModal')">H·ªßy</button>
                    <button type="submit" class="btn btn-success">üíæ L∆∞u</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Promotion Modal -->
    <div id="promotionModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="promotionModalTitle">üéÅ Th√™m Khuy·∫øn M√£i</h2>
                <button class="modal-close" onclick="closeModal('promotionModal')">&times;</button>
            </div>
            <form id="promotionForm" onsubmit="savePromotion(event)">
                <input type="hidden" id="editPromotionId">
                
                <div class="form-group">
                    <label>T√™n Khuy·∫øn M√£i *</label>
                    <input type="text" id="promotionName" required placeholder="VD: KM Khai Tr∆∞∆°ng">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Lo·∫°i Gi·∫£m *</label>
                        <select id="promotionType" required>
                            <option value="percent">Gi·∫£m %</option>
                            <option value="fixed">Gi·∫£m VNƒê</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Gi√° Tr·ªã *</label>
                        <input type="number" id="promotionValue" required min="0" placeholder="VD: 10 ho·∫∑c 200000">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>T·ª´ Ng√†y *</label>
                        <input type="date" id="promotionStartDate" required>
                    </div>
                    <div class="form-group">
                        <label>ƒê·∫øn Ng√†y *</label>
                        <input type="date" id="promotionEndDate" required>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('promotionModal')">H·ªßy</button>
                    <button type="submit" class="btn btn-success">üíæ L∆∞u</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <!-- ==========================================
         üìú JAVASCRIPT (Ph·∫ßn 2/2)
    ========================================== -->
    <script>
// ==========================================
// üìä DATA STORAGE (LocalStorage)
// ==========================================

// Kh·ªüi t·∫°o d·ªØ li·ªáu t·ª´ LocalStorage
let students = JSON.parse(localStorage.getItem('students')) || [];
let appointments = JSON.parse(localStorage.getItem('appointments')) || [];
let receipts = JSON.parse(localStorage.getItem('receipts')) || [];
let subjects = JSON.parse(localStorage.getItem('subjects')) || [
    { id: 1, icon: '‚ôüÔ∏è', name: 'C·ªù Vua', defaultFee: 2000000 },
    { id: 2, icon: 'üé®', name: 'V·∫Ω Tranh', defaultFee: 1800000 },
    { id: 3, icon: 'üìö', name: 'Ti·ªÅn Ti·ªÉu H·ªçc', defaultFee: 1500000 },
    { id: 4, icon: '‚úçÔ∏è', name: 'R√®n Ch·ªØ', defaultFee: 1600000 }
];
let packages = JSON.parse(localStorage.getItem('packages')) || [];
let promotions = JSON.parse(localStorage.getItem('promotions')) || [];
let centerInfo = JSON.parse(localStorage.getItem('centerInfo')) || {};
let bankInfo = JSON.parse(localStorage.getItem('bankInfo')) || {};
let backupHistory = JSON.parse(localStorage.getItem('backupHistory')) || [];
let autoBackupEnabled = localStorage.getItem('autoBackupEnabled') === 'true';

// Tr·∫°ng th√°i hi·ªán t·∫°i
let currentFilter = 'all';
let currentTrialFilter = 'all';
let currentAppointmentFilter = 'all';

// ==========================================
// üöÄ KH·ªûI T·∫†O ·ª®NG D·ª§NG
// ==========================================

document.addEventListener('DOMContentLoaded', function() {
    // Migrate data c≈© (n·∫øu c√≥)
    migrateOldData();
    
    // Render t·∫•t c·∫£
    renderAll();
    
    // Load settings
    loadCenterInfo();
    loadBankInfo();
    updateAutoBackupStatus();
    
    // Set default date cho form
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('appointmentDate').min = today;
    document.getElementById('receiptDate').value = today;
    document.getElementById('autoBackupToggle').checked = autoBackupEnabled;
    
    // Render subject checkboxes trong form h·ªçc vi√™n
    renderSubjectCheckboxes();
});

// Migrate d·ªØ li·ªáu c≈© sang c·∫•u tr√∫c m·ªõi
function migrateOldData() {
    let needSave = false;
    
    students.forEach(student => {
        // Th√™m status n·∫øu ch∆∞a c√≥
        if (!student.status) {
            student.status = 'H·ªçc Th·ª≠';
            needSave = true;
        }
        
        // Th√™m previousStatus n·∫øu ch∆∞a c√≥
        if (student.previousStatus === undefined) {
            student.previousStatus = null;
            needSave = true;
        }
        
        // Th√™m registrations array n·∫øu ch∆∞a c√≥
        if (!student.registrations) {
            student.registrations = [];
            needSave = true;
        }
    });
    
    if (needSave) {
        saveData('students', students);
    }
}

// ==========================================
// üíæ DATA HELPERS
// ==========================================

function saveData(key, data) {
    localStorage.setItem(key, JSON.stringify(data));
    
    // Auto backup
    if (autoBackupEnabled) {
        createAutoBackup();
    }
}

function generateId() {
    return Date.now() + Math.random().toString(36).substr(2, 9);
}

// ==========================================
// üìë TAB NAVIGATION
// ==========================================

function switchTab(tabName) {
    // ·∫®n t·∫•t c·∫£ tab content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // B·ªè active t·∫•t c·∫£ tab buttons
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Hi·ªán tab ƒë∆∞·ª£c ch·ªçn
    document.getElementById(tabName).classList.add('active');
    event.target.classList.add('active');
    
    // Render l·∫°i data cho tab t∆∞∆°ng ·ª©ng
    switch(tabName) {
        case 'dashboard':
            renderDashboard();
            break;
        case 'students':
            renderStudentsTable();
            updateStudentCounts();
            break;
        case 'trial':
            renderTrialStudentsTable();
            updateTrialCounts();
            break;
        case 'appointments':
            renderAppointmentsTable();
            break;
        case 'receipts':
            renderReceiptsTable();
            break;
        case 'categories':
            renderSubjectsTable();
            break;
        case 'export':
            renderBackupHistory();
            break;
        case 'settings':
            loadCenterInfo();
            loadBankInfo();
            break;
    }
}

function switchCategoryTab(tabName) {
    // ·∫®n t·∫•t c·∫£ category content
    document.querySelectorAll('.category-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // B·ªè active t·∫•t c·∫£ category tabs
    document.querySelectorAll('.category-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Hi·ªán tab ƒë∆∞·ª£c ch·ªçn
    document.getElementById(tabName + 'Content').classList.add('active');
    event.target.classList.add('active');
    
    // Render data
    switch(tabName) {
        case 'subjects':
            renderSubjectsTable();
            break;
        case 'packages':
            renderPackagesTable();
            break;
        case 'promotions':
            renderPromotionsTable();
            break;
    }
}

// ==========================================
// üîî NOTIFICATIONS
// ==========================================

function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    notification.className = `notification ${type} show`;
    notification.innerHTML = `
        <strong>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</strong>
        <span style="margin-left: 10px;">${message}</span>
    `;
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

// ==========================================
// üî≤ MODAL HELPERS
// ==========================================

function openModal(modalId) {
    document.getElementById(modalId).classList.add('active');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

// ==========================================
// üìä DASHBOARD
// ==========================================

function renderDashboard() {
    renderDashboardStats();
    renderRevenueChart();
    renderUpcomingAppointments();
}

function renderDashboardStats() {
    const stats = {
        total: students.length,
        hocThu: students.filter(s => s.status === 'H·ªçc Th·ª≠').length,
        choDangKy: students.filter(s => s.status === 'Ch·ªù ƒêƒÉng K√Ω').length,
        daDangKy: students.filter(s => s.status === 'ƒê√£ ƒêƒÉng K√Ω').length,
        hoanThanh: students.filter(s => s.status === 'Ho√†n Th√†nh').length,
        cancel: students.filter(s => s.status === 'Cancel').length,
        totalRevenue: receipts.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0)
    };
    
    const container = document.getElementById('dashboardStats');
    container.innerHTML = `
        <div class="stat-card">
            <h3>${stats.total}</h3>
            <p>üìã T·ªïng H·ªçc Vi√™n</p>
        </div>
        <div class="stat-card stat-hoc-thu">
            <h3>${stats.hocThu}</h3>
            <p>üÜï H·ªçc Th·ª≠</p>
        </div>
        <div class="stat-card stat-cho-dang-ky">
            <h3>${stats.choDangKy}</h3>
            <p>‚è≥ Ch·ªù ƒêƒÉng K√Ω</p>
        </div>
        <div class="stat-card stat-da-dang-ky">
            <h3>${stats.daDangKy}</h3>
            <p>‚úÖ ƒê√£ ƒêƒÉng K√Ω</p>
        </div>
        <div class="stat-card stat-hoan-thanh">
            <h3>${stats.hoanThanh}</h3>
            <p>üéì Ho√†n Th√†nh</p>
        </div>
        <div class="stat-card stat-revenue">
            <h3>${formatCurrency(stats.totalRevenue)}</h3>
            <p>üí∞ T·ªïng Doanh Thu</p>
        </div>
    `;
}

function renderRevenueChart() {
    const container = document.getElementById('revenueChart');
    
    // L·∫•y 6 th√°ng g·∫ßn nh·∫•t
    const months = [];
    const now = new Date();
    for (let i = 5; i >= 0; i--) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        months.push({
            key: `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`,
            label: `T${d.getMonth() + 1}/${String(d.getFullYear()).slice(2)}`
        });
    }
    
    // T√≠nh doanh thu t·ª´ng th√°ng
    const monthlyRevenue = {};
    months.forEach(m => monthlyRevenue[m.key] = 0);
    
    receipts.forEach(r => {
        const month = r.date.substring(0, 7);
        if (monthlyRevenue[month] !== undefined) {
            monthlyRevenue[month] += parseFloat(r.amount) || 0;
        }
    });
    
    // T√¨m max ƒë·ªÉ scale
    const maxRevenue = Math.max(...Object.values(monthlyRevenue), 1);
    
    // Render bars
    container.innerHTML = months.map(m => {
        const revenue = monthlyRevenue[m.key];
        const heightPercent = (revenue / maxRevenue) * 100;
        return `
            <div class="chart-bar-wrapper">
                <div class="chart-bar" style="height: ${Math.max(heightPercent, 5)}%;">
                    <span class="chart-bar-value">${formatCurrencyShort(revenue)}</span>
                </div>
                <span class="chart-bar-label">${m.label}</span>
            </div>
        `;
    }).join('');
}

function renderUpcomingAppointments() {
    const container = document.getElementById('upcomingAppointments');
    
    const now = new Date();
    const upcoming = appointments
        .filter(a => new Date(a.date + ' ' + a.time) >= now)
        .sort((a, b) => new Date(a.date + ' ' + a.time) - new Date(b.date + ' ' + b.time))
        .slice(0, 5);
    
    if (upcoming.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <p class="text-muted">Ch∆∞a c√≥ l·ªãch h·∫πn s·∫Øp t·ªõi</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = upcoming.map(apt => {
        const student = students.find(s => s.id === apt.studentId);
        return `
            <div class="upcoming-item">
                <strong>üë§ ${student?.name || 'N/A'}</strong> - ${apt.subject}<br>
                <span>üìÖ ${formatDate(apt.date)} l√∫c ${apt.time}</span><br>
                <span class="text-muted">üìû ${student?.parentPhone || 'N/A'}</span>
            </div>
        `;
    }).join('');
}

// ==========================================
// üë©‚Äçüéì STUDENTS MANAGEMENT
// ==========================================

function renderSubjectCheckboxes() {
    const container = document.getElementById('subjectCheckboxes');
    container.innerHTML = subjects.map(sub => `
        <label class="checkbox-item">
            <input type="checkbox" name="studentSubjects" value="${sub.name}">
            ${sub.icon} ${sub.name}
        </label>
    `).join('');
}

function toggleStudentForm() {
    const form = document.getElementById('studentForm');
    const icon = document.getElementById('toggleFormIcon');
    
    if (form.style.display === 'none') {
        form.style.display = 'block';
        icon.textContent = '‚ñº';
    } else {
        form.style.display = 'block';
        icon.textContent = '‚ñº';
    }
}

function saveStudent(event) {
    event.preventDefault();
    
    // L·∫•y m√¥n h·ªçc ƒë√£ ch·ªçn
    const selectedSubjects = Array.from(document.querySelectorAll('input[name="studentSubjects"]:checked'))
        .map(cb => cb.value);
    
    if (selectedSubjects.length === 0) {
        showNotification('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 m√¥n h·ªçc!', 'error');
        return;
    }
    
    const editId = document.getElementById('editStudentId').value;
    const studentData = {
        name: document.getElementById('studentName').value.trim(),
        age: parseInt(document.getElementById('studentAge').value),
        parentName: document.getElementById('parentName').value.trim(),
        parentPhone: document.getElementById('parentPhone').value.trim(),
        parentEmail: document.getElementById('parentEmail').value.trim(),
        status: document.getElementById('studentStatus').value,
        subjects: selectedSubjects,
        notes: document.getElementById('studentNotes').value.trim()
    };
    
    // Ki·ªÉm tra tr√πng SƒêT (n·∫øu th√™m m·ªõi)
    if (!editId) {
        const duplicate = students.find(s => normalizePhone(s.parentPhone) === normalizePhone(studentData.parentPhone));
        if (duplicate) {
            if (!confirm(`‚ö†Ô∏è SƒêT n√†y ƒë√£ t·ªìn t·∫°i!\n\nH·ªçc vi√™n: ${duplicate.name}\nPh·ª• huynh: ${duplicate.parentName}\n\nB·∫°n v·∫´n mu·ªën th√™m?`)) {
                return;
            }
        }
    }
    
    if (editId) {
        // C·∫≠p nh·∫≠t
        const index = students.findIndex(s => s.id === editId);
        if (index !== -1) {
            // Gi·ªØ l·∫°i c√°c field kh√¥ng c√≥ trong form
            const oldStudent = students[index];
            students[index] = {
                ...oldStudent,
                ...studentData,
                updatedAt: new Date().toISOString()
            };
            showNotification('C·∫≠p nh·∫≠t h·ªçc vi√™n th√†nh c√¥ng!');
        }
    } else {
        // Th√™m m·ªõi
        const newStudent = {
            id: generateId(),
            ...studentData,
            previousStatus: null,
            registrations: [],
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        students.push(newStudent);
        showNotification('Th√™m h·ªçc vi√™n th√†nh c√¥ng!');
    }
    
    saveData('students', students);
    resetStudentForm();
    renderStudentsTable();
    updateStudentCounts();
    renderDashboard();
}

function resetStudentForm() {
    document.getElementById('studentForm').reset();
    document.getElementById('editStudentId').value = '';
    document.getElementById('studentStatus').value = 'H·ªçc Th·ª≠';
    document.getElementById('formTitle').textContent = '‚ûï Th√™m H·ªçc Vi√™n M·ªõi';
    document.getElementById('saveStudentBtn').textContent = 'üíæ L∆∞u H·ªçc Vi√™n';
    document.getElementById('cancelEditBtn').classList.add('hidden');
    
    // Uncheck all subjects
    document.querySelectorAll('input[name="studentSubjects"]').forEach(cb => cb.checked = false);
}

function cancelEdit() {
    resetStudentForm();
}

function editStudent(id) {
    const student = students.find(s => s.id === id);
    if (!student) return;
    
    document.getElementById('editStudentId').value = student.id;
    document.getElementById('studentName').value = student.name;
    document.getElementById('studentAge').value = student.age;
    document.getElementById('parentName').value = student.parentName;
    document.getElementById('parentPhone').value = student.parentPhone;
    document.getElementById('parentEmail').value = student.parentEmail || '';
    document.getElementById('studentStatus').value = student.status;
    document.getElementById('studentNotes').value = student.notes || '';
    
    // Check subjects
    document.querySelectorAll('input[name="studentSubjects"]').forEach(cb => {
        cb.checked = student.subjects.includes(cb.value);
    });
    
    document.getElementById('formTitle').textContent = '‚úèÔ∏è S·ª≠a H·ªçc Vi√™n';
    document.getElementById('saveStudentBtn').textContent = 'üíæ C·∫≠p Nh·∫≠t';
    document.getElementById('cancelEditBtn').classList.remove('hidden');
    
    // Scroll to form
    document.getElementById('studentFormSection').scrollIntoView({ behavior: 'smooth' });
}

function deleteStudent(id) {
    const student = students.find(s => s.id === id);
    if (!student) return;
    
    if (!confirm(`‚ö†Ô∏è X√≥a h·ªçc vi√™n "${student.name}"?\n\nT·∫•t c·∫£ l·ªãch h·∫πn v√† bi√™n lai li√™n quan c≈©ng s·∫Ω b·ªã x√≥a!`)) {
        return;
    }
    
    students = students.filter(s => s.id !== id);
    appointments = appointments.filter(a => a.studentId !== id);
    receipts = receipts.filter(r => r.studentId !== id);
    
    saveData('students', students);
    saveData('appointments', appointments);
    saveData('receipts', receipts);
    
    showNotification('ƒê√£ x√≥a h·ªçc vi√™n!');
    renderAll();
}

function updateStudentCounts() {
    document.getElementById('countAll').textContent = students.length;
    document.getElementById('countHocThu').textContent = students.filter(s => s.status === 'H·ªçc Th·ª≠').length;
    document.getElementById('countChoDangKy').textContent = students.filter(s => s.status === 'Ch·ªù ƒêƒÉng K√Ω').length;
    document.getElementById('countDaDangKy').textContent = students.filter(s => s.status === 'ƒê√£ ƒêƒÉng K√Ω').length;
    document.getElementById('countHoanThanh').textContent = students.filter(s => s.status === 'Ho√†n Th√†nh').length;
    document.getElementById('countCancel').textContent = students.filter(s => s.status === 'Cancel').length;
}

function filterStudents(status) {
    currentFilter = status;
    
    // Update active button
    document.querySelectorAll('#students .filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === status);
    });
    
    renderStudentsTable();
}

function searchStudents() {
    renderStudentsTable();
}

function renderStudentsTable() {
    const tbody = document.getElementById('studentsTableBody');
    const searchTerm = document.getElementById('searchStudent').value.toLowerCase();
    
    let filtered = students;
    
    // Filter by status
    if (currentFilter !== 'all') {
        filtered = filtered.filter(s => s.status === currentFilter);
    }
    
    // Filter by search
    if (searchTerm) {
        filtered = filtered.filter(s => 
            s.name.toLowerCase().includes(searchTerm) ||
            s.parentName.toLowerCase().includes(searchTerm) ||
            s.parentPhone.includes(searchTerm) ||
            s.subjects.some(sub => sub.toLowerCase().includes(searchTerm))
        );
    }
    
    if (filtered.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <p>Kh√¥ng c√≥ h·ªçc vi√™n n√†o</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = filtered.map(student => `
        <tr>
            <td><strong>${student.name}</strong></td>
            <td>${student.age}</td>
            <td>${student.parentName}</td>
            <td>${student.parentPhone}</td>
            <td>${student.subjects.map(s => `<span class="subject-tag">${s}</span>`).join('')}</td>
            <td>${getStatusBadge(student.status)}</td>
            <td>
                <div class="action-buttons">
                    ${getActionButtons(student)}
                </div>
            </td>
        </tr>
    `).join('');
}

// ==========================================
// üè∑Ô∏è STATUS & ACTION BUTTONS
// ==========================================

function getStatusBadge(status) {
    const badges = {
        'H·ªçc Th·ª≠': '<span class="status-badge status-hoc-thu">üÜï H·ªçc Th·ª≠</span>',
        'Ch·ªù ƒêƒÉng K√Ω': '<span class="status-badge status-cho-dang-ky">‚è≥ Ch·ªù ƒêƒÉng K√Ω</span>',
        'ƒê√£ ƒêƒÉng K√Ω': '<span class="status-badge status-da-dang-ky">‚úÖ ƒê√£ ƒêƒÉng K√Ω</span>',
        'Ho√†n Th√†nh': '<span class="status-badge status-hoan-thanh">üéì Ho√†n Th√†nh</span>',
        'Cancel': '<span class="status-badge status-cancel">‚ùå Cancel</span>'
    };
    return badges[status] || status;
}

function getActionButtons(student) {
    const id = student.id;
    let buttons = [];
    
    // N√∫t Xem (t·∫•t c·∫£ tr·∫°ng th√°i)
    buttons.push(`<button class="action-btn action-btn-view" onclick="viewStudent('${id}')" title="Xem">üëÅÔ∏è</button>`);
    
    switch(student.status) {
        case 'H·ªçc Th·ª≠':
            buttons.push(`<button class="action-btn action-btn-schedule" onclick="openAppointmentModal('${id}')" title="ƒê·∫∑t l·ªãch">üìÖ</button>`);
            buttons.push(`<button class="action-btn action-btn-edit" onclick="editStudent('${id}')" title="S·ª≠a">‚úèÔ∏è</button>`);
            buttons.push(`<button class="action-btn action-btn-delete" onclick="deleteStudent('${id}')" title="X√≥a">üóëÔ∏è</button>`);
            break;
            
        case 'Ch·ªù ƒêƒÉng K√Ω':
            buttons.push(`<button class="action-btn action-btn-register" onclick="openRegistrationModal('${id}')" title="Chuy·ªÉn ƒêK">‚úÖ</button>`);
            buttons.push(`<button class="action-btn action-btn-cancel" onclick="cancelStudent('${id}')" title="Cancel">‚ùå</button>`);
            buttons.push(`<button class="action-btn action-btn-edit" onclick="editStudent('${id}')" title="S·ª≠a">‚úèÔ∏è</button>`);
            break;
            
        case 'ƒê√£ ƒêƒÉng K√Ω':
            buttons.push(`<button class="action-btn action-btn-receipt" onclick="openReceiptModalForStudent('${id}')" title="T·∫°o Bi√™n Lai">üßæ</button>`);
            buttons.push(`<button class="action-btn action-btn-edit" onclick="editStudent('${id}')" title="S·ª≠a">‚úèÔ∏è</button>`);
            break;
            
        case 'Ho√†n Th√†nh':
            buttons.push(`<button class="action-btn action-btn-receipt" onclick="viewStudentReceipts('${id}')" title="Xem BL">üßæ</button>`);
            break;
            
        case 'Cancel':
            buttons.push(`<button class="action-btn action-btn-edit" onclick="editStudent('${id}')" title="S·ª≠a">‚úèÔ∏è</button>`);
            buttons.push(`<button class="action-btn action-btn-restore" onclick="restoreStudent('${id}')" title="Kh√¥i ph·ª•c">üîÑ</button>`);
            break;
    }
    
    return buttons.join('');
}

// ==========================================
// üëÅÔ∏è QUICK VIEW
// ==========================================

function viewStudent(id) {
    const student = students.find(s => s.id === id);
    if (!student) return;
    
    const studentAppointments = appointments.filter(a => a.studentId === id);
    const studentReceipts = receipts.filter(r => r.studentId === id);
    
    const content = document.getElementById('quickViewContent');
    content.innerHTML = `
        <div class="quick-view-section">
            <h4>üë§ Th√¥ng Tin H·ªçc Vi√™n</h4>
            <div class="quick-view-row">
                <span class="quick-view-label">T√™n:</span>
                <span class="quick-view-value"><strong>${student.name}</strong></span>
            </div>
            <div class="quick-view-row">
                <span class="quick-view-label">Tu·ªïi:</span>
                <span class="quick-view-value">${student.age}</span>
            </div>
            <div class="quick-view-row">
                <span class="quick-view-label">Ph·ª• huynh:</span>
                <span class="quick-view-value">${student.parentName}</span>
            </div>
            <div class="quick-view-row">
                <span class="quick-view-label">SƒêT:</span>
                <span class="quick-view-value">${student.parentPhone}</span>
            </div>
            <div class="quick-view-row">
                <span class="quick-view-label">Email:</span>
                <span class="quick-view-value">${student.parentEmail || 'Ch∆∞a c√≥'}</span>
            </div>
            <div class="quick-view-row">
                <span class="quick-view-label">M√¥n h·ªçc:</span>
                <span class="quick-view-value">${student.subjects.map(s => `<span class="subject-tag">${s}</span>`).join('')}</span>
            </div>
            <div class="quick-view-row">
                <span class="quick-view-label">Tr·∫°ng th√°i:</span>
                <span class="quick-view-value">${getStatusBadge(student.status)}</span>
            </div>
            <div class="quick-view-row">
                <span class="quick-view-label">Ghi ch√∫:</span>
                <span class="quick-view-value">${student.notes || 'Kh√¥ng c√≥'}</span>
            </div>
        </div>
        
        <div class="quick-view-section">
            <h4>üìÖ L·ªãch H·∫πn (${studentAppointments.length})</h4>
            ${studentAppointments.length === 0 ? '<p class="text-muted">Ch∆∞a c√≥ l·ªãch h·∫πn</p>' :
                studentAppointments.map(apt => `
                    <div class="quick-view-row">
                        <span class="quick-view-label">${formatDate(apt.date)} ${apt.time}</span>
                        <span class="quick-view-value">${apt.subject}</span>
                    </div>
                `).join('')
            }
        </div>
        
        <div class="quick-view-section">
            <h4>üìÑ Phi·∫øu ƒêƒÉng K√Ω (${student.registrations?.length || 0})</h4>
            ${!student.registrations || student.registrations.length === 0 ? '<p class="text-muted">Ch∆∞a c√≥ phi·∫øu ƒëƒÉng k√Ω</p>' :
                student.registrations.map(reg => `
                    <div class="quick-view-row">
                        <span class="quick-view-label">${reg.subject}</span>
                        <span class="quick-view-value">${formatCurrency(reg.finalAmount)} - ${formatDate(reg.registrationDate)}</span>
                    </div>
                `).join('')
            }
        </div>
        
        <div class="quick-view-section">
            <h4>üßæ Bi√™n Lai (${studentReceipts.length})</h4>
            ${studentReceipts.length === 0 ? '<p class="text-muted">Ch∆∞a c√≥ bi√™n lai</p>' :
                studentReceipts.map(r => `
                    <div class="quick-view-row">
                        <span class="quick-view-label">${formatDate(r.date)}</span>
                        <span class="quick-view-value">${formatCurrency(r.amount)} - ${r.description}</span>
                    </div>
                `).join('')
            }
        </div>
    `;
    
    openModal('quickViewModal');
}

// ==========================================
// üîÑ STATUS CHANGES
// ==========================================

function cancelStudent(id) {
    const student = students.find(s => s.id === id);
    if (!student) return;
    
    if (!confirm(`‚ùå Cancel h·ªçc vi√™n "${student.name}"?\n\nTr·∫°ng th√°i hi·ªán t·∫°i: ${student.status}`)) {
        return;
    }
    
    // L∆∞u tr·∫°ng th√°i tr∆∞·ªõc khi cancel
    student.previousStatus = student.status;
    student.status = 'Cancel';
    student.updatedAt = new Date().toISOString();
    
    saveData('students', students);
    showNotification('ƒê√£ cancel h·ªçc vi√™n!', 'warning');
    renderAll();
}

function restoreStudent(id) {
    const student = students.find(s => s.id === id);
    if (!student) return;
    
    if (!student.previousStatus) {
        showNotification('Kh√¥ng c√≥ tr·∫°ng th√°i tr∆∞·ªõc ƒë√≥ ƒë·ªÉ kh√¥i ph·ª•c!', 'error');
        return;
    }
    
    if (!confirm(`üîÑ Kh√¥i ph·ª•c h·ªçc vi√™n "${student.name}"?\n\nS·∫Ω tr·ªü v·ªÅ tr·∫°ng th√°i: ${student.previousStatus}`)) {
        return;
    }
    
    student.status = student.previousStatus;
    student.previousStatus = null;
    student.updatedAt = new Date().toISOString();
    
    saveData('students', students);
    showNotification('ƒê√£ kh√¥i ph·ª•c h·ªçc vi√™n!');
    renderAll();
}

function confirmTrialCompleted(id) {
    const student = students.find(s => s.id === id);
    if (!student) return;
    
    if (student.status !== 'H·ªçc Th·ª≠') {
        showNotification('H·ªçc vi√™n kh√¥ng ·ªü tr·∫°ng th√°i H·ªçc Th·ª≠!', 'error');
        return;
    }
    
    if (!confirm(`‚úÖ X√°c nh·∫≠n h·ªçc vi√™n "${student.name}" ƒë√£ h·ªçc th·ª≠ xong?\n\nTr·∫°ng th√°i s·∫Ω chuy·ªÉn sang "Ch·ªù ƒêƒÉng K√Ω".`)) {
        return;
    }
    
    student.status = 'Ch·ªù ƒêƒÉng K√Ω';
    student.updatedAt = new Date().toISOString();
    
    saveData('students', students);
    showNotification('ƒê√£ x√°c nh·∫≠n h·ªçc th·ª≠! H·ªçc vi√™n chuy·ªÉn sang Ch·ªù ƒêƒÉng K√Ω.');
    renderAll();
}

// ==========================================
// üéì TRIAL STUDENTS TAB (Tab 3)
// ==========================================

function updateTrialCounts() {
    const trialStudents = students.filter(s => s.status === 'H·ªçc Th·ª≠' || s.status === 'Ch·ªù ƒêƒÉng K√Ω');
    document.getElementById('trialCountAll').textContent = trialStudents.length;
    document.getElementById('trialCountHocThu').textContent = students.filter(s => s.status === 'H·ªçc Th·ª≠').length;
    document.getElementById('trialCountChoDangKy').textContent = students.filter(s => s.status === 'Ch·ªù ƒêƒÉng K√Ω').length;
}

function filterTrialStudents(status) {
    currentTrialFilter = status;
    
    // Update active button
    document.querySelectorAll('#trial .filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === status);
    });
    
    renderTrialStudentsTable();
}

function searchTrialStudents() {
    renderTrialStudentsTable();
}

function renderTrialStudentsTable() {
    const tbody = document.getElementById('trialStudentsTableBody');
    const searchTerm = document.getElementById('searchTrialStudent')?.value?.toLowerCase() || '';
    
    // Ch·ªâ hi·ªán H·ªçc Th·ª≠ v√† Ch·ªù ƒêƒÉng K√Ω
    let filtered = students.filter(s => s.status === 'H·ªçc Th·ª≠' || s.status === 'Ch·ªù ƒêƒÉng K√Ω');
    
    // Filter by status
    if (currentTrialFilter !== 'all') {
        filtered = filtered.filter(s => s.status === currentTrialFilter);
    }
    
    // Filter by search
    if (searchTerm) {
        filtered = filtered.filter(s => 
            s.name.toLowerCase().includes(searchTerm) ||
            s.parentName.toLowerCase().includes(searchTerm) ||
            s.parentPhone.includes(searchTerm)
        );
    }
    
    if (filtered.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8">
                    <div class="empty-state">
                        <div class="empty-state-icon">üéì</div>
                        <p>Kh√¥ng c√≥ h·ªçc vi√™n n√†o</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = filtered.map(student => {
        // T√¨m l·ªãch h·∫πn c·ªßa h·ªçc vi√™n
        const studentAppointments = appointments.filter(a => a.studentId === student.id);
        const upcomingApt = studentAppointments.find(a => new Date(a.date + ' ' + a.time) >= new Date());
        
        return `
            <tr>
                <td><strong>${student.name}</strong></td>
                <td>${student.age}</td>
                <td>${student.parentName}</td>
                <td>${student.parentPhone}</td>
                <td>${student.subjects.map(s => `<span class="subject-tag">${s}</span>`).join('')}</td>
                <td>${getStatusBadge(student.status)}</td>
                <td>
                    ${upcomingApt ? 
                        `<span class="text-success">üìÖ ${formatDate(upcomingApt.date)} ${upcomingApt.time}</span>` : 
                        '<span class="text-muted">Ch∆∞a c√≥</span>'
                    }
                </td>
                <td>
                    <div class="action-buttons">
                        ${getTrialActionButtons(student)}
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function getTrialActionButtons(student) {
    const id = student.id;
    let buttons = [];
    
    buttons.push(`<button class="action-btn action-btn-view" onclick="viewStudent('${id}')" title="Xem">üëÅÔ∏è</button>`);
    
    if (student.status === 'H·ªçc Th·ª≠') {
        buttons.push(`<button class="action-btn action-btn-schedule" onclick="openAppointmentModal('${id}')" title="ƒê·∫∑t l·ªãch">üìÖ</button>`);
        buttons.push(`<button class="action-btn action-btn-confirm" onclick="confirmTrialCompleted('${id}')" title="X√°c nh·∫≠n ƒë√£ h·ªçc th·ª≠">‚úÖ ƒê√£ HT</button>`);
    } else if (student.status === 'Ch·ªù ƒêƒÉng K√Ω') {
        buttons.push(`<button class="action-btn action-btn-register" onclick="openRegistrationModal('${id}')" title="Chuy·ªÉn ƒêK">‚úÖ ƒêK</button>`);
        buttons.push(`<button class="action-btn action-btn-cancel" onclick="cancelStudent('${id}')" title="Cancel">‚ùå</button>`);
    }
    
    return buttons.join('');
}

// ==========================================
// üìÖ APPOINTMENTS MANAGEMENT
// ==========================================

function openAppointmentModal(studentId) {
    const student = students.find(s => s.id === studentId);
    if (!student) return;
    
    document.getElementById('appointmentStudentId').value = studentId;
    document.getElementById('editAppointmentId').value = '';
    document.getElementById('appointmentStudentName').value = student.name;
    
    // Populate subjects dropdown
    const subjectSelect = document.getElementById('appointmentSubject');
    subjectSelect.innerHTML = '<option value="">-- Ch·ªçn m√¥n h·ªçc --</option>' +
        student.subjects.map(s => `<option value="${s}">${s}</option>`).join('');
    
    // Reset form
    document.getElementById('appointmentDate').value = '';
    document.getElementById('appointmentTime').value = '';
    document.getElementById('appointmentNotes').value = '';
    document.getElementById('appointmentConflictWarning').classList.add('hidden');
    
    // Set min date
    document.getElementById('appointmentDate').min = new Date().toISOString().split('T')[0];
    
    openModal('appointmentModal');
}

function saveAppointment(event) {
    event.preventDefault();
    
    const studentId = document.getElementById('appointmentStudentId').value;
    const editId = document.getElementById('editAppointmentId').value;
    
    const appointmentData = {
        studentId: studentId,
        subject: document.getElementById('appointmentSubject').value,
        date: document.getElementById('appointmentDate').value,
        time: document.getElementById('appointmentTime').value,
        notes: document.getElementById('appointmentNotes').value.trim()
    };
    
    // Ki·ªÉm tra xung ƒë·ªôt
    const conflicts = checkAppointmentConflicts(appointmentData.date, appointmentData.time, editId);
    if (conflicts.length > 0) {
        const conflictList = conflicts.map(c => {
            const s = students.find(st => st.id === c.studentId);
            return `- ${s?.name || 'N/A'}: ${c.subject} l√∫c ${c.time}`;
        }).join('\n');
        
        if (!confirm(`‚ö†Ô∏è Ph√°t hi·ªán ${conflicts.length} l·ªãch h·∫πn tr√πng gi·ªù:\n\n${conflictList}\n\nB·∫°n v·∫´n mu·ªën ti·∫øp t·ª•c?`)) {
            return;
        }
    }
    
    if (editId) {
        // C·∫≠p nh·∫≠t
        const index = appointments.findIndex(a => a.id === editId);
        if (index !== -1) {
            appointments[index] = {
                ...appointments[index],
                ...appointmentData,
                updatedAt: new Date().toISOString()
            };
            showNotification('C·∫≠p nh·∫≠t l·ªãch h·∫πn th√†nh c√¥ng!');
        }
    } else {
        // Th√™m m·ªõi
        appointments.push({
            id: generateId(),
            ...appointmentData,
            createdAt: new Date().toISOString()
        });
        showNotification('ƒê·∫∑t l·ªãch h·∫πn th√†nh c√¥ng!');
    }
    
    saveData('appointments', appointments);
    closeModal('appointmentModal');
    renderAll();
}

function checkAppointmentConflicts(date, time, excludeId = null) {
    const SLOT_DURATION = 60; // ph√∫t
    const targetTime = new Date(`${date} ${time}`).getTime();
    const targetEnd = targetTime + SLOT_DURATION * 60 * 1000;
    
    return appointments.filter(apt => {
        if (excludeId && apt.id === excludeId) return false;
        if (apt.date !== date) return false;
        
        const aptTime = new Date(`${apt.date} ${apt.time}`).getTime();
        const aptEnd = aptTime + SLOT_DURATION * 60 * 1000;
        
        return (targetTime < aptEnd && targetEnd > aptTime);
    });
}

function filterAppointments(filter) {
    currentAppointmentFilter = filter;
    
    document.querySelectorAll('#appointments .filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    renderAppointmentsTable();
}

function searchAppointments() {
    renderAppointmentsTable();
}

function renderAppointmentsTable() {
    const tbody = document.getElementById('appointmentsTableBody');
    const searchTerm = document.getElementById('searchAppointment')?.value?.toLowerCase() || '';
    const now = new Date();
    
    let filtered = [...appointments];
    
    // Filter by time
    if (currentAppointmentFilter === 'upcoming') {
        filtered = filtered.filter(a => new Date(a.date + ' ' + a.time) >= now);
    } else if (currentAppointmentFilter === 'past') {
        filtered = filtered.filter(a => new Date(a.date + ' ' + a.time) < now);
    }
    
    // Filter by search
    if (searchTerm) {
        filtered = filtered.filter(a => {
            const student = students.find(s => s.id === a.studentId);
            return a.subject.toLowerCase().includes(searchTerm) ||
                a.date.includes(searchTerm) ||
                student?.name.toLowerCase().includes(searchTerm) ||
                student?.parentPhone.includes(searchTerm);
        });
    }
    
    // Sort by date
    filtered.sort((a, b) => new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time));
    
    if (filtered.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <p>Kh√¥ng c√≥ l·ªãch h·∫πn n√†o</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = filtered.map(apt => {
        const student = students.find(s => s.id === apt.studentId);
        const isPast = new Date(apt.date + ' ' + apt.time) < now;
        
        return `
            <tr style="${isPast ? 'opacity: 0.6;' : ''}">
                <td><strong>${student?.name || 'N/A'}</strong></td>
                <td>${student?.parentName || 'N/A'}</td>
                <td>${student?.parentPhone || 'N/A'}</td>
                <td><span class="subject-tag">${apt.subject}</span></td>
                <td>${formatDate(apt.date)}</td>
                <td><strong>${apt.time}</strong></td>
                <td>${isPast ? '<span class="text-muted">‚úÖ ƒê√£ qua</span>' : '<span class="text-success">‚è∞ S·∫Øp t·ªõi</span>'}</td>
                <td>
                    <div class="action-buttons">
                        ${!isPast && student?.status === 'H·ªçc Th·ª≠' ? 
                            `<button class="action-btn action-btn-confirm" onclick="confirmTrialFromAppointment('${apt.id}')" title="X√°c nh·∫≠n ƒë√£ HT">‚úÖ</button>` : ''
                        }
                        <button class="action-btn action-btn-edit" onclick="editAppointment('${apt.id}')" title="S·ª≠a">‚úèÔ∏è</button>
                        <button class="action-btn action-btn-delete" onclick="deleteAppointment('${apt.id}')" title="X√≥a">üóëÔ∏è</button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function confirmTrialFromAppointment(aptId) {
    const apt = appointments.find(a => a.id === aptId);
    if (!apt) return;
    
    confirmTrialCompleted(apt.studentId);
}

function editAppointment(id) {
    const apt = appointments.find(a => a.id === id);
    if (!apt) return;
    
    const student = students.find(s => s.id === apt.studentId);
    if (!student) return;
    
    document.getElementById('appointmentStudentId').value = apt.studentId;
    document.getElementById('editAppointmentId').value = apt.id;
    document.getElementById('appointmentStudentName').value = student.name;
    
    // Populate subjects
    const subjectSelect = document.getElementById('appointmentSubject');
    subjectSelect.innerHTML = '<option value="">-- Ch·ªçn m√¥n h·ªçc --</option>' +
        student.subjects.map(s => `<option value="${s}" ${s === apt.subject ? 'selected' : ''}>${s}</option>`).join('');
    
    document.getElementById('appointmentDate').value = apt.date;
    document.getElementById('appointmentTime').value = apt.time;
    document.getElementById('appointmentNotes').value = apt.notes || '';
    
    openModal('appointmentModal');
}

function deleteAppointment(id) {
    if (!confirm('X√≥a l·ªãch h·∫πn n√†y?')) return;
    
    appointments = appointments.filter(a => a.id !== id);
    saveData('appointments', appointments);
    
    showNotification('ƒê√£ x√≥a l·ªãch h·∫πn!');
    renderAll();
}

// ==========================================
// ‚úÖ REGISTRATION (Phi·∫øu ƒêƒÉng K√Ω)
// ==========================================

function openRegistrationModal(studentId) {
    const student = students.find(s => s.id === studentId);
    if (!student) return;
    
    if (student.status !== 'Ch·ªù ƒêƒÉng K√Ω') {
        showNotification('Ch·ªâ c√≥ th·ªÉ ƒëƒÉng k√Ω cho h·ªçc vi√™n ·ªü tr·∫°ng th√°i "Ch·ªù ƒêƒÉng K√Ω"!', 'error');
        return;
    }
    
    document.getElementById('regStudentId').value = studentId;
    document.getElementById('regStudentName').value = student.name;
    
    // Populate subjects
    const subjectSelect = document.getElementById('regSubject');
    subjectSelect.innerHTML = '<option value="">-- Ch·ªçn m√¥n h·ªçc --</option>' +
        student.subjects.map(s => `<option value="${s}">${s}</option>`).join('');
    
    // Reset form
    document.getElementById('regPackage').innerHTML = '<option value="">-- Nh·∫≠p th·ªß c√¥ng --</option>';
    document.getElementById('regTuitionFee').value = '';
    document.getElementById('regDiscountAmount').value = '';
    document.getElementById('regFinalAmount').value = '';
    
    // Render promotions
    renderPromotionCheckboxes();
    
    openModal('registrationModal');
}

function loadPackagesForSubject() {
    const subject = document.getElementById('regSubject').value;
    const packageSelect = document.getElementById('regPackage');
    
    const subjectPackages = packages.filter(p => p.subjectName === subject);
    
    packageSelect.innerHTML = '<option value="">-- Nh·∫≠p th·ªß c√¥ng --</option>' +
        subjectPackages.map(p => `<option value="${p.id}">${p.name} - ${p.sessions} bu·ªïi - ${formatCurrency(p.fee)}</option>`).join('');
    
    // Auto fill default fee
    const subjectInfo = subjects.find(s => s.name === subject);
    if (subjectInfo) {
        document.getElementById('regTuitionFee').value = formatNumberInput(subjectInfo.defaultFee);
        calculateFinalAmount();
    }
}

function applyPackageFee() {
    const packageId = document.getElementById('regPackage').value;
    if (!packageId) return;
    
    const pkg = packages.find(p => p.id === packageId);
    if (pkg) {
        document.getElementById('regTuitionFee').value = formatNumberInput(pkg.fee);
        calculateFinalAmount();
    }
}

function renderPromotionCheckboxes() {
    const container = document.getElementById('regPromotionList');
    const now = new Date();
    
    const activePromotions = promotions.filter(p => new Date(p.endDate) >= now);
    
    if (activePromotions.length === 0) {
        container.innerHTML = '<p class="text-muted">Kh√¥ng c√≥ khuy·∫øn m√£i ƒëang ho·∫°t ƒë·ªông</p>';
        return;
    }
    
    container.innerHTML = activePromotions.map(promo => `
        <label class="checkbox-item">
            <input type="checkbox" name="regPromotions" value="${promo.id}" onchange="calculateFinalAmount()">
            ${promo.name} (${promo.type === 'percent' ? promo.value + '%' : formatCurrency(promo.value)})
        </label>
    `).join('');
}

function calculateFinalAmount() {
    const tuitionFee = parseCurrencyInput(document.getElementById('regTuitionFee').value);
    
    // T√≠nh t·ªïng gi·∫£m gi√°
    const selectedPromotions = Array.from(document.querySelectorAll('input[name="regPromotions"]:checked'))
        .map(cb => promotions.find(p => p.id === cb.value))
        .filter(p => p);
    
    let totalDiscount = 0;
    selectedPromotions.forEach(promo => {
        if (promo.type === 'percent') {
            totalDiscount += tuitionFee * promo.value / 100;
        } else {
            totalDiscount += promo.value;
        }
    });
    
    const finalAmount = Math.max(tuitionFee - totalDiscount, 0);
    
    document.getElementById('regDiscountAmount').value = totalDiscount > 0 ? '-' + formatCurrency(totalDiscount) : '';
    document.getElementById('regFinalAmount').value = formatCurrency(finalAmount);
}

function saveRegistration(event) {
    event.preventDefault();
    
    const studentId = document.getElementById('regStudentId').value;
    const student = students.find(s => s.id === studentId);
    if (!student) return;
    
    const tuitionFee = parseCurrencyInput(document.getElementById('regTuitionFee').value);
    const selectedPromotionIds = Array.from(document.querySelectorAll('input[name="regPromotions"]:checked'))
        .map(cb => cb.value);
    
    // T√≠nh gi·∫£m gi√°
    let totalDiscount = 0;
    selectedPromotionIds.forEach(promoId => {
        const promo = promotions.find(p => p.id === promoId);
        if (promo) {
            if (promo.type === 'percent') {
                totalDiscount += tuitionFee * promo.value / 100;
            } else {
                totalDiscount += promo.value;
            }
        }
    });
    
    const finalAmount = Math.max(tuitionFee - totalDiscount, 0);
    
    // T·∫°o phi·∫øu ƒëƒÉng k√Ω
    const registration = {
        id: generateId(),
        subject: document.getElementById('regSubject').value,
        packageId: document.getElementById('regPackage').value || null,
        tuitionFee: tuitionFee,
        promotionIds: selectedPromotionIds,
        discountAmount: totalDiscount,
        finalAmount: finalAmount,
        registrationDate: new Date().toISOString().split('T')[0],
        status: 'ƒê√£ ƒëƒÉng k√Ω',
        qrCode: `REG-${studentId}-${Date.now()}`,
        createdAt: new Date().toISOString()
    };
    
    // Th√™m v√†o danh s√°ch registrations c·ªßa student
    if (!student.registrations) student.registrations = [];
    student.registrations.push(registration);
    
    // Chuy·ªÉn tr·∫°ng th√°i
    student.status = 'ƒê√£ ƒêƒÉng K√Ω';
    student.updatedAt = new Date().toISOString();
    
    saveData('students', students);
    
    closeModal('registrationModal');
    showNotification('ƒêƒÉng k√Ω th√†nh c√¥ng! H·ªçc vi√™n ƒë√£ chuy·ªÉn sang tr·∫°ng th√°i "ƒê√£ ƒêƒÉng K√Ω".');
    renderAll();
}

// ==========================================
// üßæ RECEIPTS MANAGEMENT
// ==========================================

function openReceiptModal() {
    document.getElementById('editReceiptId').value = '';
    document.getElementById('receiptForm').reset();
    document.getElementById('receiptDate').value = new Date().toISOString().split('T')[0];
    
    // Populate students dropdown (ch·ªâ ƒê√£ ƒêƒÉng K√Ω)
    populateReceiptStudentDropdown();
    
    openModal('receiptModal');
}

function openReceiptModalForStudent(studentId) {
    openReceiptModal();
    document.getElementById('receiptStudentId').value = studentId;
    fillReceiptStudentInfo();
}

function populateReceiptStudentDropdown() {
    const select = document.getElementById('receiptStudentId');
    const registeredStudents = students.filter(s => s.status === 'ƒê√£ ƒêƒÉng K√Ω');
    
    select.innerHTML = '<option value="">-- Ch·ªçn h·ªçc vi√™n --</option>' +
        registeredStudents.map(s => `<option value="${s.id}">${s.name} - ${s.parentName}</option>`).join('');
}

function fillReceiptStudentInfo() {
    const studentId = document.getElementById('receiptStudentId').value;
    const student = students.find(s => s.id === studentId);
    
    if (student) {
        document.getElementById('receiptParentName').value = student.parentName;
        document.getElementById('receiptParentPhone').value = student.parentPhone;
    } else {
        document.getElementById('receiptParentName').value = '';
        document.getElementById('receiptParentPhone').value = '';
    }
}

function saveReceipt(event) {
    event.preventDefault();
    
    const editId = document.getElementById('editReceiptId').value;
    const studentId = document.getElementById('receiptStudentId').value;
    const student = students.find(s => s.id === studentId);
    
    const receiptData = {
        studentId: studentId,
        type: document.getElementById('receiptType').value,
        parentName: student?.parentName || '',
        parentPhone: student?.parentPhone || '',
        description: document.getElementById('receiptDescription').value.trim(),
        amount: parseCurrencyInput(document.getElementById('receiptAmount').value),
        date: document.getElementById('receiptDate').value,
        notes: document.getElementById('receiptNotes').value.trim()
    };
    
    if (editId) {
        const index = receipts.findIndex(r => r.id === editId);
        if (index !== -1) {
            receipts[index] = {
                ...receipts[index],
                ...receiptData,
                updatedAt: new Date().toISOString()
            };
            showNotification('C·∫≠p nh·∫≠t bi√™n lai th√†nh c√¥ng!');
        }
    } else {
        receipts.push({
            id: generateId(),
            ...receiptData,
            createdAt: new Date().toISOString()
        });
        showNotification('T·∫°o bi√™n lai th√†nh c√¥ng!');
        
        // H·ªèi c√≥ mu·ªën ƒë·ªïi tr·∫°ng th√°i kh√¥ng
        if (student && student.status === 'ƒê√£ ƒêƒÉng K√Ω') {
            if (confirm('ƒê√£ t·∫°o bi√™n lai. B·∫°n c√≥ mu·ªën chuy·ªÉn tr·∫°ng th√°i h·ªçc vi√™n sang "Ho√†n Th√†nh"?')) {
                student.status = 'Ho√†n Th√†nh';
                student.updatedAt = new Date().toISOString();
                saveData('students', students);
            }
        }
    }
    
    saveData('receipts', receipts);
    closeModal('receiptModal');
    renderAll();
}

function searchReceipts() {
    renderReceiptsTable();
}

function renderReceiptsTable() {
    const tbody = document.getElementById('receiptsTableBody');
    const searchTerm = document.getElementById('searchReceipt')?.value?.toLowerCase() || '';
    
    let filtered = [...receipts];
    
    if (searchTerm) {
        filtered = filtered.filter(r => {
            const student = students.find(s => s.id === r.studentId);
            return r.description.toLowerCase().includes(searchTerm) ||
                r.type.toLowerCase().includes(searchTerm) ||
                student?.name.toLowerCase().includes(searchTerm) ||
                r.parentName.toLowerCase().includes(searchTerm);
        });
    }
    
    // Sort by date
    filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    if (filtered.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7">
                    <div class="empty-state">
                        <div class="empty-state-icon">üßæ</div>
                        <p>Kh√¥ng c√≥ bi√™n lai n√†o</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = filtered.map((receipt, index) => {
        const student = students.find(s => s.id === receipt.studentId);
        const receiptNumber = String(filtered.length - index).padStart(4, '0');
        
        return `
            <tr>
                <td><strong>#${receiptNumber}</strong></td>
                <td><span class="subject-tag">${receipt.type}</span></td>
                <td>${student?.name || 'N/A'}</td>
                <td>${receipt.description}</td>
                <td><strong class="text-success">${formatCurrency(receipt.amount)}</strong></td>
                <td>${formatDate(receipt.date)}</td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn action-btn-view" onclick="viewReceipt('${receipt.id}')" title="Xem">üëÅÔ∏è</button>
                        <button class="action-btn action-btn-edit" onclick="editReceipt('${receipt.id}')" title="S·ª≠a">‚úèÔ∏è</button>
                        <button class="action-btn action-btn-delete" onclick="deleteReceipt('${receipt.id}')" title="X√≥a">üóëÔ∏è</button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function viewReceipt(id) {
    const receipt = receipts.find(r => r.id === id);
    if (!receipt) return;
    
    const student = students.find(s => s.id === receipt.studentId);
    const receiptIndex = receipts.filter(r => new Date(r.date) <= new Date(receipt.date)).length;
    const receiptNumber = String(receiptIndex).padStart(4, '0');
    
    const content = document.getElementById('receiptPreviewContent');
    content.innerHTML = `
        <div class="receipt-preview" id="receiptPrintArea">
            <div class="receipt-header">
                <div class="receipt-logo">
                    ${centerInfo.logo ? `<img src="${centerInfo.logo}" alt="Logo">` : '<div style="width: 80px; height: 80px; background: #e9ecef; border-radius: 8px; display: flex; align-items: center; justify-content: center;">Logo</div>'}
                </div>
                <div style="text-align: right;">
                    <strong style="color: #667eea;">${centerInfo.name || 'TRUNG T√ÇM'}</strong><br>
                    <small>${centerInfo.address || ''}</small><br>
                    <small>üìû ${centerInfo.phone || ''}</small>
                </div>
            </div>
            
            <div class="receipt-title">
                <h2>${receipt.type.toUpperCase()}</h2>
                <p class="text-muted">S·ªë: #${receiptNumber}</p>
            </div>
            
            <div style="margin: 20px 0;">
                <div class="quick-view-row">
                    <span class="quick-view-label">H·ªçc vi√™n:</span>
                    <span class="quick-view-value"><strong>${student?.name || 'N/A'}</strong></span>
                </div>
                <div class="quick-view-row">
                    <span class="quick-view-label">Ph·ª• huynh:</span>
                    <span class="quick-view-value">${receipt.parentName}</span>
                </div>
                <div class="quick-view-row">
                    <span class="quick-view-label">S·ªë ƒëi·ªán tho·∫°i:</span>
                    <span class="quick-view-value">${receipt.parentPhone}</span>
                </div>
                <div class="quick-view-row">
                    <span class="quick-view-label">N·ªôi dung:</span>
                    <span class="quick-view-value">${receipt.description}</span>
                </div>
                <div class="quick-view-row">
                    <span class="quick-view-label">Ng√†y:</span>
                    <span class="quick-view-value">${formatDate(receipt.date)}</span>
                </div>
            </div>
            
            <div class="receipt-amount">
                <p class="text-muted">S·ªë ti·ªÅn</p>
                <div class="receipt-amount-value">${formatCurrency(receipt.amount)}</div>
                <p class="text-muted" style="font-style: italic;">(${numberToWords(receipt.amount)})</p>
            </div>
            
            ${receipt.type === 'Bi√™n Lai ƒêi·ªán T·ª≠' && bankInfo.accountNumber ? `
                <div style="text-align: center; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h4>Th√¥ng tin chuy·ªÉn kho·∫£n</h4>
                    <p><strong>Ng√¢n h√†ng:</strong> ${bankInfo.bankName}</p>
                    <p><strong>S·ªë TK:</strong> ${bankInfo.accountNumber}</p>
                    <p><strong>Ch·ªß TK:</strong> ${bankInfo.accountName}</p>
                    <div id="receiptQRCode" style="margin-top: 10px;"></div>
                </div>
            ` : ''}
            
            <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e9ecef;">
                <p>C·∫£m ∆°n qu√Ω ph·ª• huynh ƒë√£ tin t∆∞·ªüng!</p>
                <p class="text-muted" style="font-size: 0.85em;">In l√∫c: ${new Date().toLocaleString('vi-VN')}</p>
            </div>
        </div>
    `;
    
    // Generate QR code n·∫øu l√† bi√™n lai ƒëi·ªán t·ª≠
    if (receipt.type === 'Bi√™n Lai ƒêi·ªán T·ª≠' && bankInfo.accountNumber) {
        setTimeout(() => {
            const qrContainer = document.getElementById('receiptQRCode');
            if (qrContainer) {
                new QRCode(qrContainer, {
                    text: `${bankInfo.bankName}|${bankInfo.accountNumber}|${bankInfo.accountName}|${receipt.amount}`,
                    width: 150,
                    height: 150
                });
            }
        }, 100);
    }
    
    openModal('viewReceiptModal');
}

function editReceipt(id) {
    const receipt = receipts.find(r => r.id === id);
    if (!receipt) return;
    
    populateReceiptStudentDropdown();
    
    document.getElementById('editReceiptId').value = receipt.id;
    document.getElementById('receiptType').value = receipt.type;
    document.getElementById('receiptStudentId').value = receipt.studentId;
    fillReceiptStudentInfo();
    document.getElementById('receiptDescription').value = receipt.description;
    document.getElementById('receiptAmount').value = formatNumberInput(receipt.amount);
    document.getElementById('receiptDate').value = receipt.date;
    document.getElementById('receiptNotes').value = receipt.notes || '';
    
    openModal('receiptModal');
}

function deleteReceipt(id) {
    if (!confirm('X√≥a bi√™n lai n√†y?')) return;
    
    receipts = receipts.filter(r => r.id !== id);
    saveData('receipts', receipts);
    
    showNotification('ƒê√£ x√≥a bi√™n lai!');
    renderReceiptsTable();
}

function viewStudentReceipts(studentId) {
    const student = students.find(s => s.id === studentId);
    if (!student) return;
    
    const studentReceipts = receipts.filter(r => r.studentId === studentId);
    
    if (studentReceipts.length === 0) {
        showNotification('H·ªçc vi√™n ch∆∞a c√≥ bi√™n lai n√†o!', 'info');
        return;
    }
    
    // Hi·ªÉn th·ªã danh s√°ch bi√™n lai
    const content = document.getElementById('quickViewContent');
    content.innerHTML = `
        <div class="quick-view-section">
            <h4>üßæ Danh S√°ch Bi√™n Lai - ${student.name}</h4>
            ${studentReceipts.map(r => `
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e9ecef;">
                    <div class="d-flex justify-between">
                        <strong>${r.type}</strong>
                        <span class="text-success">${formatCurrency(r.amount)}</span>
                    </div>
                    <p class="text-muted">${r.description}</p>
                    <p class="text-muted">${formatDate(r.date)}</p>
                    <button class="btn btn-sm btn-info" onclick="viewReceipt('${r.id}')">üëÅÔ∏è Xem chi ti·∫øt</button>
                </div>
            `).join('')}
        </div>
    `;
    
    openModal('quickViewModal');
}

function printReceipt() {
    window.print();
}

function downloadReceiptPDF() {
    const element = document.getElementById('receiptPrintArea');
    if (!element) return;
    
    const opt = {
        margin: 10,
        filename: `BienLai_${Date.now()}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    
    html2pdf().set(opt).from(element).save();
    showNotification('ƒêang t·∫£i PDF...');
}

// ==========================================
// üìö CATEGORIES (M√¥n h·ªçc, G√≥i, KM)
// ==========================================

// === SUBJECTS ===
function renderSubjectsTable() {
    const tbody = document.getElementById('subjectsTableBody');
    
    tbody.innerHTML = subjects.map(sub => `
        <tr>
            <td style="font-size: 2em;">${sub.icon}</td>
            <td><strong>${sub.name}</strong></td>
            <td>${formatCurrency(sub.defaultFee)}</td>
            <td>
                <div class="action-buttons">
                    <button class="action-btn action-btn-edit" onclick="editSubject('${sub.id}')" title="S·ª≠a">‚úèÔ∏è</button>
                    <button class="action-btn action-btn-delete" onclick="deleteSubject('${sub.id}')" title="X√≥a">üóëÔ∏è</button>
                </div>
            </td>
        </tr>
    `).join('');
}

function openSubjectModal() {
    document.getElementById('editSubjectId').value = '';
    document.getElementById('subjectForm').reset();
    document.getElementById('subjectModalTitle').textContent = 'üìñ Th√™m M√¥n H·ªçc';
    openModal('subjectModal');
}

function editSubject(id) {
    const sub = subjects.find(s => s.id == id);
    if (!sub) return;
    
    document.getElementById('editSubjectId').value = sub.id;
    document.getElementById('subjectIcon').value = sub.icon;
    document.getElementById('subjectName').value = sub.name;
    document.getElementById('subjectDefaultFee').value = formatNumberInput(sub.defaultFee);
    document.getElementById('subjectModalTitle').textContent = '‚úèÔ∏è S·ª≠a M√¥n H·ªçc';
    
    openModal('subjectModal');
}

function saveSubject(event) {
    event.preventDefault();
    
    const editId = document.getElementById('editSubjectId').value;
    const subjectData = {
        icon: document.getElementById('subjectIcon').value.trim(),
        name: document.getElementById('subjectName').value.trim(),
        defaultFee: parseCurrencyInput(document.getElementById('subjectDefaultFee').value)
    };
    
    if (editId) {
        const index = subjects.findIndex(s => s.id == editId);
        if (index !== -1) {
            subjects[index] = { ...subjects[index], ...subjectData };
            showNotification('C·∫≠p nh·∫≠t m√¥n h·ªçc th√†nh c√¥ng!');
        }
    } else {
        subjects.push({ id: generateId(), ...subjectData });
        showNotification('Th√™m m√¥n h·ªçc th√†nh c√¥ng!');
    }
    
    saveData('subjects', subjects);
    closeModal('subjectModal');
    renderSubjectsTable();
    renderSubjectCheckboxes();
}

function deleteSubject(id) {
    if (!confirm('X√≥a m√¥n h·ªçc n√†y?')) return;
    
    subjects = subjects.filter(s => s.id != id);
    saveData('subjects', subjects);
    
    showNotification('ƒê√£ x√≥a m√¥n h·ªçc!');
    renderSubjectsTable();
    renderSubjectCheckboxes();
}

// === PACKAGES ===
function renderPackagesTable() {
    const tbody = document.getElementById('packagesTableBody');
    
    if (packages.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5">
                    <div class="empty-state">
                        <p>Ch∆∞a c√≥ g√≥i h·ªçc ph√≠ n√†o</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = packages.map(pkg => `
        <tr>
            <td><strong>${pkg.name}</strong></td>
            <td>${pkg.subjectName}</td>
            <td>${pkg.sessions} bu·ªïi</td>
            <td>${formatCurrency(pkg.fee)}</td>
            <td>
                <div class="action-buttons">
                    <button class="action-btn action-btn-edit" onclick="editPackage('${pkg.id}')" title="S·ª≠a">‚úèÔ∏è</button>
                    <button class="action-btn action-btn-delete" onclick="deletePackage('${pkg.id}')" title="X√≥a">üóëÔ∏è</button>
                </div>
            </td>
        </tr>
    `).join('');
}

function openPackageModal() {
    document.getElementById('editPackageId').value = '';
    document.getElementById('packageForm').reset();
    document.getElementById('packageModalTitle').textContent = 'üì¶ Th√™m G√≥i H·ªçc Ph√≠';
    
    // Populate subjects
    document.getElementById('packageSubject').innerHTML = '<option value="">-- Ch·ªçn m√¥n --</option>' +
        subjects.map(s => `<option value="${s.name}">${s.icon} ${s.name}</option>`).join('');
    
    openModal('packageModal');
}

function editPackage(id) {
    const pkg = packages.find(p => p.id === id);
    if (!pkg) return;
    
    document.getElementById('editPackageId').value = pkg.id;
    document.getElementById('packageName').value = pkg.name;
    document.getElementById('packageSessions').value = pkg.sessions;
    document.getElementById('packageFee').value = formatNumberInput(pkg.fee);
    document.getElementById('packageModalTitle').textContent = '‚úèÔ∏è S·ª≠a G√≥i H·ªçc Ph√≠';
    
    // Populate subjects
    document.getElementById('packageSubject').innerHTML = '<option value="">-- Ch·ªçn m√¥n --</option>' +
        subjects.map(s => `<option value="${s.name}" ${s.name === pkg.subjectName ? 'selected' : ''}>${s.icon} ${s.name}</option>`).join('');
    
    openModal('packageModal');
}

function savePackage(event) {
    event.preventDefault();
    
    const editId = document.getElementById('editPackageId').value;
    const packageData = {
        name: document.getElementById('packageName').value.trim(),
        subjectName: document.getElementById('packageSubject').value,
        sessions: parseInt(document.getElementById('packageSessions').value),
        fee: parseCurrencyInput(document.getElementById('packageFee').value)
    };
    
    if (editId) {
        const index = packages.findIndex(p => p.id === editId);
        if (index !== -1) {
            packages[index] = { ...packages[index], ...packageData };
            showNotification('C·∫≠p nh·∫≠t g√≥i h·ªçc ph√≠ th√†nh c√¥ng!');
        }
    } else {
        packages.push({ id: generateId(), ...packageData });
        showNotification('Th√™m g√≥i h·ªçc ph√≠ th√†nh c√¥ng!');
    }
    
    saveData('packages', packages);
    closeModal('packageModal');
    renderPackagesTable();
}

function deletePackage(id) {
    if (!confirm('X√≥a g√≥i h·ªçc ph√≠ n√†y?')) return;
    
    packages = packages.filter(p => p.id !== id);
    saveData('packages', packages);
    
    showNotification('ƒê√£ x√≥a g√≥i h·ªçc ph√≠!');
    renderPackagesTable();
}

// === PROMOTIONS ===
function renderPromotionsTable() {
    const tbody = document.getElementById('promotionsTableBody');
    const now = new Date();
    
    if (promotions.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6">
                    <div class="empty-state">
                        <p>Ch∆∞a c√≥ khuy·∫øn m√£i n√†o</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = promotions.map(promo => {
        const isExpired = new Date(promo.endDate) < now;
        return `
            <tr style="${isExpired ? 'opacity: 0.5;' : ''}">
                <td><strong>${promo.name}</strong></td>
                <td>${promo.type === 'percent' ? 'Gi·∫£m %' : 'Gi·∫£m VNƒê'}</td>
                <td>${promo.type === 'percent' ? promo.value + '%' : formatCurrency(promo.value)}</td>
                <td>${formatDate(promo.startDate)} - ${formatDate(promo.endDate)}</td>
                <td>${isExpired ? '<span class="text-danger">H·∫øt h·∫°n</span>' : '<span class="text-success">ƒêang ho·∫°t ƒë·ªông</span>'}</td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn action-btn-edit" onclick="editPromotion('${promo.id}')" title="S·ª≠a">‚úèÔ∏è</button>
                        <button class="action-btn action-btn-delete" onclick="deletePromotion('${promo.id}')" title="X√≥a">üóëÔ∏è</button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function openPromotionModal() {
    document.getElementById('editPromotionId').value = '';
    document.getElementById('promotionForm').reset();
    document.getElementById('promotionModalTitle').textContent = 'üéÅ Th√™m Khuy·∫øn M√£i';
    document.getElementById('promotionStartDate').value = new Date().toISOString().split('T')[0];
    openModal('promotionModal');
}

function editPromotion(id) {
    const promo = promotions.find(p => p.id === id);
    if (!promo) return;
    
    document.getElementById('editPromotionId').value = promo.id;
    document.getElementById('promotionName').value = promo.name;
    document.getElementById('promotionType').value = promo.type;
    document.getElementById('promotionValue').value = promo.value;
    document.getElementById('promotionStartDate').value = promo.startDate;
    document.getElementById('promotionEndDate').value = promo.endDate;
    document.getElementById('promotionModalTitle').textContent = '‚úèÔ∏è S·ª≠a Khuy·∫øn M√£i';
    
    openModal('promotionModal');
}

function savePromotion(event) {
    event.preventDefault();
    
    const editId = document.getElementById('editPromotionId').value;
    const promoData = {
        name: document.getElementById('promotionName').value.trim(),
        type: document.getElementById('promotionType').value,
        value: parseFloat(document.getElementById('promotionValue').value),
        startDate: document.getElementById('promotionStartDate').value,
        endDate: document.getElementById('promotionEndDate').value
    };
    
    if (editId) {
        const index = promotions.findIndex(p => p.id === editId);
        if (index !== -1) {
            promotions[index] = { ...promotions[index], ...promoData };
            showNotification('C·∫≠p nh·∫≠t khuy·∫øn m√£i th√†nh c√¥ng!');
        }
    } else {
        promotions.push({ id: generateId(), ...promoData });
        showNotification('Th√™m khuy·∫øn m√£i th√†nh c√¥ng!');
    }
    
    saveData('promotions', promotions);
    closeModal('promotionModal');
    renderPromotionsTable();
}

function deletePromotion(id) {
    if (!confirm('X√≥a khuy·∫øn m√£i n√†y?')) return;
    
    promotions = promotions.filter(p => p.id !== id);
    saveData('promotions', promotions);
    
    showNotification('ƒê√£ x√≥a khuy·∫øn m√£i!');
    renderPromotionsTable();
}

// ==========================================
// üì§ EXPORT & BACKUP
// ==========================================

function exportAllToExcel() {
    const wb = XLSX.utils.book_new();
    
    // Sheet H·ªçc Vi√™n
    const studentsData = students.map(s => ({
        'T√™n': s.name,
        'Tu·ªïi': s.age,
        'Ph·ª• huynh': s.parentName,
        'SƒêT': s.parentPhone,
        'Email': s.parentEmail || '',
        'M√¥n h·ªçc': s.subjects.join(', '),
        'Tr·∫°ng th√°i': s.status
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(studentsData), 'H·ªçc Vi√™n');
    
    // Sheet L·ªãch H·∫πn
    const appointmentsData = appointments.map(a => {
        const s = students.find(st => st.id === a.studentId);
        return {
            'H·ªçc vi√™n': s?.name || 'N/A',
            'M√¥n': a.subject,
            'Ng√†y': a.date,
            'Gi·ªù': a.time,
            'Ghi ch√∫': a.notes || ''
        };
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(appointmentsData), 'L·ªãch H·∫πn');
    
    // Sheet Bi√™n Lai
    const receiptsData = receipts.map(r => {
        const s = students.find(st => st.id === r.studentId);
        return {
            'Lo·∫°i': r.type,
            'H·ªçc vi√™n': s?.name || 'N/A',
            'N·ªôi dung': r.description,
            'S·ªë ti·ªÅn': r.amount,
            'Ng√†y': r.date
        };
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(receiptsData), 'Bi√™n Lai');
    
    XLSX.writeFile(wb, `BaoCao_${formatDateForFile()}.xlsx`);
    showNotification('Xu·∫•t Excel th√†nh c√¥ng!');
}

function exportStudentsToExcel() {
    const wb = XLSX.utils.book_new();
    const data = students.map(s => ({
        'T√™n': s.name,
        'Tu·ªïi': s.age,
        'Ph·ª• huynh': s.parentName,
        'SƒêT': s.parentPhone,
        'Email': s.parentEmail || '',
        'M√¥n h·ªçc': s.subjects.join(', '),
        'Tr·∫°ng th√°i': s.status
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), 'H·ªçc Vi√™n');
    XLSX.writeFile(wb, `HocVien_${formatDateForFile()}.xlsx`);
    showNotification('Xu·∫•t Excel th√†nh c√¥ng!');
}

function exportAppointmentsToExcel() {
    const wb = XLSX.utils.book_new();
    const data = appointments.map(a => {
        const s = students.find(st => st.id === a.studentId);
        return {
            'H·ªçc vi√™n': s?.name || 'N/A',
            'M√¥n': a.subject,
            'Ng√†y': a.date,
            'Gi·ªù': a.time
        };
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), 'L·ªãch H·∫πn');
    XLSX.writeFile(wb, `LichHen_${formatDateForFile()}.xlsx`);
    showNotification('Xu·∫•t Excel th√†nh c√¥ng!');
}

function exportReceiptsToExcel() {
    const wb = XLSX.utils.book_new();
    const data = receipts.map(r => {
        const s = students.find(st => st.id === r.studentId);
        return {
            'Lo·∫°i': r.type,
            'H·ªçc vi√™n': s?.name || 'N/A',
            'N·ªôi dung': r.description,
            'S·ªë ti·ªÅn': r.amount,
            'Ng√†y': r.date
        };
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), 'Bi√™n Lai');
    XLSX.writeFile(wb, `BienLai_${formatDateForFile()}.xlsx`);
    showNotification('Xu·∫•t Excel th√†nh c√¥ng!');
}

function exportBackupJSON() {
    const backup = {
        version: '3.0',
        exportDate: new Date().toISOString(),
        data: {
            students,
            appointments,
            receipts,
            subjects,
            packages,
            promotions,
            centerInfo,
            bankInfo
        }
    };
    
    const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Backup_V3_${formatDateForFile()}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('T·∫£i backup JSON th√†nh c√¥ng!');
}

function restoreFromJSON(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const backup = JSON.parse(e.target.result);
            
            if (!backup.data) {
                throw new Error('File backup kh√¥ng h·ª£p l·ªá!');
            }
            
            if (!confirm('‚ö†Ô∏è Kh√¥i ph·ª•c t·ª´ backup s·∫Ω ghi ƒë√® to√†n b·ªô d·ªØ li·ªáu hi·ªán t·∫°i!\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn?')) {
                return;
            }
            
            students = backup.data.students || [];
            appointments = backup.data.appointments || [];
            receipts = backup.data.receipts || [];
            subjects = backup.data.subjects || subjects;
            packages = backup.data.packages || [];
            promotions = backup.data.promotions || [];
            centerInfo = backup.data.centerInfo || {};
            bankInfo = backup.data.bankInfo || {};
            
            // Save all
            saveData('students', students);
            saveData('appointments', appointments);
            saveData('receipts', receipts);
            saveData('subjects', subjects);
            saveData('packages', packages);
            saveData('promotions', promotions);
            localStorage.setItem('centerInfo', JSON.stringify(centerInfo));
            localStorage.setItem('bankInfo', JSON.stringify(bankInfo));
            
            renderAll();
            loadCenterInfo();
            loadBankInfo();
            
            showNotification('Kh√¥i ph·ª•c d·ªØ li·ªáu th√†nh c√¥ng!');
        } catch (error) {
            showNotification('L·ªói: ' + error.message, 'error');
        }
    };
    reader.readAsText(file);
    event.target.value = '';
}

// Auto Backup
function createAutoBackup() {
    const backup = {
        id: generateId(),
        date: new Date().toISOString(),
        type: 'auto',
        data: { students, appointments, receipts, subjects, packages, promotions, centerInfo, bankInfo }
    };
    
    backupHistory.unshift(backup);
    
    // Ch·ªâ gi·ªØ 10 b·∫£n m·ªõi nh·∫•t
    if (backupHistory.length > 10) {
        backupHistory = backupHistory.slice(0, 10);
    }
    
    localStorage.setItem('backupHistory', JSON.stringify(backupHistory));
}

function createManualBackup() {
    const backup = {
        id: generateId(),
        date: new Date().toISOString(),
        type: 'manual',
        data: { students, appointments, receipts, subjects, packages, promotions, centerInfo, bankInfo }
    };
    
    backupHistory.unshift(backup);
    
    if (backupHistory.length > 10) {
        backupHistory = backupHistory.slice(0, 10);
    }
    
    localStorage.setItem('backupHistory', JSON.stringify(backupHistory));
    renderBackupHistory();
    showNotification('T·∫°o backup th√†nh c√¥ng!');
}

function toggleAutoBackup() {
    autoBackupEnabled = document.getElementById('autoBackupToggle').checked;
    localStorage.setItem('autoBackupEnabled', autoBackupEnabled);
    updateAutoBackupStatus();
    
    if (autoBackupEnabled) {
        createAutoBackup();
        showNotification('ƒê√£ b·∫≠t sao l∆∞u t·ª± ƒë·ªông!');
    } else {
        showNotification('ƒê√£ t·∫Øt sao l∆∞u t·ª± ƒë·ªông!', 'warning');
    }
}

function updateAutoBackupStatus() {
    const status = document.getElementById('autoBackupStatus');
    if (autoBackupEnabled) {
        status.innerHTML = '<span class="text-success">‚úÖ ƒêang ho·∫°t ƒë·ªông</span>';
    } else {
        status.innerHTML = '<span class="text-danger">‚ùå Ch∆∞a k√≠ch ho·∫°t</span>';
    }
}

function renderBackupHistory() {
    const container = document.getElementById('backupHistoryList');
    
    if (backupHistory.length === 0) {
        container.innerHTML = '<p class="text-muted">Ch∆∞a c√≥ b·∫£n backup n√†o</p>';
        return;
    }
    
    container.innerHTML = backupHistory.slice(0, 5).map(backup => `
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <strong>${backup.type === 'auto' ? 'üîÑ T·ª± ƒë·ªông' : 'üíæ Th·ªß c√¥ng'}</strong><br>
                <small class="text-muted">${new Date(backup.date).toLocaleString('vi-VN')}</small><br>
                <small>HV: ${backup.data.students?.length || 0} | L·ªãch: ${backup.data.appointments?.length || 0} | BL: ${backup.data.receipts?.length || 0}</small>
            </div>
            <button class="btn btn-sm btn-info" onclick="restoreFromBackupHistory('${backup.id}')">üîÑ Kh√¥i ph·ª•c</button>
        </div>
    `).join('');
}

function restoreFromBackupHistory(backupId) {
    const backup = backupHistory.find(b => b.id === backupId);
    if (!backup) return;
    
    if (!confirm('‚ö†Ô∏è Kh√¥i ph·ª•c t·ª´ backup n√†y s·∫Ω ghi ƒë√® to√†n b·ªô d·ªØ li·ªáu hi·ªán t·∫°i!\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn?')) {
        return;
    }
    
    students = backup.data.students || [];
    appointments = backup.data.appointments || [];
    receipts = backup.data.receipts || [];
    subjects = backup.data.subjects || subjects;
    packages = backup.data.packages || [];
    promotions = backup.data.promotions || [];
    centerInfo = backup.data.centerInfo || {};
    bankInfo = backup.data.bankInfo || {};
    
    // Save all
    localStorage.setItem('students', JSON.stringify(students));
    localStorage.setItem('appointments', JSON.stringify(appointments));
    localStorage.setItem('receipts', JSON.stringify(receipts));
    localStorage.setItem('subjects', JSON.stringify(subjects));
    localStorage.setItem('packages', JSON.stringify(packages));
    localStorage.setItem('promotions', JSON.stringify(promotions));
    localStorage.setItem('centerInfo', JSON.stringify(centerInfo));
    localStorage.setItem('bankInfo', JSON.stringify(bankInfo));
    
    renderAll();
    loadCenterInfo();
    loadBankInfo();
    
    showNotification('Kh√¥i ph·ª•c d·ªØ li·ªáu th√†nh c√¥ng!');
}

// ==========================================
// ‚öôÔ∏è SETTINGS
// ==========================================

function saveCenterInfo(event) {
    event.preventDefault();
    
    centerInfo = {
        name: document.getElementById('centerName').value.trim(),
        phone: document.getElementById('centerPhone').value.trim(),
        address: document.getElementById('centerAddress').value.trim(),
        email: document.getElementById('centerEmail').value.trim(),
        website: document.getElementById('centerWebsite').value.trim(),
        logo: centerInfo.logo || ''
    };
    
    localStorage.setItem('centerInfo', JSON.stringify(centerInfo));
    showNotification('L∆∞u th√¥ng tin trung t√¢m th√†nh c√¥ng!');
}

function loadCenterInfo() {
    if (centerInfo.name) {
        document.getElementById('centerName').value = centerInfo.name || '';
        document.getElementById('centerPhone').value = centerInfo.phone || '';
        document.getElementById('centerAddress').value = centerInfo.address || '';
        document.getElementById('centerEmail').value = centerInfo.email || '';
        document.getElementById('centerWebsite').value = centerInfo.website || '';
        
        if (centerInfo.logo) {
            document.getElementById('logoPreview').innerHTML = `<img src="${centerInfo.logo}" alt="Logo">`;
        }
    }
}

function previewLogo(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        centerInfo.logo = e.target.result;
        document.getElementById('logoPreview').innerHTML = `<img src="${e.target.result}" alt="Logo">`;
    };
    reader.readAsDataURL(file);
}

function saveBankInfo(event) {
    event.preventDefault();
    
    bankInfo = {
        bankName: document.getElementById('bankName').value.trim(),
        accountNumber: document.getElementById('bankAccount').value.trim(),
        accountName: document.getElementById('bankAccountName').value.trim(),
        branch: document.getElementById('bankBranch').value.trim()
    };
    
    localStorage.setItem('bankInfo', JSON.stringify(bankInfo));
    generateBankQRCode();
    showNotification('L∆∞u th√¥ng tin ng√¢n h√†ng th√†nh c√¥ng!');
}

function loadBankInfo() {
    if (bankInfo.bankName) {
        document.getElementById('bankName').value = bankInfo.bankName || '';
        document.getElementById('bankAccount').value = bankInfo.accountNumber || '';
        document.getElementById('bankAccountName').value = bankInfo.accountName || '';
        document.getElementById('bankBranch').value = bankInfo.branch || '';
        generateBankQRCode();
    }
}

function generateBankQRCode() {
    const container = document.getElementById('bankQRCode');
    container.innerHTML = '';
    
    if (bankInfo.accountNumber && bankInfo.accountName) {
        new QRCode(container, {
            text: `${bankInfo.bankName}|${bankInfo.accountNumber}|${bankInfo.accountName}`,
            width: 150,
            height: 150
        });
    }
}

function clearAllData() {
    if (!confirm('‚ö†Ô∏è X√ìA TO√ÄN B·ªò D·ªÆ LI·ªÜU?\n\nH√†nh ƒë·ªông n√†y KH√îNG TH·ªÇ ho√†n t√°c!')) {
        return;
    }
    
    const confirmText = prompt('Nh·∫≠p "XOA" ƒë·ªÉ x√°c nh·∫≠n:');
    if (confirmText !== 'XOA') {
        showNotification('ƒê√£ h·ªßy x√≥a d·ªØ li·ªáu!', 'info');
        return;
    }
    
    localStorage.clear();
    
    students = [];
    appointments = [];
    receipts = [];
    packages = [];
    promotions = [];
    centerInfo = {};
    bankInfo = {};
    backupHistory = [];
    
    renderAll();
    showNotification('ƒê√£ x√≥a to√†n b·ªô d·ªØ li·ªáu!', 'warning');
}

// ==========================================
// üõ†Ô∏è UTILITY FUNCTIONS
// ==========================================

function renderAll() {
    renderDashboard();
    renderStudentsTable();
    updateStudentCounts();
    renderTrialStudentsTable();
    updateTrialCounts();
    renderAppointmentsTable();
    renderReceiptsTable();
    renderSubjectsTable();
    renderPackagesTable();
    renderPromotionsTable();
    renderBackupHistory();
    renderSubjectCheckboxes();
}

function formatDate(dateString) {
    const date = new Date(dateString);
    const days = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
    return `${days[date.getDay()]} ${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
}

function formatDateForFile() {
    const now = new Date();
    return `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
}

function formatCurrencyShort(amount) {
    if (amount >= 1000000) {
        return (amount / 1000000).toFixed(1) + 'tr';
    } else if (amount >= 1000) {
        return (amount / 1000).toFixed(0) + 'k';
    }
    return amount.toString();
}

function formatNumberInput(num) {
    return new Intl.NumberFormat('vi-VN').format(num);
}

function formatCurrencyInput(input) {
    let value = input.value.replace(/\D/g, '');
    if (value) {
        value = parseInt(value).toLocaleString('vi-VN');
    }
    input.value = value;
}

function parseCurrencyInput(str) {
    return parseInt(str.replace(/\D/g, '')) || 0;
}

function normalizePhone(phone) {
    let normalized = phone.replace(/[\s\-\.]/g, '');
    if (normalized.startsWith('+84')) {
        normalized = '0' + normalized.substring(3);
    } else if (normalized.startsWith('84') && normalized.length > 10) {
        normalized = '0' + normalized.substring(2);
    }
    return normalized;
}

function numberToWords(num) {
    if (num === 0) return 'Kh√¥ng ƒë·ªìng';
    
    const ones = ['', 'm·ªôt', 'hai', 'ba', 'b·ªën', 'nƒÉm', 's√°u', 'b·∫£y', 't√°m', 'ch√≠n'];
    const tens = ['', 'm∆∞·ªùi', 'hai m∆∞∆°i', 'ba m∆∞∆°i', 'b·ªën m∆∞∆°i', 'nƒÉm m∆∞∆°i', 's√°u m∆∞∆°i', 'b·∫£y m∆∞∆°i', 't√°m m∆∞∆°i', 'ch√≠n m∆∞∆°i'];
    
    function convertHundreds(n) {
        if (n === 0) return '';
        let result = '';
        
        const hundred = Math.floor(n / 100);
        const remainder = n % 100;
        const ten = Math.floor(remainder / 10);
        const one = remainder % 10;
        
        if (hundred > 0) {
            result += ones[hundred] + ' trƒÉm ';
        }
        
        if (ten > 1) {
            result += tens[ten] + ' ';
            if (one === 1) result += 'm·ªët ';
            else if (one === 5) result += 'lƒÉm ';
            else if (one > 0) result += ones[one] + ' ';
        } else if (ten === 1) {
            result += 'm∆∞·ªùi ';
            if (one === 1) result += 'm·ªôt ';
            else if (one === 5) result += 'lƒÉm ';
            else if (one > 0) result += ones[one] + ' ';
        } else if (one > 0) {
            if (hundred > 0) result += 'l·∫ª ';
            result += ones[one] + ' ';
        }
        
        return result;
    }
    
    let result = '';
    
    const billion = Math.floor(num / 1000000000);
    const million = Math.floor((num % 1000000000) / 1000000);
    const thousand = Math.floor((num % 1000000) / 1000);
    const remainder = num % 1000;
    
    if (billion > 0) result += convertHundreds(billion) + 't·ª∑ ';
    if (million > 0) result += convertHundreds(million) + 'tri·ªáu ';
    if (thousand > 0) result += convertHundreds(thousand) + 'ngh√¨n ';
    if (remainder > 0) result += convertHundreds(remainder);
    
    result = result.trim() + ' ƒë·ªìng';
    return result.charAt(0).toUpperCase() + result.slice(1);
}

// ==========================================
// üèÅ END OF JAVASCRIPT
// ==========================================
    </script>
</body>
</html>

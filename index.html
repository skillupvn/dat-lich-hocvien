<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω ƒêƒÉng K√Ω H·ªçc Vi√™n - V3.0</title>
    
    <!-- Th∆∞ vi·ªán b√™n ngo√†i -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* ==========================================
           üé® CSS RESET & BASE
        ========================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* ==========================================
           üè† CONTAINER & HEADER
        ========================================== */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-title p {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        /* ==========================================
           üìë TABS NAVIGATION
        ========================================== */
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
            border: none;
            background: none;
            font-size: 0.9em;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tab:hover {
            background: #e9ecef;
            color: #495057;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        /* ==========================================
           üì¶ CONTENT AREA
        ========================================== */
        .content {
            padding: 25px;
            min-height: 500px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ==========================================
           üìù PAGE HEADER (Title + Actions)
        ========================================== */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .page-header h2 {
            color: #333;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .page-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* ==========================================
           üìù FORMS
        ========================================== */
        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 2px solid #e9ecef;
            display: none; /* ·∫®n m·∫∑c ƒë·ªãnh */
        }

        .form-section.show {
            display: block;
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from { 
                opacity: 0;
                transform: translateY(-20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .form-section-header h3 {
            color: #667eea;
            font-size: 1.1em;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #495057;
            font-size: 0.9em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.95em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* ==========================================
           üîò BUTTONS
        ========================================== */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-outline {
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
        }

        .btn-outline:hover {
            background: #667eea;
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8em;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        /* ==========================================
           üîç FILTER BAR
        ========================================== */
        .filter-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #e9ecef;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.85em;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .filter-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .filter-btn .count {
            background: rgba(0,0,0,0.1);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.85em;
        }

        .filter-btn.active .count {
            background: rgba(255,255,255,0.3);
        }

        .search-box {
            position: relative;
            flex: 1;
            min-width: 200px;
            max-width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 8px 15px 8px 35px;
            border: 2px solid #e9ecef;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-box::before {
            content: 'üîç';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.85em;
        }

        /* ==========================================
           üìä TABLES
        ========================================== */
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            background: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th {
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85em;
            white-space: nowrap;
        }

        td {
            padding: 10px 15px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
            font-size: 0.9em;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        /* ==========================================
           üìÑ PAGINATION
        ========================================== */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .pagination-info {
            color: #6c757d;
            font-size: 0.9em;
        }

        .pagination {
            display: flex;
            gap: 5px;
        }

        .pagination button {
            padding: 8px 14px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 0.85em;
        }

        .pagination button:hover:not(:disabled) {
            border-color: #667eea;
            color: #667eea;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-size-select {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            color: #6c757d;
        }

        .page-size-select select {
            padding: 6px 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.9em;
        }

        /* ==========================================
           üè∑Ô∏è STATUS BADGES
        ========================================== */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .status-hoc-thu {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status-cho-dang-ky {
            background: #fff8e1;
            color: #f57c00;
        }

        .status-da-dang-ky {
            background: #e8f5e9;
            color: #388e3c;
        }

        .status-hoan-thanh {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .status-cancel {
            background: #ffebee;
            color: #c62828;
        }

        /* ==========================================
           ‚ö° ACTION BUTTONS
        ========================================== */
        .action-buttons {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .action-btn {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover {
            transform: scale(1.1);
        }

        .action-btn-view { background: #e3f2fd; color: #1976d2; }
        .action-btn-schedule { background: #fff8e1; color: #f57c00; }
        .action-btn-edit { background: #e8f5e9; color: #388e3c; }
        .action-btn-delete { background: #ffebee; color: #c62828; }
        .action-btn-register { background: #e8f5e9; color: #388e3c; }
        .action-btn-cancel { background: #ffebee; color: #c62828; }
        .action-btn-receipt { background: #f3e5f5; color: #7b1fa2; }
        .action-btn-restore { background: #e0f7fa; color: #00838f; }
        .action-btn-confirm { background: #c8e6c9; color: #2e7d32; }
        .action-btn-reg { background: #e1f5fe; color: #0277bd; }

        /* ==========================================
           üìà STATS CARDS
        ========================================== */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .stat-card.stat-hoc-thu { background: linear-gradient(135deg, #42a5f5 0%, #1976d2 100%); }
        .stat-card.stat-cho-dang-ky { background: linear-gradient(135deg, #ffb74d 0%, #f57c00 100%); }
        .stat-card.stat-da-dang-ky { background: linear-gradient(135deg, #66bb6a 0%, #388e3c 100%); }
        .stat-card.stat-hoan-thanh { background: linear-gradient(135deg, #ab47bc 0%, #7b1fa2 100%); }
        .stat-card.stat-cancel { background: linear-gradient(135deg, #ef5350 0%, #c62828 100%); }
        .stat-card.stat-revenue { background: linear-gradient(135deg, #26c6da 0%, #00838f 100%); }

        /* ==========================================
           üìä CHART
        ========================================== */
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-top: 25px;
        }

        .chart-container h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.1em;
        }

        .chart-bars {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 180px;
            padding: 15px 0;
            border-bottom: 2px solid #e9ecef;
        }

        .chart-bar-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .chart-bar {
            width: 40px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            border-radius: 6px 6px 0 0;
            transition: all 0.3s;
            position: relative;
            min-height: 5px;
        }

        .chart-bar:hover {
            opacity: 0.8;
        }

        .chart-bar-value {
            position: absolute;
            top: -22px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7em;
            font-weight: 600;
            color: #667eea;
            white-space: nowrap;
        }

        .chart-bar-label {
            margin-top: 8px;
            font-size: 0.75em;
            color: #6c757d;
        }

        /* ==========================================
           üîî MODALS
        ========================================== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s;
        }

        .modal-lg {
            max-width: 800px;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-header h2 {
            color: #667eea;
            font-size: 1.2em;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #6c757d;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: #dc3545;
        }

        .modal-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid #e9ecef;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* ==========================================
           üîç SEARCHABLE SELECT (Custom Dropdown)
        ========================================== */
        .searchable-select {
            position: relative;
        }

        .searchable-select-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.95em;
            cursor: pointer;
            background: white;
        }

        .searchable-select-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .searchable-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .searchable-select-dropdown.show {
            display: block;
        }

        .searchable-select-search {
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
            position: sticky;
            top: 0;
            background: white;
        }

        .searchable-select-search input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .searchable-select-option {
            padding: 10px 12px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.9em;
        }

        .searchable-select-option:hover {
            background: #f0f4ff;
        }

        .searchable-select-option.selected {
            background: #667eea;
            color: white;
        }

        .searchable-select-empty {
            padding: 15px;
            text-align: center;
            color: #6c757d;
        }

        /* ==========================================
           üìã QUICK VIEW
        ========================================== */
        .quick-view-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .quick-view-section h4 {
            color: #667eea;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e9ecef;
            font-size: 1em;
        }

        .quick-view-row {
            display: flex;
            padding: 6px 0;
            font-size: 0.9em;
        }

        .quick-view-label {
            font-weight: 600;
            color: #495057;
            min-width: 120px;
        }

        .quick-view-value {
            color: #212529;
            flex: 1;
        }

        /* ==========================================
           üßæ REGISTRATION CARD
        ========================================== */
        .registration-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .registration-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .registration-code {
            font-size: 1.1em;
            font-weight: 700;
            color: #667eea;
        }

        .registration-qr {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        /* ==========================================
           üîî NOTIFICATIONS
        ========================================== */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            z-index: 2000;
            display: none;
            max-width: 350px;
            animation: slideInRight 0.3s;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .notification.show {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification.success { border-left: 4px solid #28a745; }
        .notification.error { border-left: 4px solid #dc3545; }
        .notification.info { border-left: 4px solid #17a2b8; }
        .notification.warning { border-left: 4px solid #ffc107; }

        /* ==========================================
           ‚öôÔ∏è SETTINGS
        ========================================== */
        .settings-group {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .settings-group h3 {
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
            font-size: 1.1em;
        }

        .logo-preview {
            width: 100px;
            height: 100px;
            border: 2px dashed #e9ecef;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
            overflow: hidden;
        }

        .logo-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* ==========================================
           üìö CATEGORY TABS
        ========================================== */
        .category-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .category-tab {
            padding: 10px 18px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .category-tab:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .category-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .category-content {
            display: none;
        }

        .category-content.active {
            display: block;
        }

        /* ==========================================
           üéØ UTILITY CLASSES
        ========================================== */
        .text-center { text-align: center; }
        .text-muted { color: #6c757d; }
        .text-success { color: #28a745; }
        .text-danger { color: #dc3545; }
        .text-primary { color: #667eea; }

        .d-flex { display: flex; }
        .gap-10 { gap: 10px; }
        .gap-15 { gap: 15px; }
        .justify-between { justify-content: space-between; }
        .align-center { align-items: center; }
        .flex-wrap { flex-wrap: wrap; }

        .mt-15 { margin-top: 15px; }
        .mt-20 { margin-top: 20px; }
        .mb-15 { margin-bottom: 15px; }
        .mb-20 { margin-bottom: 20px; }

        .hidden { display: none !important; }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .subject-tag {
            display: inline-block;
            padding: 2px 8px;
            background: #e9ecef;
            border-radius: 12px;
            font-size: 0.8em;
            margin: 1px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .checkbox-item input {
            width: auto;
        }

        .upcoming-item {
            background: #fff8e1;
            padding: 12px 15px;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        /* ==========================================
           üì± RESPONSIVE
        ========================================== */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }

            .header-title h1 {
                font-size: 1.4em;
            }

            .form-row,
            .form-row-3 {
                grid-template-columns: 1fr;
            }

            .tabs {
                overflow-x: auto;
            }

            .tab {
                padding: 12px 15px;
                font-size: 0.8em;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .filter-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-btn {
                justify-content: center;
            }

            .search-box {
                max-width: none;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .pagination-container {
                flex-direction: column;
            }

            .modal-content {
                padding: 15px;
            }
        }

        /* ==========================================
           üñ®Ô∏è PRINT STYLES
        ========================================== */
        @media print {
            body * {
                visibility: hidden;
            }

            .print-area,
            .print-area * {
                visibility: visible;
            }

            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ==========================================
             üè† HEADER
        ========================================== -->
        <div class="header">
            <div class="header-title">
                <h1>üìö H·ªá Th·ªëng Qu·∫£n L√Ω Trung T√¢m</h1>
                <p>Version 3.1 - 9 Tab + 5 Tr·∫°ng Th√°i H·ªçc Vi√™n</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-warning btn-sm" onclick="createManualBackup()">
                    üíæ Backup
                </button>
            </div>
        </div>

        <!-- ==========================================
             üìë TABS NAVIGATION (9 Tabs)
        ========================================== -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">üìä T·ªïng Quan</button>
            <button class="tab" onclick="switchTab('students')">üë©‚Äçüéì H·ªçc Vi√™n</button>
            <button class="tab" onclick="switchTab('trial')">üéì H·ªçc Th·ª≠</button>
            <button class="tab" onclick="switchTab('appointments')">üìÖ L·ªãch H·∫πn</button>
            <button class="tab" onclick="switchTab('registrations')">üìã Phi·∫øu ƒêK</button>
            <button class="tab" onclick="switchTab('receipts')">üßæ Bi√™n Lai</button>
            <button class="tab" onclick="switchTab('categories')">üìö Danh M·ª•c</button>
            <button class="tab" onclick="switchTab('export')">üì§ Xu·∫•t Data</button>
            <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è C√†i ƒê·∫∑t</button>
        </div>

        <!-- ==========================================
             üì¶ CONTENT AREA
        ========================================== -->
        <div class="content">
            
            <!-- ==========================================
                 TAB 1: üìä T·ªîNG QUAN
            ========================================== -->
            <div id="dashboard" class="tab-content active">
                <div class="page-header">
                    <h2>üìä T·ªïng Quan H·ªá Th·ªëng</h2>
                </div>
                
                <div class="stats" id="dashboardStats"></div>

                <div class="chart-container">
                    <h3>üìà Doanh Thu 6 Th√°ng G·∫ßn Nh·∫•t</h3>
                    <div class="chart-bars" id="revenueChart"></div>
                </div>

                <div class="mt-20">
                    <h3 style="color: #333; margin-bottom: 15px;">üìÖ L·ªãch H·∫πn S·∫Øp T·ªõi</h3>
                    <div id="upcomingAppointments"></div>
                </div>
            </div>

            <!-- ==========================================
                 TAB 2: üë©‚Äçüéì H·ªåC VI√äN
            ========================================== -->
            <div id="students" class="tab-content">
                <div class="page-header">
                    <h2>üë©‚Äçüéì Qu·∫£n L√Ω H·ªçc Vi√™n</h2>
                    <div class="page-actions">
                        <button class="btn btn-info" onclick="exportStudentsToExcel()">üì§ Export Excel</button>
                        <button class="btn btn-success" onclick="toggleStudentForm()">‚ûï Th√™m H·ªçc Vi√™n M·ªõi</button>
                    </div>
                </div>

                <!-- Form Th√™m/S·ª≠a (·∫®n m·∫∑c ƒë·ªãnh) -->
                <div class="form-section" id="studentFormSection">
                    <div class="form-section-header">
                        <h3 id="studentFormTitle">‚ûï Th√™m H·ªçc Vi√™n M·ªõi</h3>
                        <button class="btn btn-sm btn-secondary" onclick="toggleStudentForm()">‚úï ƒê√≥ng</button>
                    </div>
                    
                    <form id="studentForm" onsubmit="saveStudent(event)">
                        <input type="hidden" id="editStudentId" value="">
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>T√™n H·ªçc Vi√™n *</label>
                                <input type="text" id="studentName" required placeholder="Nh·∫≠p t√™n h·ªçc vi√™n">
                            </div>
                            <div class="form-group">
                                <label>Tu·ªïi *</label>
                                <input type="number" id="studentAge" required min="3" max="18" placeholder="Nh·∫≠p tu·ªïi">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>T√™n Ph·ª• Huynh *</label>
                                <input type="text" id="parentName" required placeholder="Nh·∫≠p t√™n ph·ª• huynh">
                            </div>
                            <div class="form-group">
                                <label>S·ªë ƒêi·ªán Tho·∫°i *</label>
                                <input type="tel" id="parentPhone" required placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Email Ph·ª• Huynh</label>
                                <input type="email" id="parentEmail" placeholder="Nh·∫≠p email (t√πy ch·ªçn)">
                            </div>
                            <div class="form-group">
                                <label>Tr·∫°ng Th√°i *</label>
                                <select id="studentStatus" required>
                                    <option value="H·ªçc Th·ª≠">üÜï H·ªçc Th·ª≠</option>
                                    <option value="Ch·ªù ƒêƒÉng K√Ω">‚è≥ Ch·ªù ƒêƒÉng K√Ω</option>
                                    <option value="ƒê√£ ƒêƒÉng K√Ω">‚úÖ ƒê√£ ƒêƒÉng K√Ω</option>
                                    <option value="Ho√†n Th√†nh">üéì Ho√†n Th√†nh</option>
                                    <option value="Cancel">‚ùå Cancel</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>M√¥n H·ªçc Quan T√¢m *</label>
                            <div class="checkbox-group" id="subjectCheckboxes"></div>
                        </div>

                        <div class="form-group">
                            <label>Ghi Ch√∫</label>
                            <textarea id="studentNotes" rows="2" placeholder="Nh·∫≠p ghi ch√∫ (t√πy ch·ªçn)"></textarea>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" id="saveStudentBtn">üíæ L∆∞u H·ªçc Vi√™n</button>
                            <button type="button" class="btn btn-secondary" onclick="toggleStudentForm()">‚ùå H·ªßy</button>
                        </div>
                    </form>
                </div>

                <!-- Filter Bar -->
                <div class="filter-bar">
                    <button class="filter-btn active" onclick="filterStudents('all')" data-filter="all">
                        üìã T·∫•t c·∫£ <span class="count" id="countAll">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterStudents('H·ªçc Th·ª≠')" data-filter="H·ªçc Th·ª≠">
                        üÜï H·ªçc Th·ª≠ <span class="count" id="countHocThu">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterStudents('Ch·ªù ƒêƒÉng K√Ω')" data-filter="Ch·ªù ƒêƒÉng K√Ω">
                        ‚è≥ Ch·ªù ƒêK <span class="count" id="countChoDangKy">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterStudents('ƒê√£ ƒêƒÉng K√Ω')" data-filter="ƒê√£ ƒêƒÉng K√Ω">
                        ‚úÖ ƒê√£ ƒêK <span class="count" id="countDaDangKy">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterStudents('Ho√†n Th√†nh')" data-filter="Ho√†n Th√†nh">
                        üéì Ho√†n Th√†nh <span class="count" id="countHoanThanh">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterStudents('Cancel')" data-filter="Cancel">
                        ‚ùå Cancel <span class="count" id="countCancel">0</span>
                    </button>
                    <div class="search-box">
                        <input type="text" id="searchStudent" placeholder="T√¨m ki·∫øm h·ªçc vi√™n..." oninput="searchStudents()">
                    </div>
                </div>

                <!-- Table -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>T√™n HV</th>
                                <th>Tu·ªïi</th>
                                <th>Ph·ª• Huynh</th>
                                <th>SƒêT</th>
                                <th>M√¥n H·ªçc</th>
                                <th>Tr·∫°ng Th√°i</th>
                                <th>Thao T√°c</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody"></tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="pagination-container" id="studentsPagination"></div>
            </div>

            <!-- ==========================================
                 TAB 3: üéì H·ªåC TH·ª¨
            ========================================== -->
            <div id="trial" class="tab-content">
                <div class="page-header">
                    <h2>üéì Danh S√°ch H·ªçc Th·ª≠ & Ch·ªù ƒêƒÉng K√Ω</h2>
                    <div class="page-actions">
                        <button class="btn btn-info" onclick="exportTrialStudentsToExcel()">üì§ Export Excel</button>
                    </div>
                </div>

                <div class="filter-bar">
                    <button class="filter-btn active" onclick="filterTrialStudents('all')" data-filter="all">
                        üìã T·∫•t c·∫£ <span class="count" id="trialCountAll">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterTrialStudents('H·ªçc Th·ª≠')" data-filter="H·ªçc Th·ª≠">
                        üÜï H·ªçc Th·ª≠ <span class="count" id="trialCountHocThu">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterTrialStudents('Ch·ªù ƒêƒÉng K√Ω')" data-filter="Ch·ªù ƒêƒÉng K√Ω">
                        ‚è≥ Ch·ªù ƒêƒÉng K√Ω <span class="count" id="trialCountChoDangKy">0</span>
                    </button>
                    <div class="search-box">
                        <input type="text" id="searchTrialStudent" placeholder="T√¨m ki·∫øm..." oninput="searchTrialStudents()">
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>T√™n HV</th>
                                <th>Tu·ªïi</th>
                                <th>Ph·ª• Huynh</th>
                                <th>SƒêT</th>
                                <th>M√¥n H·ªçc</th>
                                <th>Tr·∫°ng Th√°i</th>
                                <th>L·ªãch H·∫πn</th>
                                <th>Thao T√°c</th>
                            </tr>
                        </thead>
                        <tbody id="trialStudentsTableBody"></tbody>
                    </table>
                </div>

                <div class="pagination-container" id="trialPagination"></div>
            </div>

            <!-- ==========================================
                 TAB 4: üìÖ L·ªäCH H·∫∏N
            ========================================== -->
            <div id="appointments" class="tab-content">
                <div class="page-header">
                    <h2>üìÖ Qu·∫£n L√Ω L·ªãch H·∫πn</h2>
                    <div class="page-actions">
                        <button class="btn btn-info" onclick="exportAppointmentsToExcel()">üì§ Export Excel</button>
                        <button class="btn btn-success" onclick="openNewAppointmentModal()">‚ûï Th√™m l·ªãch h·∫πn</button>
                    </div>
                </div>

                <div class="filter-bar">
                    <button class="filter-btn active" onclick="filterAppointments('all')">üìã T·∫•t c·∫£</button>
                    <button class="filter-btn" onclick="filterAppointments('upcoming')">‚è∞ S·∫Øp t·ªõi</button>
                    <button class="filter-btn" onclick="filterAppointments('past')">‚úÖ ƒê√£ qua</button>
                    <div class="search-box">
                        <input type="text" id="searchAppointment" placeholder="T√¨m ki·∫øm l·ªãch h·∫πn..." oninput="searchAppointments()">
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>H·ªçc Vi√™n</th>
                                <th>Ph·ª• Huynh</th>
                                <th>SƒêT</th>
                                <th>M√¥n H·ªçc</th>
                                <th>Ng√†y</th>
                                <th>Gi·ªù</th>
                                <th>Tr·∫°ng Th√°i</th>
                                <th>Thao T√°c</th>
                            </tr>
                        </thead>
                        <tbody id="appointmentsTableBody"></tbody>
                    </table>
                </div>

                <div class="pagination-container" id="appointmentsPagination"></div>
            </div>

            <!-- ==========================================
                 TAB 5: üìã PHI·∫æU ƒêƒÇNG K√ù (M·ªöI)
            ========================================== -->
            <div id="registrations" class="tab-content">
                <div class="page-header">
                    <h2>üìã Qu·∫£n L√Ω Phi·∫øu ƒêƒÉng K√Ω</h2>
                    <div class="page-actions">
                        <button class="btn btn-info" onclick="exportRegistrationsToExcel()">üì§ Export Excel</button>
                        <button class="btn btn-success" onclick="openNewRegistrationModal()">‚ûï T·∫°o Phi·∫øu ƒêK</button>
                    </div>
                </div>

                <div class="filter-bar">
                    <div class="search-box">
                        <input type="text" id="searchRegistration" placeholder="T√¨m ki·∫øm phi·∫øu ƒëƒÉng k√Ω..." oninput="searchRegistrations()">
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>M√£ Phi·∫øu</th>
                                <th>H·ªçc Vi√™n</th>
                                <th>M√¥n H·ªçc / G√≥i / H·ªçc Ph√≠</th>
                                <th>Gi·∫£m Gi√°</th>
                                <th>Th√†nh Ti·ªÅn</th>
                                <th>Ng√†y ƒêK</th>
                                <th>Thao T√°c</th>
                            </tr>
                        </thead>

                        <tbody id="registrationsTableBody"></tbody>
                    </table>
                </div>

                <div class="pagination-container" id="registrationsPagination"></div>
            </div>

            <!-- ==========================================
                 TAB 6: üßæ BI√äN LAI
            ========================================== -->
            <div id="receipts" class="tab-content">
                <div class="page-header">
                    <h2>üßæ Qu·∫£n L√Ω Bi√™n Lai</h2>
                    <div class="page-actions">
                        <button class="btn btn-info" onclick="exportReceiptsToExcel()">üì§ Export Excel</button>
                        <button class="btn btn-success" onclick="openReceiptModal()">‚ûï T·∫°o Bi√™n Lai</button>
                    </div>
                </div>

                <div class="filter-bar">
                    <div class="search-box">
                        <input type="text" id="searchReceipt" placeholder="T√¨m ki·∫øm bi√™n lai..." oninput="searchReceipts()">
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>M√£ BL</th>
                                <th>Lo·∫°i</th>
                                <th>H·ªçc Vi√™n</th>
                                <th>N·ªôi Dung</th>
                                <th>S·ªë Ti·ªÅn</th>
                                <th>Ng√†y</th>
                                <th>Thao T√°c</th>
                            </tr>
                        </thead>
                        <tbody id="receiptsTableBody"></tbody>
                    </table>
                </div>

                <div class="pagination-container" id="receiptsPagination"></div>
            </div>

            <!-- ==========================================
                 TAB 7: üìö DANH M·ª§C
            ========================================== -->
            <div id="categories" class="tab-content">
                <div class="page-header">
                    <h2>üìö Qu·∫£n L√Ω Danh M·ª•c</h2>
                </div>

                <div class="category-tabs">
                    <button class="category-tab active" onclick="switchCategoryTab('subjects')">üìñ M√¥n H·ªçc</button>
                    <button class="category-tab" onclick="switchCategoryTab('packages')">üì¶ G√≥i H·ªçc Ph√≠</button>
                    <button class="category-tab" onclick="switchCategoryTab('promotions')">üéÅ Khuy·∫øn M√£i</button>
                </div>

                <!-- Subjects -->
                <div id="subjectsContent" class="category-content active">
                    <div class="d-flex justify-between align-center mb-15">
                        <h3 style="color: #333;">üìñ Danh S√°ch M√¥n H·ªçc</h3>
                        <button class="btn btn-success btn-sm" onclick="openSubjectModal()">‚ûï Th√™m</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Icon</th>
                                    <th>T√™n M√¥n</th>
                                    <th>H·ªçc Ph√≠ M·∫∑c ƒê·ªãnh</th>
                                    <th>Thao T√°c</th>
                                </tr>
                            </thead>
                            <tbody id="subjectsTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Packages -->
                <div id="packagesContent" class="category-content">
                    <div class="d-flex justify-between align-center mb-15">
                        <h3 style="color: #333;">üì¶ Danh S√°ch G√≥i H·ªçc Ph√≠</h3>
                        <button class="btn btn-success btn-sm" onclick="openPackageModal()">‚ûï Th√™m</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>T√™n G√≥i</th>
                                    <th>M√¥n H·ªçc</th>
                                    <th>S·ªë Bu·ªïi</th>
                                    <th>H·ªçc Ph√≠</th>
                                    <th>Thao T√°c</th>
                                </tr>
                            </thead>
                            <tbody id="packagesTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Promotions -->
                <div id="promotionsContent" class="category-content">
                    <div class="d-flex justify-between align-center mb-15">
                        <h3 style="color: #333;">üéÅ Danh S√°ch Khuy·∫øn M√£i</h3>
                        <button class="btn btn-success btn-sm" onclick="openPromotionModal()">‚ûï Th√™m</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>T√™n KM</th>
                                    <th>Lo·∫°i</th>
                                    <th>Gi√° Tr·ªã</th>
                                    <th>Th·ªùi H·∫°n</th>
                                    <th>Tr·∫°ng Th√°i</th>
                                    <th>Thao T√°c</th>
                                </tr>
                            </thead>
                            <tbody id="promotionsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ==========================================
                 TAB 8: üì§ XU·∫§T DATA
            ========================================== -->
            <div id="export" class="tab-content">
                <div class="page-header">
                    <h2>üì§ Xu·∫•t D·ªØ Li·ªáu & Sao L∆∞u</h2>
                </div>

                <div class="settings-group">
                    <h3>üìä Xu·∫•t File Excel</h3>
                    <div class="d-flex gap-10 flex-wrap">
                        <button class="btn btn-success" onclick="exportAllToExcel()">üìä Xu·∫•t T·∫•t C·∫£</button>
                        <button class="btn btn-info" onclick="exportStudentsToExcel()">üë©‚Äçüéì H·ªçc Vi√™n</button>
                        <button class="btn btn-warning" onclick="exportAppointmentsToExcel()">üìÖ L·ªãch H·∫πn</button>
                        <button class="btn btn-primary" onclick="exportRegistrationsToExcel()">üìã Phi·∫øu ƒêK</button>
                        <button class="btn btn-secondary" onclick="exportReceiptsToExcel()">üßæ Bi√™n Lai</button>
                    </div>
                </div>

                <div class="settings-group">
                    <h3>üíæ Sao L∆∞u & Kh√¥i Ph·ª•c</h3>
                    <div class="d-flex gap-10 flex-wrap">
                        <button class="btn btn-success" onclick="exportBackupJSON()">üíæ T·∫£i Backup JSON</button>
                        <label class="btn btn-info" style="cursor: pointer;">
                            üìÅ Kh√¥i Ph·ª•c JSON
                            <input type="file" accept=".json" onchange="restoreFromJSON(event)" style="display: none;">
                        </label>
                        <label class="btn btn-warning" style="cursor: pointer;">
                            üì• Import Excel
                            <input type="file" accept=".xlsx,.xls" onchange="importFromExcel(event)" style="display: none;">
                        </label>
                    </div>
                </div>

                <div class="settings-group">
                    <h3>üìú L·ªãch S·ª≠ Backup T·ª± ƒê·ªông</h3>
                    <div id="backupHistoryList"></div>
                </div>
            </div>

            <!-- ==========================================
                 TAB 9: ‚öôÔ∏è C√ÄI ƒê·∫∂T
            ========================================== -->
            <div id="settings" class="tab-content">
                <div class="page-header">
                    <h2>‚öôÔ∏è C√†i ƒê·∫∑t H·ªá Th·ªëng</h2>
                </div>

                <div class="settings-group">
                    <h3>üè¢ Th√¥ng Tin Trung T√¢m</h3>
                    <form id="centerInfoForm" onsubmit="saveCenterInfo(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>T√™n Trung T√¢m *</label>
                                <input type="text" id="centerName" placeholder="VD: Trung T√¢m ABC">
                            </div>
                            <div class="form-group">
                                <label>S·ªë ƒêi·ªán Tho·∫°i *</label>
                                <input type="tel" id="centerPhone" placeholder="VD: 0912345678">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>ƒê·ªãa Ch·ªâ *</label>
                            <input type="text" id="centerAddress" placeholder="VD: 123 ƒê∆∞·ªùng ABC">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="centerEmail" placeholder="VD: contact@abc.edu.vn">
                            </div>
                            <div class="form-group">
                                <label>Website</label>
                                <input type="url" id="centerWebsite" placeholder="VD: https://abc.edu.vn">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Logo</label>
                            <input type="file" id="centerLogo" accept="image/*" onchange="previewLogo(event)">
                            <div class="logo-preview" id="logoPreview">
                                <span class="text-muted">Logo</span>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">üíæ L∆∞u</button>
                    </form>
                </div>

                <div class="settings-group">
                    <h3>üí≥ Th√¥ng Tin Ng√¢n H√†ng</h3>
                    <form id="bankInfoForm" onsubmit="saveBankInfo(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>T√™n Ng√¢n H√†ng *</label>
                                <input type="text" id="bankName" placeholder="VD: Vietcombank">
                            </div>
                            <div class="form-group">
                                <label>S·ªë T√†i Kho·∫£n *</label>
                                <input type="text" id="bankAccount" placeholder="VD: 1234567890">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Ch·ªß T√†i Kho·∫£n *</label>
                                <input type="text" id="bankAccountName" placeholder="VD: NGUYEN VAN A">
                            </div>
                            <div class="form-group">
                                <label>Chi Nh√°nh</label>
                                <input type="text" id="bankBranch" placeholder="VD: Chi nh√°nh T√¢n B√¨nh">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">üíæ L∆∞u</button>
                    </form>
                    <div class="mt-15">
                        <h4 style="font-size: 0.95em; margin-bottom: 10px;">QR Chuy·ªÉn Kho·∫£n:</h4>
                        <div id="bankQRCode"></div>
                    </div>
                </div>

                <div class="settings-group">
                    <h3>üîÑ Sao L∆∞u T·ª± ƒê·ªông</h3>
                    <div class="d-flex align-center gap-15">
                        <label class="d-flex align-center gap-10" style="cursor: pointer;">
                            <input type="checkbox" id="autoBackupToggle" onchange="toggleAutoBackup()">
                            <span>B·∫≠t sao l∆∞u t·ª± ƒë·ªông</span>
                        </label>
                        <span id="autoBackupStatus" class="text-muted"></span>
                    </div>
                </div>

                <div class="settings-group">
                    <h3>üóëÔ∏è X√≥a D·ªØ Li·ªáu</h3>
                    <p class="text-muted mb-15" style="font-size: 0.9em;">‚ö†Ô∏è H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</p>
                    <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è X√≥a To√†n B·ªô</button>
                </div>
            </div>

        </div><!-- End .content -->
    </div><!-- End .container -->

    <!-- ==========================================
         üîî MODALS
    ========================================== -->
    
    <!-- Quick View Modal -->
    <div id="quickViewModal" class="modal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2>üëÅÔ∏è Th√¥ng Tin Chi Ti·∫øt</h2>
                <button class="modal-close" onclick="closeModal('quickViewModal')">&times;</button>
            </div>
            <div id="quickViewContent"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('quickViewModal')">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- Appointment Modal -->
    <div id="appointmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="appointmentModalTitle">üìÖ ƒê·∫∑t L·ªãch H·∫πn</h2>
                <button class="modal-close" onclick="closeModal('appointmentModal')">&times;</button>
            </div>
            <form id="appointmentForm" onsubmit="saveAppointment(event)">
                <input type="hidden" id="appointmentStudentId">
                <input type="hidden" id="editAppointmentId">
                
                <div class="form-group">
                    <label>H·ªçc Vi√™n *</label>
                    <div class="searchable-select" id="appointmentStudentSelect">
                        <input type="text" class="searchable-select-input" id="appointmentStudentInput" 
                               placeholder="-- Ch·ªçn ho·∫∑c t√¨m h·ªçc vi√™n --" readonly onclick="toggleStudentDropdown()">
                        <div class="searchable-select-dropdown" id="appointmentStudentDropdown">
                            <div class="searchable-select-search">
                                <input type="text" id="appointmentStudentSearch" placeholder="T√¨m ki·∫øm..." oninput="filterStudentDropdown()">
                            </div>
                            <div id="appointmentStudentOptions"></div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>M√¥n H·ªçc *</label>
                    <select id="appointmentSubject" required>
                        <option value="">-- Ch·ªçn m√¥n h·ªçc --</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Ng√†y H·∫πn *</label>
                        <input type="date" id="appointmentDate" required>
                    </div>
                    <div class="form-group">
                        <label>Gi·ªù H·∫πn *</label>
                        <input type="time" id="appointmentTime" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Ghi Ch√∫</label>
                    <textarea id="appointmentNotes" rows="2" placeholder="Ghi ch√∫"></textarea>
                </div>
                
                <div id="appointmentConflictWarning" class="hidden" style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ffc107; font-size: 0.9em;"></div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('appointmentModal')">H·ªßy</button>
                    <button type="submit" class="btn btn-success">üíæ L∆∞u</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Registration Modal (Phi·∫øu ƒêƒÉng K√Ω) -->
    <div id="registrationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìã T·∫°o Phi·∫øu ƒêƒÉng K√Ω</h2>
                <button class="modal-close" onclick="closeModal('registrationModal')">&times;</button>
            </div>
            <form id="registrationForm" onsubmit="saveRegistration(event)">
                <input type="hidden" id="regStudentId">
                
                <div class="form-group">
                    <label>H·ªçc Vi√™n *</label>
                    <div class="searchable-select" id="regStudentSelect">
                        <input type="text" class="searchable-select-input" id="regStudentInput" 
                               placeholder="-- Ch·ªçn ho·∫∑c t√¨m h·ªçc vi√™n --" readonly onclick="toggleRegStudentDropdown()">
                        <div class="searchable-select-dropdown" id="regStudentDropdown">
                            <div class="searchable-select-search">
                                <input type="text" id="regStudentSearch" placeholder="T√¨m ki·∫øm..." oninput="filterRegStudentDropdown()">
                            </div>
                            <div id="regStudentOptions"></div>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>M√¥n H·ªçc *</label>
                        <select id="regSubject" required onchange="loadPackagesForSubject()">
                            <option value="">-- Ch·ªçn m√¥n --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>G√≥i H·ªçc Ph√≠</label>
                        <select id="regPackage" onchange="applyPackageFee()">
                            <option value="">-- Nh·∫≠p th·ªß c√¥ng --</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>H·ªçc Ph√≠ (VNƒê) *</label>
                    <input type="text" id="regTuitionFee" required placeholder="VD: 2,000,000" oninput="formatCurrencyInput(this); calculateFinalAmount()">
                </div>
                
                <div class="form-group">
                    <label>Khuy·∫øn M√£i</label>
                    <div id="regPromotionList" class="checkbox-group"></div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Gi·∫£m Gi√°</label>
                        <input type="text" id="regDiscountAmount" readonly style="background: #ffebee; color: #c62828; font-weight: 600;">
                    </div>
                    <div class="form-group">
                        <label>Th√†nh Ti·ªÅn</label>
                        <input type="text" id="regFinalAmount" readonly style="background: #e8f5e9; color: #388e3c; font-weight: 600;">
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('registrationModal')">H·ªßy</button>
                    <button type="submit" class="btn btn-success">‚úÖ T·∫°o Phi·∫øu ƒêK</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Registration Modal -->
    <div id="viewRegistrationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìã Chi Ti·∫øt Phi·∫øu ƒêƒÉng K√Ω</h2>
                <button class="modal-close" onclick="closeModal('viewRegistrationModal')">&times;</button>
            </div>
            <div id="registrationPreviewContent" class="print-area"></div>
            <div class="modal-footer">
                <button class="btn btn-info" onclick="printRegistration()">üñ®Ô∏è In</button>
                <button class="btn btn-primary" onclick="downloadRegistrationPDF()">üìÑ T·∫£i PDF</button>
                <button class="btn btn-secondary" onclick="closeModal('viewRegistrationModal')">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receiptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üßæ T·∫°o Bi√™n Lai</h2>
                <button class="modal-close" onclick="closeModal('receiptModal')">&times;</button>
            </div>
            <form id="receiptForm" onsubmit="saveReceipt(event)">
                <input type="hidden" id="editReceiptId">
                
                <div class="form-group">
                    <label>Lo·∫°i *</label>
                    <select id="receiptType" required>
                        <option value="">-- Ch·ªçn lo·∫°i --</option>
                        <option value="Bi√™n Lai ƒêi·ªán T·ª≠">üí≥ Bi√™n Lai ƒêi·ªán T·ª≠</option>
                        <option value="Phi·∫øu Thu">üíµ Phi·∫øu Thu</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>H·ªçc Vi√™n * (ch·ªâ HV "ƒê√£ ƒêƒÉng K√Ω")</label>
                    <select id="receiptStudentId" required onchange="fillReceiptStudentInfo()">
                        <option value="">-- Ch·ªçn h·ªçc vi√™n --</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Ph·ª• Huynh</label>
                        <input type="text" id="receiptParentName" readonly style="background: #f8f9fa;">
                    </div>
                    <div class="form-group">
                        <label>SƒêT</label>
                        <input type="text" id="receiptParentPhone" readonly style="background: #f8f9fa;">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>N·ªôi Dung *</label>
                    <input type="text" id="receiptDescription" required placeholder="VD: H·ªçc ph√≠ th√°ng 1">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>S·ªë Ti·ªÅn (VNƒê) *</label>
                        <input type="text" id="receiptAmount" required placeholder="VD: 2,000,000" oninput="formatCurrencyInput(this)">
                    </div>
                    <div class="form-group">
                        <label>Ng√†y *</label>
                        <input type="date" id="receiptDate" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Ghi Ch√∫</label>
                    <textarea id="receiptNotes" rows="2" placeholder="Ghi ch√∫"></textarea>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('receiptModal')">H·ªßy</button>
                    <button type="submit" class="btn btn-success">üíæ L∆∞u</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Receipt Modal -->
    <div id="viewReceiptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üßæ Xem Bi√™n Lai</h2>
                <button class="modal-close" onclick="closeModal('viewReceiptModal')">&times;</button>
            </div>
            <div id="receiptPreviewContent" class="print-area"></div>
            <div class="modal-footer">
                <button class="btn btn-info" onclick="printReceipt()">üñ®Ô∏è In</button>
                <button class="btn btn-primary" onclick="downloadReceiptPDF()">üìÑ T·∫£i PDF</button>
                <button class="btn btn-secondary" onclick="closeModal('viewReceiptModal')">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- Subject Modal -->
    <div id="subjectModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h2 id="subjectModalTitle">üìñ Th√™m M√¥n H·ªçc</h2>
                <button class="modal-close" onclick="closeModal('subjectModal')">&times;</button>
            </div>
            <form id="subjectForm" onsubmit="saveSubject(event)">
                <input type="hidden" id="editSubjectId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Icon *</label>
                        <input type="text" id="subjectIcon" required placeholder="VD: ‚ôüÔ∏è">
                    </div>
                    <div class="form-group">
                        <label>T√™n M√¥n *</label>
                        <input type="text" id="subjectName" required placeholder="VD: C·ªù Vua">
                    </div>
                </div>
                <div class="form-group">
                    <label>H·ªçc Ph√≠ M·∫∑c ƒê·ªãnh *</label>
                    <input type="text" id="subjectDefaultFee" required placeholder="VD: 2,000,000" oninput="formatCurrencyInput(this)">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('subjectModal')">H·ªßy</button>
                    <button type="submit" class="btn btn-success">üíæ L∆∞u</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Package Modal -->
    <div id="packageModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h2 id="packageModalTitle">üì¶ Th√™m G√≥i H·ªçc Ph√≠</h2>
                <button class="modal-close" onclick="closeModal('packageModal')">&times;</button>
            </div>
            <form id="packageForm" onsubmit="savePackage(event)">
                <input type="hidden" id="editPackageId">
                <div class="form-group">
                    <label>T√™n G√≥i *</label>
                    <input type="text" id="packageName" required placeholder="VD: G√≥i C∆° B·∫£n">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>M√¥n H·ªçc *</label>
                        <select id="packageSubject" required></select>
                    </div>
                    <div class="form-group">
                        <label>S·ªë Bu·ªïi *</label>
                        <input type="number" id="packageSessions" required min="1" placeholder="VD: 8">
                    </div>
                </div>
                <div class="form-group">
                    <label>H·ªçc Ph√≠ *</label>
                    <input type="text" id="packageFee" required placeholder="VD: 1,600,000" oninput="formatCurrencyInput(this)">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('packageModal')">H·ªßy</button>
                    <button type="submit" class="btn btn-success">üíæ L∆∞u</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Promotion Modal -->
    <div id="promotionModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h2 id="promotionModalTitle">üéÅ Th√™m Khuy·∫øn M√£i</h2>
                <button class="modal-close" onclick="closeModal('promotionModal')">&times;</button>
            </div>
            <form id="promotionForm" onsubmit="savePromotion(event)">
                <input type="hidden" id="editPromotionId">
                <div class="form-group">
                    <label>T√™n KM *</label>
                    <input type="text" id="promotionName" required placeholder="VD: KM Khai Tr∆∞∆°ng">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Lo·∫°i *</label>
                        <select id="promotionType" required>
                            <option value="percent">Gi·∫£m %</option>
                            <option value="fixed">Gi·∫£m VNƒê</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Gi√° Tr·ªã *</label>
                        <input type="number" id="promotionValue" required min="0" placeholder="VD: 10">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>T·ª´ Ng√†y *</label>
                        <input type="date" id="promotionStartDate" required>
                    </div>
                    <div class="form-group">
                        <label>ƒê·∫øn Ng√†y *</label>
                        <input type="date" id="promotionEndDate" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('promotionModal')">H·ªßy</button>
                    <button type="submit" class="btn btn-success">üíæ L∆∞u</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <!-- ==========================================
         üìú JAVASCRIPT
    ========================================== -->
    <script>
// ==========================================
// üìä DATA STORAGE
// ==========================================
let students = JSON.parse(localStorage.getItem('students')) || [];
let appointments = JSON.parse(localStorage.getItem('appointments')) || [];
let receipts = JSON.parse(localStorage.getItem('receipts')) || [];
let registrations = JSON.parse(localStorage.getItem('registrations')) || [];
let subjects = JSON.parse(localStorage.getItem('subjects')) || [
    { id: '1', icon: '‚ôüÔ∏è', name: 'C·ªù Vua', defaultFee: 2000000 },
    { id: '2', icon: 'üé®', name: 'V·∫Ω Tranh', defaultFee: 1800000 },
    { id: '3', icon: 'üìö', name: 'Ti·ªÅn Ti·ªÉu H·ªçc', defaultFee: 1500000 },
    { id: '4', icon: '‚úçÔ∏è', name: 'R√®n Ch·ªØ', defaultFee: 1600000 }
];
let packages = JSON.parse(localStorage.getItem('packages')) || [];
let promotions = JSON.parse(localStorage.getItem('promotions')) || [];
let centerInfo = JSON.parse(localStorage.getItem('centerInfo')) || {};
let bankInfo = JSON.parse(localStorage.getItem('bankInfo')) || {};
let backupHistory = JSON.parse(localStorage.getItem('backupHistory')) || [];
let autoBackupEnabled = localStorage.getItem('autoBackupEnabled') === 'true';

// ==========================================
// üìÑ PAGINATION STATE
// ==========================================
const PAGE_SIZE_OPTIONS = [10, 20, 50, 100];
let paginationState = {
    students: { page: 1, pageSize: 10 },
    trial: { page: 1, pageSize: 10 },
    appointments: { page: 1, pageSize: 10 },
    registrations: { page: 1, pageSize: 10 },
    receipts: { page: 1, pageSize: 10 }
};

// ==========================================
// üîç FILTER STATE
// ==========================================
let currentFilter = 'all';
let currentTrialFilter = 'all';
let currentAppointmentFilter = 'all';

// ==========================================
// üöÄ KH·ªûI T·∫†O
// ==========================================
document.addEventListener('DOMContentLoaded', function() {
    migrateOldData();
    renderAll();
    loadCenterInfo();
    loadBankInfo();
    updateAutoBackupStatus();
    renderSubjectCheckboxes();
    
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('appointmentDate').min = today;
    document.getElementById('receiptDate').value = today;
    document.getElementById('autoBackupToggle').checked = autoBackupEnabled;
    
    // Close dropdown when click outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.searchable-select')) {
            document.querySelectorAll('.searchable-select-dropdown').forEach(d => d.classList.remove('show'));
        }
    });
});

function migrateOldData() {
    let needSave = false;
    students.forEach(student => {
        if (!student.status) { student.status = 'H·ªçc Th·ª≠'; needSave = true; }
        if (student.previousStatus === undefined) { student.previousStatus = null; needSave = true; }
        if (!student.registrations) { student.registrations = []; needSave = true; }
    });
    if (needSave) saveData('students', students);
    
    // Migrate registrations t·ª´ students sang array ri√™ng
    if (registrations.length === 0) {
        students.forEach(student => {
            if (student.registrations && student.registrations.length > 0) {
                student.registrations.forEach(reg => {
                    registrations.push({ ...reg, studentId: student.id });
                });
            }
        });
        if (registrations.length > 0) saveData('registrations', registrations);
    }
}

// ==========================================
// üíæ DATA HELPERS
// ==========================================
function saveData(key, data) {
    localStorage.setItem(key, JSON.stringify(data));
    if (autoBackupEnabled) createAutoBackup();
}

function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
}

function generateRegCode() {
    const date = new Date();
    const y = date.getFullYear().toString().slice(2);
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    const rand = Math.random().toString(36).substr(2, 4).toUpperCase();
    return `DK${y}${m}${d}-${rand}`;
}

// ==========================================
// üìë TAB NAVIGATION
// ==========================================
function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');
    event.target.classList.add('active');
    
    switch(tabName) {
        case 'dashboard': renderDashboard(); break;
        case 'students': renderStudentsTable(); updateStudentCounts(); break;
        case 'trial': renderTrialStudentsTable(); updateTrialCounts(); break;
        case 'appointments': renderAppointmentsTable(); break;
        case 'registrations': renderRegistrationsTable(); break;
        case 'receipts': renderReceiptsTable(); break;
        case 'categories': renderSubjectsTable(); break;
        case 'export': renderBackupHistory(); break;
        case 'settings': loadCenterInfo(); loadBankInfo(); break;
    }
}

function switchCategoryTab(tabName) {
    document.querySelectorAll('.category-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
    document.getElementById(tabName + 'Content').classList.add('active');
    event.target.classList.add('active');
    
    switch(tabName) {
        case 'subjects': renderSubjectsTable(); break;
        case 'packages': renderPackagesTable(); break;
        case 'promotions': renderPromotionsTable(); break;
    }
}

// ==========================================
// üîî NOTIFICATIONS
// ==========================================
function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
    notification.className = `notification ${type} show`;
    notification.innerHTML = `<span>${icons[type]}</span><span>${message}</span>`;
    setTimeout(() => notification.classList.remove('show'), 3000);
}

// ==========================================
// üî≤ MODAL HELPERS
// ==========================================
function openModal(modalId) { document.getElementById(modalId).classList.add('active'); }
function closeModal(modalId) { document.getElementById(modalId).classList.remove('active'); }

// ==========================================
// üìÑ PAGINATION HELPERS
// ==========================================
function getPaginatedData(data, tabKey) {
    const state = paginationState[tabKey];
    const start = (state.page - 1) * state.pageSize;
    const end = start + state.pageSize;
    return {
        data: data.slice(start, end),
        total: data.length,
        totalPages: Math.ceil(data.length / state.pageSize),
        currentPage: state.page,
        pageSize: state.pageSize
    };
}

function renderPagination(containerId, tabKey, totalItems, totalPages, currentPage) {
    const container = document.getElementById(containerId);
    if (totalItems === 0) {
        container.innerHTML = '';
        return;
    }
    
    const state = paginationState[tabKey];
    const start = (currentPage - 1) * state.pageSize + 1;
    const end = Math.min(currentPage * state.pageSize, totalItems);
    
    let pagesHtml = '';
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    for (let i = startPage; i <= endPage; i++) {
        pagesHtml += `<button class="${i === currentPage ? 'active' : ''}" onclick="goToPage('${tabKey}', ${i})">${i}</button>`;
    }
    
    container.innerHTML = `
        <div class="pagination-info">Hi·ªÉn th·ªã ${start}-${end} / ${totalItems}</div>
        <div class="pagination">
            <button onclick="goToPage('${tabKey}', 1)" ${currentPage === 1 ? 'disabled' : ''}>¬´</button>
            <button onclick="goToPage('${tabKey}', ${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>‚Äπ</button>
            ${pagesHtml}
            <button onclick="goToPage('${tabKey}', ${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>‚Ä∫</button>
            <button onclick="goToPage('${tabKey}', ${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>¬ª</button>
        </div>
        <div class="page-size-select">
            <span>Hi·ªÉn th·ªã:</span>
            <select onchange="changePageSize('${tabKey}', this.value)">
                ${PAGE_SIZE_OPTIONS.map(size => `<option value="${size}" ${size === state.pageSize ? 'selected' : ''}>${size}</option>`).join('')}
            </select>
        </div>
    `;
}

function goToPage(tabKey, page) {
    const totalPages = Math.ceil(getFilteredData(tabKey).length / paginationState[tabKey].pageSize);
    if (page < 1 || page > totalPages) return;
    paginationState[tabKey].page = page;
    renderTabTable(tabKey);
}

function changePageSize(tabKey, size) {
    paginationState[tabKey].pageSize = parseInt(size);
    paginationState[tabKey].page = 1;
    renderTabTable(tabKey);
}

function getFilteredData(tabKey) {
    switch(tabKey) {
        case 'students': return getFilteredStudents();
        case 'trial': return getFilteredTrialStudents();
        case 'appointments': return getFilteredAppointments();
        case 'registrations': return getFilteredRegistrations();
        case 'receipts': return getFilteredReceipts();
        default: return [];
    }
}

function renderTabTable(tabKey) {
    switch(tabKey) {
        case 'students': renderStudentsTable(); break;
        case 'trial': renderTrialStudentsTable(); break;
        case 'appointments': renderAppointmentsTable(); break;
        case 'registrations': renderRegistrationsTable(); break;
        case 'receipts': renderReceiptsTable(); break;
    }
}

// ==========================================
// üìä DASHBOARD
// ==========================================
function renderDashboard() {
    renderDashboardStats();
    renderRevenueChart();
    renderUpcomingAppointments();
}

function renderDashboardStats() {
    const stats = {
        total: students.length,
        hocThu: students.filter(s => s.status === 'H·ªçc Th·ª≠').length,
        choDangKy: students.filter(s => s.status === 'Ch·ªù ƒêƒÉng K√Ω').length,
        daDangKy: students.filter(s => s.status === 'ƒê√£ ƒêƒÉng K√Ω').length,
        hoanThanh: students.filter(s => s.status === 'Ho√†n Th√†nh').length,
        cancel: students.filter(s => s.status === 'Cancel').length,
        totalRevenue: receipts.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0)
    };
    
    document.getElementById('dashboardStats').innerHTML = `
        <div class="stat-card"><h3>${stats.total}</h3><p>üìã T·ªïng HV</p></div>
        <div class="stat-card stat-hoc-thu"><h3>${stats.hocThu}</h3><p>üÜï H·ªçc Th·ª≠</p></div>
        <div class="stat-card stat-cho-dang-ky"><h3>${stats.choDangKy}</h3><p>‚è≥ Ch·ªù ƒêK</p></div>
        <div class="stat-card stat-da-dang-ky"><h3>${stats.daDangKy}</h3><p>‚úÖ ƒê√£ ƒêK</p></div>
        <div class="stat-card stat-hoan-thanh"><h3>${stats.hoanThanh}</h3><p>üéì Ho√†n Th√†nh</p></div>
        <div class="stat-card stat-revenue"><h3>${formatCurrencyShort(stats.totalRevenue)}</h3><p>üí∞ Doanh Thu</p></div>
    `;
}

function renderRevenueChart() {
    const months = [];
    const now = new Date();
    for (let i = 5; i >= 0; i--) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        months.push({ key: `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`, label: `T${d.getMonth() + 1}` });
    }
    
    const monthlyRevenue = {};
    months.forEach(m => monthlyRevenue[m.key] = 0);
    receipts.forEach(r => {
        const month = r.date?.substring(0, 7);
        if (monthlyRevenue[month] !== undefined) monthlyRevenue[month] += parseFloat(r.amount) || 0;
    });
    
    const maxRevenue = Math.max(...Object.values(monthlyRevenue), 1);
    document.getElementById('revenueChart').innerHTML = months.map(m => {
        const revenue = monthlyRevenue[m.key];
        const height = (revenue / maxRevenue) * 100;
        return `<div class="chart-bar-wrapper"><div class="chart-bar" style="height:${Math.max(height, 5)}%;"><span class="chart-bar-value">${formatCurrencyShort(revenue)}</span></div><span class="chart-bar-label">${m.label}</span></div>`;
    }).join('');
}

function renderUpcomingAppointments() {
    const now = new Date();
    const upcoming = appointments.filter(a => new Date(a.date + ' ' + a.time) >= now)
        .sort((a, b) => new Date(a.date + ' ' + a.time) - new Date(b.date + ' ' + b.time)).slice(0, 5);
    
    document.getElementById('upcomingAppointments').innerHTML = upcoming.length === 0 
        ? '<div class="empty-state"><p class="text-muted">Ch∆∞a c√≥ l·ªãch h·∫πn s·∫Øp t·ªõi</p></div>'
        : upcoming.map(apt => {
            const student = students.find(s => s.id === apt.studentId);
            return `<div class="upcoming-item"><strong>${student?.name || 'N/A'}</strong> - ${apt.subject}<br>üìÖ ${formatDate(apt.date)} l√∫c ${apt.time} | üìû ${student?.parentPhone || ''}</div>`;
        }).join('');
}

// ==========================================
// üë©‚Äçüéì STUDENTS
// ==========================================
function renderSubjectCheckboxes() {
    document.getElementById('subjectCheckboxes').innerHTML = subjects.map(sub => 
        `<label class="checkbox-item"><input type="checkbox" name="studentSubjects" value="${sub.name}"> ${sub.icon} ${sub.name}</label>`
    ).join('');
}

function toggleStudentForm() {
    const form = document.getElementById('studentFormSection');
    form.classList.toggle('show');
    if (form.classList.contains('show')) {
        resetStudentForm();
        form.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

function resetStudentForm() {
    document.getElementById('studentForm').reset();
    document.getElementById('editStudentId').value = '';
    document.getElementById('studentStatus').value = 'H·ªçc Th·ª≠';
    document.getElementById('studentFormTitle').textContent = '‚ûï Th√™m H·ªçc Vi√™n M·ªõi';
    document.getElementById('saveStudentBtn').textContent = 'üíæ L∆∞u H·ªçc Vi√™n';
    document.querySelectorAll('input[name="studentSubjects"]').forEach(cb => cb.checked = false);
}

function saveStudent(event) {
    event.preventDefault();
    
    const selectedSubjects = Array.from(document.querySelectorAll('input[name="studentSubjects"]:checked')).map(cb => cb.value);
    if (selectedSubjects.length === 0) { showNotification('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 m√¥n h·ªçc!', 'error'); return; }
    
    const editId = document.getElementById('editStudentId').value;
    const studentData = {
        name: document.getElementById('studentName').value.trim(),
        age: parseInt(document.getElementById('studentAge').value),
        parentName: document.getElementById('parentName').value.trim(),
        parentPhone: document.getElementById('parentPhone').value.trim(),
        parentEmail: document.getElementById('parentEmail').value.trim(),
        status: document.getElementById('studentStatus').value,
        subjects: selectedSubjects,
        notes: document.getElementById('studentNotes').value.trim()
    };
    
    if (!editId) {
        const duplicate = students.find(s => normalizePhone(s.parentPhone) === normalizePhone(studentData.parentPhone));
        if (duplicate && !confirm(`‚ö†Ô∏è SƒêT ƒë√£ t·ªìn t·∫°i!\nH·ªçc vi√™n: ${duplicate.name}\nB·∫°n v·∫´n mu·ªën th√™m?`)) return;
    }
    
    if (editId) {
        const index = students.findIndex(s => s.id === editId);
        if (index !== -1) {
            students[index] = { ...students[index], ...studentData, updatedAt: new Date().toISOString() };
            showNotification('C·∫≠p nh·∫≠t th√†nh c√¥ng!');
        }
    } else {
        students.push({ id: generateId(), ...studentData, previousStatus: null, registrations: [], createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() });
        showNotification('Th√™m h·ªçc vi√™n th√†nh c√¥ng!');
    }
    
    saveData('students', students);
    document.getElementById('studentFormSection').classList.remove('show');
    resetStudentForm();
    renderStudentsTable();
    updateStudentCounts();
    renderDashboard();
}

function editStudent(id) {
    const student = students.find(s => s.id === id);
    if (!student) return;
    
    document.getElementById('editStudentId').value = student.id;
    document.getElementById('studentName').value = student.name;
    document.getElementById('studentAge').value = student.age;
    document.getElementById('parentName').value = student.parentName;
    document.getElementById('parentPhone').value = student.parentPhone;
    document.getElementById('parentEmail').value = student.parentEmail || '';
    document.getElementById('studentStatus').value = student.status;
    document.getElementById('studentNotes').value = student.notes || '';
    document.querySelectorAll('input[name="studentSubjects"]').forEach(cb => cb.checked = student.subjects.includes(cb.value));
    
    document.getElementById('studentFormTitle').textContent = '‚úèÔ∏è S·ª≠a H·ªçc Vi√™n';
    document.getElementById('saveStudentBtn').textContent = 'üíæ C·∫≠p Nh·∫≠t';
    document.getElementById('studentFormSection').classList.add('show');
    document.getElementById('studentFormSection').scrollIntoView({ behavior: 'smooth' });
}

function deleteStudent(id) {
    const student = students.find(s => s.id === id);
    if (!student || !confirm(`X√≥a "${student.name}"?\nT·∫•t c·∫£ d·ªØ li·ªáu li√™n quan s·∫Ω b·ªã x√≥a!`)) return;
    
    students = students.filter(s => s.id !== id);
    appointments = appointments.filter(a => a.studentId !== id);
    registrations = registrations.filter(r => r.studentId !== id);
    receipts = receipts.filter(r => r.studentId !== id);
    
    saveData('students', students);
    saveData('appointments', appointments);
    saveData('registrations', registrations);
    saveData('receipts', receipts);
    
    showNotification('ƒê√£ x√≥a!');
    renderAll();
}

function updateStudentCounts() {
    document.getElementById('countAll').textContent = students.length;
    document.getElementById('countHocThu').textContent = students.filter(s => s.status === 'H·ªçc Th·ª≠').length;
    document.getElementById('countChoDangKy').textContent = students.filter(s => s.status === 'Ch·ªù ƒêƒÉng K√Ω').length;
    document.getElementById('countDaDangKy').textContent = students.filter(s => s.status === 'ƒê√£ ƒêƒÉng K√Ω').length;
    document.getElementById('countHoanThanh').textContent = students.filter(s => s.status === 'Ho√†n Th√†nh').length;
    document.getElementById('countCancel').textContent = students.filter(s => s.status === 'Cancel').length;
}

function filterStudents(status) {
    currentFilter = status;
    paginationState.students.page = 1;
    document.querySelectorAll('#students .filter-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.filter === status));
    renderStudentsTable();
}

function searchStudents() {
    paginationState.students.page = 1;
    renderStudentsTable();
}

function getFilteredStudents() {
    const searchTerm = document.getElementById('searchStudent')?.value?.toLowerCase() || '';
    let filtered = students;
    if (currentFilter !== 'all') filtered = filtered.filter(s => s.status === currentFilter);
    if (searchTerm) filtered = filtered.filter(s => s.name.toLowerCase().includes(searchTerm) || s.parentName.toLowerCase().includes(searchTerm) || s.parentPhone.includes(searchTerm));
    return filtered;
}

function renderStudentsTable() {
    const filtered = getFilteredStudents();
    const { data, total, totalPages, currentPage } = getPaginatedData(filtered, 'students');
    const tbody = document.getElementById('studentsTableBody');
    
    if (data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">üìã</div><p>Kh√¥ng c√≥ d·ªØ li·ªáu</p></div></td></tr>`;
        renderPagination('studentsPagination', 'students', 0, 0, 1);
        return;
    }
    
    tbody.innerHTML = data.map(s => `
        <tr>
            <td><strong>${s.name}</strong></td>
            <td>${s.age}</td>
            <td>${s.parentName}</td>
            <td>${s.parentPhone}</td>
            <td>${s.subjects.map(sub => `<span class="subject-tag">${sub}</span>`).join('')}</td>
            <td>${getStatusBadge(s.status)}</td>
            <td><div class="action-buttons">${getActionButtons(s)}</div></td>
        </tr>
    `).join('');
    
    renderPagination('studentsPagination', 'students', total, totalPages, currentPage);
}

function getStatusBadge(status) {
    const badges = {
        'H·ªçc Th·ª≠': '<span class="status-badge status-hoc-thu">üÜï H·ªçc Th·ª≠</span>',
        'Ch·ªù ƒêƒÉng K√Ω': '<span class="status-badge status-cho-dang-ky">‚è≥ Ch·ªù ƒêK</span>',
        'ƒê√£ ƒêƒÉng K√Ω': '<span class="status-badge status-da-dang-ky">‚úÖ ƒê√£ ƒêK</span>',
        'Ho√†n Th√†nh': '<span class="status-badge status-hoan-thanh">üéì Ho√†n Th√†nh</span>',
        'Cancel': '<span class="status-badge status-cancel">‚ùå Cancel</span>'
    };
    return badges[status] || status;
}

function getActionButtons(student) {
    const id = student.id;
    let btns = [`<button class="action-btn action-btn-view" onclick="viewStudent('${id}')" title="Xem">üëÅÔ∏è</button>`];
    
    switch(student.status) {
        case 'H·ªçc Th·ª≠':
            btns.push(`<button class="action-btn action-btn-schedule" onclick="openAppointmentModalForStudent('${id}')" title="ƒê·∫∑t l·ªãch">üìÖ</button>`);
            btns.push(`<button class="action-btn action-btn-edit" onclick="editStudent('${id}')" title="S·ª≠a">‚úèÔ∏è</button>`);
            btns.push(`<button class="action-btn action-btn-delete" onclick="deleteStudent('${id}')" title="X√≥a">üóëÔ∏è</button>`);
            break;
        case 'Ch·ªù ƒêƒÉng K√Ω':
            btns.push(`<button class="action-btn action-btn-reg" onclick="openRegistrationModalForStudent('${id}')" title="T·∫°o Phi·∫øu ƒêK">üìã</button>`);
            btns.push(`<button class="action-btn action-btn-cancel" onclick="cancelStudent('${id}')" title="Cancel">‚ùå</button>`);
            btns.push(`<button class="action-btn action-btn-edit" onclick="editStudent('${id}')" title="S·ª≠a">‚úèÔ∏è</button>`);
            break;
        case 'ƒê√£ ƒêƒÉng K√Ω':
            btns.push(`<button class="action-btn action-btn-receipt" onclick="openReceiptModalForStudent('${id}')" title="T·∫°o Bi√™n Lai">üßæ</button>`);
            btns.push(`<button class="action-btn action-btn-edit" onclick="editStudent('${id}')" title="S·ª≠a">‚úèÔ∏è</button>`);
            break;
        case 'Ho√†n Th√†nh':
            btns.push(`<button class="action-btn action-btn-receipt" onclick="viewStudentReceipts('${id}')" title="Xem BL">üßæ</button>`);
            break;
        case 'Cancel':
            btns.push(`<button class="action-btn action-btn-edit" onclick="editStudent('${id}')" title="S·ª≠a">‚úèÔ∏è</button>`);
            btns.push(`<button class="action-btn action-btn-restore" onclick="restoreStudent('${id}')" title="Kh√¥i ph·ª•c">üîÑ</button>`);
            break;
    }
    return btns.join('');
}

// ==========================================
// üëÅÔ∏è QUICK VIEW
// ==========================================
function viewStudent(id) {
    const student = students.find(s => s.id === id);
    if (!student) return;
    
    const studentAppointments = appointments.filter(a => a.studentId === id);
    const studentRegistrations = registrations.filter(r => r.studentId === id);
    const studentReceipts = receipts.filter(r => r.studentId === id);
    
    document.getElementById('quickViewContent').innerHTML = `
        <div class="quick-view-section">
            <h4>üë§ Th√¥ng Tin</h4>
            <div class="quick-view-row"><span class="quick-view-label">T√™n:</span><span class="quick-view-value"><strong>${student.name}</strong></span></div>
            <div class="quick-view-row"><span class="quick-view-label">Tu·ªïi:</span><span class="quick-view-value">${student.age}</span></div>
            <div class="quick-view-row"><span class="quick-view-label">Ph·ª• huynh:</span><span class="quick-view-value">${student.parentName}</span></div>
            <div class="quick-view-row"><span class="quick-view-label">SƒêT:</span><span class="quick-view-value">${student.parentPhone}</span></div>
            <div class="quick-view-row"><span class="quick-view-label">Email:</span><span class="quick-view-value">${student.parentEmail || '-'}</span></div>
            <div class="quick-view-row"><span class="quick-view-label">M√¥n h·ªçc:</span><span class="quick-view-value">${student.subjects.map(s => `<span class="subject-tag">${s}</span>`).join('')}</span></div>
            <div class="quick-view-row"><span class="quick-view-label">Tr·∫°ng th√°i:</span><span class="quick-view-value">${getStatusBadge(student.status)}</span></div>
        </div>
        <div class="quick-view-section">
            <h4>üìÖ L·ªãch H·∫πn (${studentAppointments.length})</h4>
            ${studentAppointments.length === 0 ? '<p class="text-muted">Ch∆∞a c√≥</p>' : studentAppointments.map(a => `<div class="quick-view-row"><span class="quick-view-label">${formatDate(a.date)} ${a.time}</span><span class="quick-view-value">${a.subject}</span></div>`).join('')}
        </div>
        <div class="quick-view-section">
            <h4>üìã Phi·∫øu ƒêK (${studentRegistrations.length})</h4>
            ${studentRegistrations.length === 0 ? '<p class="text-muted">Ch∆∞a c√≥</p>' : studentRegistrations.map(r => `<div class="quick-view-row"><span class="quick-view-label">${r.regCode}</span><span class="quick-view-value">${r.subject} - ${formatCurrency(r.finalAmount)}</span></div>`).join('')}
        </div>
        <div class="quick-view-section">
            <h4>üßæ Bi√™n Lai (${studentReceipts.length})</h4>
            ${studentReceipts.length === 0 ? '<p class="text-muted">Ch∆∞a c√≥</p>' : studentReceipts.map(r => `<div class="quick-view-row"><span class="quick-view-label">${formatDate(r.date)}</span><span class="quick-view-value">${formatCurrency(r.amount)}</span></div>`).join('')}
        </div>
    `;
    openModal('quickViewModal');
}

// ==========================================
// üîÑ STATUS CHANGES
// ==========================================
function cancelStudent(id) {
    const student = students.find(s => s.id === id);
    if (!student || !confirm(`Cancel "${student.name}"?`)) return;
    student.previousStatus = student.status;
    student.status = 'Cancel';
    student.updatedAt = new Date().toISOString();
    saveData('students', students);
    showNotification('ƒê√£ cancel!', 'warning');
    renderAll();
}

function restoreStudent(id) {
    const student = students.find(s => s.id === id);
    if (!student || !student.previousStatus) { showNotification('Kh√¥ng c√≥ tr·∫°ng th√°i ƒë·ªÉ kh√¥i ph·ª•c!', 'error'); return; }
    if (!confirm(`Kh√¥i ph·ª•c "${student.name}" v·ªÅ "${student.previousStatus}"?`)) return;
    student.status = student.previousStatus;
    student.previousStatus = null;
    student.updatedAt = new Date().toISOString();
    saveData('students', students);
    showNotification('ƒê√£ kh√¥i ph·ª•c!');
    renderAll();
}

function confirmTrialCompleted(id) {
    const student = students.find(s => s.id === id);
    if (!student || student.status !== 'H·ªçc Th·ª≠') return;
    if (!confirm(`X√°c nh·∫≠n "${student.name}" ƒë√£ h·ªçc th·ª≠ xong?`)) return;
    student.status = 'Ch·ªù ƒêƒÉng K√Ω';
    student.updatedAt = new Date().toISOString();
    saveData('students', students);
    showNotification('ƒê√£ chuy·ªÉn sang Ch·ªù ƒêƒÉng K√Ω!');
    renderAll();
}

// ==========================================
// üéì TRIAL STUDENTS
// ==========================================
function updateTrialCounts() {
    const trial = students.filter(s => s.status === 'H·ªçc Th·ª≠' || s.status === 'Ch·ªù ƒêƒÉng K√Ω');
    document.getElementById('trialCountAll').textContent = trial.length;
    document.getElementById('trialCountHocThu').textContent = students.filter(s => s.status === 'H·ªçc Th·ª≠').length;
    document.getElementById('trialCountChoDangKy').textContent = students.filter(s => s.status === 'Ch·ªù ƒêƒÉng K√Ω').length;
}

function filterTrialStudents(status) {
    currentTrialFilter = status;
    paginationState.trial.page = 1;
    document.querySelectorAll('#trial .filter-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.filter === status));
    renderTrialStudentsTable();
}

function searchTrialStudents() {
    paginationState.trial.page = 1;
    renderTrialStudentsTable();
}

function getFilteredTrialStudents() {
    const searchTerm = document.getElementById('searchTrialStudent')?.value?.toLowerCase() || '';
    let filtered = students.filter(s => s.status === 'H·ªçc Th·ª≠' || s.status === 'Ch·ªù ƒêƒÉng K√Ω');
    if (currentTrialFilter !== 'all') filtered = filtered.filter(s => s.status === currentTrialFilter);
    if (searchTerm) filtered = filtered.filter(s => s.name.toLowerCase().includes(searchTerm) || s.parentName.toLowerCase().includes(searchTerm) || s.parentPhone.includes(searchTerm));
    return filtered;
}

function renderTrialStudentsTable() {
    const filtered = getFilteredTrialStudents();
    const { data, total, totalPages, currentPage } = getPaginatedData(filtered, 'trial');
    const tbody = document.getElementById('trialStudentsTableBody');
    
    if (data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="empty-state-icon">üéì</div><p>Kh√¥ng c√≥ d·ªØ li·ªáu</p></div></td></tr>`;
        renderPagination('trialPagination', 'trial', 0, 0, 1);
        return;
    }
    
    tbody.innerHTML = data.map(s => {
        const apt = appointments.find(a => a.studentId === s.id && new Date(a.date + ' ' + a.time) >= new Date());
        return `
            <tr>
                <td><strong>${s.name}</strong></td>
                <td>${s.age}</td>
                <td>${s.parentName}</td>
                <td>${s.parentPhone}</td>
                <td>${s.subjects.map(sub => `<span class="subject-tag">${sub}</span>`).join('')}</td>
                <td>${getStatusBadge(s.status)}</td>
                <td>${apt ? `<span class="text-success">${formatDate(apt.date)} ${apt.time}</span>` : '<span class="text-muted">-</span>'}</td>
                <td><div class="action-buttons">${getTrialActionButtons(s)}</div></td>
            </tr>
        `;
    }).join('');
    
    renderPagination('trialPagination', 'trial', total, totalPages, currentPage);
}

function getTrialActionButtons(student) {
    const id = student.id;
    let btns = [`<button class="action-btn action-btn-view" onclick="viewStudent('${id}')" title="Xem">üëÅÔ∏è</button>`];
    if (student.status === 'H·ªçc Th·ª≠') {
        btns.push(`<button class="action-btn action-btn-schedule" onclick="openAppointmentModalForStudent('${id}')" title="ƒê·∫∑t l·ªãch">üìÖ</button>`);
        btns.push(`<button class="action-btn action-btn-confirm" onclick="confirmTrialCompleted('${id}')" title="X√°c nh·∫≠n ƒë√£ HT">‚úÖ</button>`);
    } else if (student.status === 'Ch·ªù ƒêƒÉng K√Ω') {
        btns.push(`<button class="action-btn action-btn-reg" onclick="openRegistrationModalForStudent('${id}')" title="T·∫°o Phi·∫øu ƒêK">üìã</button>`);
        btns.push(`<button class="action-btn action-btn-cancel" onclick="cancelStudent('${id}')" title="Cancel">‚ùå</button>`);
    }
    return btns.join('');
}

// ==========================================
// üìÖ APPOINTMENTS
// ==========================================
function openNewAppointmentModal() {
    document.getElementById('editAppointmentId').value = '';
    document.getElementById('appointmentStudentId').value = '';
    document.getElementById('appointmentStudentInput').value = '';
    document.getElementById('appointmentForm').reset();
    document.getElementById('appointmentModalTitle').textContent = 'üìÖ Th√™m L·ªãch H·∫πn M·ªõi';
    document.getElementById('appointmentDate').min = new Date().toISOString().split('T')[0];
    document.getElementById('appointmentConflictWarning').classList.add('hidden');
    populateStudentDropdown();
    openModal('appointmentModal');
}

function openAppointmentModalForStudent(studentId) {
    const student = students.find(s => s.id === studentId);
    if (!student) return;
    
    document.getElementById('editAppointmentId').value = '';
    document.getElementById('appointmentStudentId').value = studentId;
    document.getElementById('appointmentStudentInput').value = `${student.name} - ${student.parentPhone}`;
    document.getElementById('appointmentForm').reset();
    document.getElementById('appointmentStudentInput').value = `${student.name} - ${student.parentPhone}`;
    document.getElementById('appointmentModalTitle').textContent = 'üìÖ ƒê·∫∑t L·ªãch H·∫πn';
    document.getElementById('appointmentDate').min = new Date().toISOString().split('T')[0];
    document.getElementById('appointmentConflictWarning').classList.add('hidden');
    
    // Populate subjects
    document.getElementById('appointmentSubject').innerHTML = '<option value="">-- Ch·ªçn m√¥n --</option>' + 
        student.subjects.map(s => `<option value="${s}">${s}</option>`).join('');
    
    openModal('appointmentModal');
}

function populateStudentDropdown() {
    const options = students.filter(s => s.status === 'H·ªçc Th·ª≠' || s.status === 'Ch·ªù ƒêƒÉng K√Ω')
        .map(s => `<div class="searchable-select-option" data-id="${s.id}" data-name="${s.name}" data-phone="${s.parentPhone}" onclick="selectStudent('${s.id}')">${s.name} - ${s.parentPhone}</div>`).join('');
    document.getElementById('appointmentStudentOptions').innerHTML = options || '<div class="searchable-select-empty">Kh√¥ng c√≥ h·ªçc vi√™n</div>';
}

function toggleStudentDropdown() {
    const dropdown = document.getElementById('appointmentStudentDropdown');
    dropdown.classList.toggle('show');
    if (dropdown.classList.contains('show')) {
        populateStudentDropdown();
        document.getElementById('appointmentStudentSearch').value = '';
        document.getElementById('appointmentStudentSearch').focus();
    }
}

function filterStudentDropdown() {
    const search = document.getElementById('appointmentStudentSearch').value.toLowerCase();
    const options = document.querySelectorAll('#appointmentStudentOptions .searchable-select-option');
    options.forEach(opt => {
        const name = opt.dataset.name?.toLowerCase() || '';
        const phone = opt.dataset.phone || '';
        opt.style.display = (name.includes(search) || phone.includes(search)) ? 'block' : 'none';
    });
}

function selectStudent(studentId) {
    const student = students.find(s => s.id === studentId);
    if (!student) return;
    
    document.getElementById('appointmentStudentId').value = studentId;
    document.getElementById('appointmentStudentInput').value = `${student.name} - ${student.parentPhone}`;
    document.getElementById('appointmentStudentDropdown').classList.remove('show');
    
    // Populate subjects
    document.getElementById('appointmentSubject').innerHTML = '<option value="">-- Ch·ªçn m√¥n --</option>' + 
        student.subjects.map(s => `<option value="${s}">${s}</option>`).join('');
}

function saveAppointment(event) {
    event.preventDefault();
    
    const studentId = document.getElementById('appointmentStudentId').value;
    if (!studentId) { showNotification('Vui l√≤ng ch·ªçn h·ªçc vi√™n!', 'error'); return; }
    
    const editId = document.getElementById('editAppointmentId').value;
    const data = {
        studentId,
        subject: document.getElementById('appointmentSubject').value,
        date: document.getElementById('appointmentDate').value,
        time: document.getElementById('appointmentTime').value,
        notes: document.getElementById('appointmentNotes').value.trim()
    };
    
    // Check conflicts
    const conflicts = appointments.filter(a => {
        if (editId && a.id === editId) return false;
        return a.date === data.date && a.time === data.time;
    });
    
    if (conflicts.length > 0) {
        const warning = document.getElementById('appointmentConflictWarning');
        warning.innerHTML = `‚ö†Ô∏è Tr√πng gi·ªù v·ªõi ${conflicts.length} l·ªãch h·∫πn kh√°c!`;
        warning.classList.remove('hidden');
        if (!confirm('C√≥ l·ªãch h·∫πn tr√πng gi·ªù. V·∫´n ti·∫øp t·ª•c?')) return;
    }
    
    if (editId) {
        const index = appointments.findIndex(a => a.id === editId);
        if (index !== -1) {
            appointments[index] = { ...appointments[index], ...data, updatedAt: new Date().toISOString() };
            showNotification('C·∫≠p nh·∫≠t th√†nh c√¥ng!');
        }
    } else {
        appointments.push({ id: generateId(), ...data, createdAt: new Date().toISOString() });
        showNotification('Th√™m l·ªãch h·∫πn th√†nh c√¥ng!');
    }
    
    saveData('appointments', appointments);
    closeModal('appointmentModal');
    renderAll();
}

function filterAppointments(filter) {
    currentAppointmentFilter = filter;
    paginationState.appointments.page = 1;
    document.querySelectorAll('#appointments .filter-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    renderAppointmentsTable();
}

function searchAppointments() {
    paginationState.appointments.page = 1;
    renderAppointmentsTable();
}

function getFilteredAppointments() {
    const searchTerm = document.getElementById('searchAppointment')?.value?.toLowerCase() || '';
    const now = new Date();
    let filtered = [...appointments];
    
    if (currentAppointmentFilter === 'upcoming') filtered = filtered.filter(a => new Date(a.date + ' ' + a.time) >= now);
    else if (currentAppointmentFilter === 'past') filtered = filtered.filter(a => new Date(a.date + ' ' + a.time) < now);
    
    if (searchTerm) {
        filtered = filtered.filter(a => {
            const student = students.find(s => s.id === a.studentId);
            return a.subject.toLowerCase().includes(searchTerm) || a.date.includes(searchTerm) || student?.name.toLowerCase().includes(searchTerm);
        });
    }
    return filtered.sort((a, b) => new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time));
}

function renderAppointmentsTable() {
    const filtered = getFilteredAppointments();
    const { data, total, totalPages, currentPage } = getPaginatedData(filtered, 'appointments');
    const tbody = document.getElementById('appointmentsTableBody');
    const now = new Date();
    
    if (data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="empty-state-icon">üìÖ</div><p>Kh√¥ng c√≥ l·ªãch h·∫πn</p></div></td></tr>`;
        renderPagination('appointmentsPagination', 'appointments', 0, 0, 1);
        return;
    }
    
    tbody.innerHTML = data.map(a => {
        const student = students.find(s => s.id === a.studentId);
        const isPast = new Date(a.date + ' ' + a.time) < now;
        return `
            <tr style="${isPast ? 'opacity: 0.6;' : ''}">
                <td><strong>${student?.name || 'N/A'}</strong></td>
                <td>${student?.parentName || ''}</td>
                <td>${student?.parentPhone || ''}</td>
                <td><span class="subject-tag">${a.subject}</span></td>
                <td>${formatDate(a.date)}</td>
                <td><strong>${a.time}</strong></td>
                <td>${isPast ? '<span class="text-muted">ƒê√£ qua</span>' : '<span class="text-success">S·∫Øp t·ªõi</span>'}</td>
                <td>
                    <div class="action-buttons">
                        ${!isPast && student?.status === 'H·ªçc Th·ª≠' ? `<button class="action-btn action-btn-confirm" onclick="confirmTrialFromAppointment('${a.id}')" title="X√°c nh·∫≠n HT">‚úÖ</button>` : ''}
                        ${isPast && student?.status === 'H·ªçc Th·ª≠' ? `<button class="action-btn action-btn-schedule" onclick="openAppointmentModalForStudent('${student.id}')" title="ƒê·∫∑t l·ªãch m·ªõi">üìÖ</button>` : ''}
                        <button class="action-btn action-btn-edit" onclick="editAppointment('${a.id}')" title="S·ª≠a">‚úèÔ∏è</button>
                        <button class="action-btn action-btn-delete" onclick="deleteAppointment('${a.id}')" title="X√≥a">üóëÔ∏è</button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
    
    renderPagination('appointmentsPagination', 'appointments', total, totalPages, currentPage);
}

function confirmTrialFromAppointment(aptId) {
    const apt = appointments.find(a => a.id === aptId);
    if (apt) confirmTrialCompleted(apt.studentId);
}

function editAppointment(id) {
    const apt = appointments.find(a => a.id === id);
    if (!apt) return;
    const student = students.find(s => s.id === apt.studentId);
    
    document.getElementById('editAppointmentId').value = apt.id;
    document.getElementById('appointmentStudentId').value = apt.studentId;
    document.getElementById('appointmentStudentInput').value = student ? `${student.name} - ${student.parentPhone}` : '';
    document.getElementById('appointmentSubject').innerHTML = '<option value="">-- Ch·ªçn m√¥n --</option>' + 
        (student?.subjects || []).map(s => `<option value="${s}" ${s === apt.subject ? 'selected' : ''}>${s}</option>`).join('');
    document.getElementById('appointmentDate').value = apt.date;
    document.getElementById('appointmentTime').value = apt.time;
    document.getElementById('appointmentNotes').value = apt.notes || '';
    document.getElementById('appointmentModalTitle').textContent = '‚úèÔ∏è S·ª≠a L·ªãch H·∫πn';
    
    openModal('appointmentModal');
}

function deleteAppointment(id) {
    if (!confirm('X√≥a l·ªãch h·∫πn n√†y?')) return;
    appointments = appointments.filter(a => a.id !== id);
    saveData('appointments', appointments);
    showNotification('ƒê√£ x√≥a!');
    renderAll();
}

// ==========================================
// üìã REGISTRATIONS (Phi·∫øu ƒêƒÉng K√Ω)
// ==========================================
function openNewRegistrationModal() {
    document.getElementById('regStudentId').value = '';
    document.getElementById('regStudentInput').value = '';
    document.getElementById('registrationForm').reset();
    document.getElementById('regSubject').innerHTML = '<option value="">-- Ch·ªçn m√¥n --</option>';
    document.getElementById('regPackage').innerHTML = '<option value="">-- Nh·∫≠p th·ªß c√¥ng --</option>';
    document.getElementById('regDiscountAmount').value = '';
    document.getElementById('regFinalAmount').value = '';
    populateRegStudentDropdown();
    renderPromotionCheckboxes();
    openModal('registrationModal');
}

function openRegistrationModalForStudent(studentId) {
    const student = students.find(s => s.id === studentId);
    if (!student) return;
    
    document.getElementById('regStudentId').value = studentId;
    document.getElementById('regStudentInput').value = `${student.name} - ${student.parentPhone}`;
    document.getElementById('registrationForm').reset();
    document.getElementById('regStudentInput').value = `${student.name} - ${student.parentPhone}`;
    document.getElementById('regSubject').innerHTML = '<option value="">-- Ch·ªçn m√¥n --</option>' + 
        student.subjects.map(s => `<option value="${s}">${s}</option>`).join('');
    document.getElementById('regPackage').innerHTML = '<option value="">-- Nh·∫≠p th·ªß c√¥ng --</option>';
    document.getElementById('regDiscountAmount').value = '';
    document.getElementById('regFinalAmount').value = '';
    renderPromotionCheckboxes();
    openModal('registrationModal');
}

function populateRegStudentDropdown() {
    const options = students.filter(s => s.status === 'Ch·ªù ƒêƒÉng K√Ω')
        .map(s => `<div class="searchable-select-option" data-id="${s.id}" data-name="${s.name}" data-phone="${s.parentPhone}" onclick="selectRegStudent('${s.id}')">${s.name} - ${s.parentPhone}</div>`).join('');
    document.getElementById('regStudentOptions').innerHTML = options || '<div class="searchable-select-empty">Kh√¥ng c√≥ h·ªçc vi√™n Ch·ªù ƒêƒÉng K√Ω</div>';
}

function toggleRegStudentDropdown() {
    const dropdown = document.getElementById('regStudentDropdown');
    dropdown.classList.toggle('show');
    if (dropdown.classList.contains('show')) {
        populateRegStudentDropdown();
        document.getElementById('regStudentSearch').value = '';
        document.getElementById('regStudentSearch').focus();
    }
}

function filterRegStudentDropdown() {
    const search = document.getElementById('regStudentSearch').value.toLowerCase();
    document.querySelectorAll('#regStudentOptions .searchable-select-option').forEach(opt => {
        const name = opt.dataset.name?.toLowerCase() || '';
        const phone = opt.dataset.phone || '';
        opt.style.display = (name.includes(search) || phone.includes(search)) ? 'block' : 'none';
    });
}

function selectRegStudent(studentId) {
    const student = students.find(s => s.id === studentId);
    if (!student) return;
    
    document.getElementById('regStudentId').value = studentId;
    document.getElementById('regStudentInput').value = `${student.name} - ${student.parentPhone}`;
    document.getElementById('regStudentDropdown').classList.remove('show');
    document.getElementById('regSubject').innerHTML = '<option value="">-- Ch·ªçn m√¥n --</option>' + 
        student.subjects.map(s => `<option value="${s}">${s}</option>`).join('');
}

function loadPackagesForSubject() {
    const subject = document.getElementById('regSubject').value;
    const subjectPackages = packages.filter(p => p.subjectName === subject);
    document.getElementById('regPackage').innerHTML = '<option value="">-- Nh·∫≠p th·ªß c√¥ng --</option>' + 
        subjectPackages.map(p => `<option value="${p.id}">${p.name} - ${p.sessions} bu·ªïi - ${formatCurrency(p.fee)}</option>`).join('');
    
    const subjectInfo = subjects.find(s => s.name === subject);
    if (subjectInfo) {
        document.getElementById('regTuitionFee').value = formatNumberInput(subjectInfo.defaultFee);
        calculateFinalAmount();
    }
}

function applyPackageFee() {
    const pkgId = document.getElementById('regPackage').value;
    const pkg = packages.find(p => p.id === pkgId);
    if (pkg) {
        document.getElementById('regTuitionFee').value = formatNumberInput(pkg.fee);
        calculateFinalAmount();
    }
}

function renderPromotionCheckboxes() {
    const now = new Date();
    const active = promotions.filter(p => new Date(p.endDate) >= now);
    document.getElementById('regPromotionList').innerHTML = active.length === 0 
        ? '<p class="text-muted">Kh√¥ng c√≥ KM</p>'
        : active.map(p => `<label class="checkbox-item"><input type="checkbox" name="regPromotions" value="${p.id}" onchange="calculateFinalAmount()"> ${p.name} (${p.type === 'percent' ? p.value + '%' : formatCurrency(p.value)})</label>`).join('');
}

function calculateFinalAmount() {
    const tuition = parseCurrencyInput(document.getElementById('regTuitionFee').value);
    const selectedPromos = Array.from(document.querySelectorAll('input[name="regPromotions"]:checked')).map(cb => promotions.find(p => p.id === cb.value)).filter(p => p);
    
    let discount = 0;
    selectedPromos.forEach(p => {
        discount += p.type === 'percent' ? tuition * p.value / 100 : p.value;
    });
    
    const final = Math.max(tuition - discount, 0);
    document.getElementById('regDiscountAmount').value = discount > 0 ? '-' + formatCurrency(discount) : '';
    document.getElementById('regFinalAmount').value = formatCurrency(final);
}

function saveRegistration(event) {
    event.preventDefault();
    
    const studentId = document.getElementById('regStudentId').value;
    if (!studentId) { showNotification('Vui l√≤ng ch·ªçn h·ªçc vi√™n!', 'error'); return; }
    
    const student = students.find(s => s.id === studentId);
    const tuition = parseCurrencyInput(document.getElementById('regTuitionFee').value);
    const selectedPromoIds = Array.from(document.querySelectorAll('input[name="regPromotions"]:checked')).map(cb => cb.value);
    
    let discount = 0;
    selectedPromoIds.forEach(promoId => {
        const promo = promotions.find(p => p.id === promoId);
        if (promo) discount += promo.type === 'percent' ? tuition * promo.value / 100 : promo.value;
    });
    
    const finalAmount = Math.max(tuition - discount, 0);
    
    // Check if editing
    const editId = document.getElementById('registrationForm').dataset.editId;
    
    if (editId) {
        // UPDATE existing registration
        const index = registrations.findIndex(r => r.id === editId);
        if (index !== -1) {
            registrations[index] = {
                ...registrations[index],
                studentId,
                studentName: student ? student.name : registrations[index].studentName,
                parentName: student ? student.parentName : registrations[index].parentName,
                parentPhone: student ? student.parentPhone : registrations[index].parentPhone,
                subject: document.getElementById('regSubject').value,
                packageId: document.getElementById('regPackage').value || null,
                tuitionFee: tuition,
                promotionIds: selectedPromoIds,
                discountAmount: discount,
                finalAmount,
                updatedAt: new Date().toISOString()
            };
            showNotification('C·∫≠p nh·∫≠t phi·∫øu ƒêK th√†nh c√¥ng!');
        }
        // Clear edit ID
        delete document.getElementById('registrationForm').dataset.editId;
    } else {
        // CREATE new registration
        const regCode = generateRegCode();
        
        const registration = {
            id: generateId(),
            regCode,
            studentId,
            studentName: student.name,
            parentName: student.parentName,
            parentPhone: student.parentPhone,
            subject: document.getElementById('regSubject').value,
            packageId: document.getElementById('regPackage').value || null,
            tuitionFee: tuition,
            promotionIds: selectedPromoIds,
            discountAmount: discount,
            finalAmount,
            registrationDate: new Date().toISOString().split('T')[0],
            status: 'ƒê√£ ƒëƒÉng k√Ω',
            createdAt: new Date().toISOString()
        };
        
        registrations.push(registration);
        
        // Update student status
        if (student && student.status === 'Ch·ªù ƒêƒÉng K√Ω') {
            student.status = 'ƒê√£ ƒêƒÉng K√Ω';
            student.updatedAt = new Date().toISOString();
            saveData('students', students);
        }
        
        showNotification(`T·∫°o phi·∫øu ƒêK th√†nh c√¥ng! M√£: ${regCode}`);
    }
    
    saveData('registrations', registrations);
    closeModal('registrationModal');
    renderAll();
}

function searchRegistrations() {
    paginationState.registrations.page = 1;
    renderRegistrationsTable();
}

function getFilteredRegistrations() {
    const searchTerm = document.getElementById('searchRegistration')?.value?.toLowerCase() || '';
    let filtered = [...registrations];
    if (searchTerm) {
        filtered = filtered.filter(r => r.regCode.toLowerCase().includes(searchTerm) || r.studentName?.toLowerCase().includes(searchTerm) || r.subject.toLowerCase().includes(searchTerm));
    }
    return filtered.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
}

function renderRegistrationsTable() {
    const filtered = getFilteredRegistrations();
    const { data, total, totalPages, currentPage } = getPaginatedData(filtered, 'registrations');
    const tbody = document.getElementById('registrationsTableBody');
    
    if (data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="9"><div class="empty-state"><div class="empty-state-icon">üìã</div><p>Kh√¥ng c√≥ phi·∫øu ƒëƒÉng k√Ω</p></div></td></tr>`;
        renderPagination('registrationsPagination', 'registrations', 0, 0, 1);
        return;
    }
    
    tbody.innerHTML = data.map(r => {
        const pkg = packages.find(p => p.id === r.packageId);
        const packageInfo = pkg ? `${pkg.name} (${pkg.sessions} bu·ªïi)` : 'Th·ªß c√¥ng';
        
        return `
            <tr>
                <td><strong class="text-primary">${r.regCode}</strong></td>
                <td>${r.studentName || 'N/A'}</td>
                <td>
                    <span class="subject-tag">${r.subject}</span><br>
                    <small class="text-muted">${packageInfo} - ${formatCurrency(r.tuitionFee)}</small>
                </td>
                <td class="text-danger">${r.discountAmount > 0 ? '-' + formatCurrency(r.discountAmount) : '-'}</td>
                <td><strong class="text-success">${formatCurrency(r.finalAmount)}</strong></td>
                <td>${formatDate(r.registrationDate)}</td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn action-btn-view" onclick="viewRegistration('${r.id}')" title="Xem">üëÅÔ∏è</button>
                        <button class="action-btn action-btn-edit" onclick="editRegistration('${r.id}')" title="S·ª≠a">‚úèÔ∏è</button>
                        <button class="action-btn action-btn-delete" onclick="deleteRegistration('${r.id}')" title="X√≥a">üóëÔ∏è</button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
    
    renderPagination('registrationsPagination', 'registrations', total, totalPages, currentPage);
}

function viewRegistration(id) {
    const reg = registrations.find(r => r.id === id);
    if (!reg) return;
    
    const pkg = packages.find(p => p.id === reg.packageId);
    const packageInfo = pkg ? `${pkg.name} (${pkg.sessions} bu·ªïi)` : 'G√≥i th·ªß c√¥ng';
    
    const content = document.getElementById('registrationPreviewContent');
    content.innerHTML = `
        <div style="padding: 25px; border: 2px solid #667eea; border-radius: 12px; position: relative;">
            <!-- Header v·ªõi Logo v√† QR -->
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                <div>
                    ${centerInfo.logo ? `<img src="${centerInfo.logo}" style="width: 70px; height: 70px; object-fit: contain; border-radius: 8px;">` : '<div style="width: 70px; height: 70px; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #999;">Logo</div>'}
                    <p style="margin-top: 8px; font-weight: 600; color: #667eea; font-size: 1.1em;">${centerInfo.name || 'TRUNG T√ÇM'}</p>
                </div>
                <div id="regQRCode" style="text-align: center;">
                    <div style="width: 100px; height: 100px; background: #f8f9fa; border-radius: 8px;"></div>
                </div>
            </div>
            
            <!-- Ti√™u ƒë·ªÅ -->
            <div style="text-align: center; margin-bottom: 25px;">
                <h2 style="color: #667eea; margin-bottom: 8px; font-size: 1.6em;">PHI·∫æU ƒêƒÇNG K√ù</h2>
                <p style="font-size: 1.3em; font-weight: 700; color: #333;">${reg.regCode}</p>
            </div>
            
            <!-- Th√¥ng tin h·ªçc vi√™n -->
            <div style="background: #f8f9fa; padding: 18px; border-radius: 10px; margin-bottom: 18px;">
                <div style="margin-bottom: 10px;">
                    <span style="color: #666; min-width: 100px; display: inline-block;">H·ªçc vi√™n:</span>
                    <strong>${reg.studentName}</strong>
                </div>
                <div style="margin-bottom: 10px;">
                    <span style="color: #666; min-width: 100px; display: inline-block;">Ph·ª• huynh:</span>
                    <strong>${reg.parentName}</strong> - ${reg.parentPhone}
                </div>
                <div style="margin-bottom: 10px;">
                    <span style="color: #666; min-width: 100px; display: inline-block;">M√¥n h·ªçc:</span>
                    <strong>${reg.subject}</strong>
                    <span style="margin-left: 15px; color: #667eea; font-weight: 600;">Kh√≥a: ${packageInfo}</span>
                </div>
                <div>
                    <span style="color: #666; min-width: 100px; display: inline-block;">Ng√†y ƒëƒÉng k√Ω:</span>
                    <strong>${formatDate(reg.registrationDate)}</strong>
                </div>
            </div>
            
            <!-- Th√¥ng tin h·ªçc ph√≠ - N·∫±m tr√™n 1 d√≤ng -->
            <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 18px; border-radius: 10px; display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div style="text-align: center;">
                    <span style="color: #666; font-size: 0.9em;">H·ªçc ph√≠</span>
                    <p style="font-size: 1.2em; font-weight: 700; color: #1976d2; margin: 5px 0;">${formatCurrency(reg.tuitionFee)}</p>
                </div>
                ${reg.discountAmount > 0 ? `
                <div style="text-align: center;">
                    <span style="color: #666; font-size: 0.9em;">Gi·∫£m gi√°</span>
                    <p style="font-size: 1.2em; font-weight: 700; color: #c62828; margin: 5px 0;">-${formatCurrency(reg.discountAmount)}</p>
                </div>
                ` : ''}
                <div style="text-align: center;">
                    <span style="color: #666; font-size: 0.9em;">Th√†nh ti·ªÅn</span>
                    <p style="font-size: 1.4em; font-weight: 700; color: #388e3c; margin: 5px 0;">${formatCurrency(reg.finalAmount)}</p>
                </div>
            </div>
            
            <!-- Footer -->
            <p style="text-align: center; margin-top: 20px; color: #888; font-size: 0.85em;">
                Qu√©t m√£ QR ƒë·ªÉ xem th√¥ng tin ƒëƒÉng k√Ω
            </p>
        </div>
    `;
    
    // Generate QR ·ªü g√≥c ph·∫£i
    setTimeout(() => {
        const qrContainer = document.getElementById('regQRCode');
        if (qrContainer) {
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, {
                text: `Ma DK: ${reg.regCode} | HV: ${reg.studentName} | Mon: ${reg.subject} | Tien: ${reg.finalAmount}`,
                width: 100,
                height: 100
            });
        }
    }, 100);
    
    openModal('viewRegistrationModal');
}

function editRegistration(id) {
    const reg = registrations.find(r => r.id === id);
    if (!reg) return;
    
    const student = students.find(s => s.id === reg.studentId);
    
    document.getElementById('regStudentId').value = reg.studentId;
    document.getElementById('regStudentInput').value = student ? `${student.name} - ${student.parentPhone}` : reg.studentName;
    
    // Populate subjects
    if (student) {
        document.getElementById('regSubject').innerHTML = '<option value="">-- Ch·ªçn m√¥n --</option>' + 
            student.subjects.map(s => `<option value="${s}" ${s === reg.subject ? 'selected' : ''}>${s}</option>`).join('');
    } else {
        document.getElementById('regSubject').innerHTML = `<option value="${reg.subject}" selected>${reg.subject}</option>`;
    }
    
    // Load packages
    loadPackagesForSubject();
    setTimeout(() => {
        if (reg.packageId) {
            document.getElementById('regPackage').value = reg.packageId;
        }
    }, 100);
    
    document.getElementById('regTuitionFee').value = formatNumberInput(reg.tuitionFee);
    
    // Check promotions
    renderPromotionCheckboxes();
    setTimeout(() => {
        if (reg.promotionIds && reg.promotionIds.length > 0) {
            reg.promotionIds.forEach(promoId => {
                const checkbox = document.querySelector(`input[name="regPromotions"][value="${promoId}"]`);
                if (checkbox) checkbox.checked = true;
            });
        }
        calculateFinalAmount();
    }, 100);
    
    // Store edit ID
    document.getElementById('registrationForm').dataset.editId = id;
    
    openModal('registrationModal');
}

function deleteRegistration(id) {
    if (!confirm('X√≥a phi·∫øu ƒëƒÉng k√Ω n√†y?')) return;
    registrations = registrations.filter(r => r.id !== id);
    saveData('registrations', registrations);
    showNotification('ƒê√£ x√≥a!');
    renderRegistrationsTable();
}

function printRegistration() { window.print(); }
function downloadRegistrationPDF() {
    const element = document.getElementById('registrationPreviewContent');
    html2pdf().set({ margin: 10, filename: 'PhieuDangKy.pdf', html2canvas: { scale: 2 }, jsPDF: { format: 'a4' } }).from(element).save();
}

// ==========================================
// üßæ RECEIPTS
// ==========================================
function openReceiptModal() {
    document.getElementById('editReceiptId').value = '';
    document.getElementById('receiptForm').reset();
    document.getElementById('receiptDate').value = new Date().toISOString().split('T')[0];
    populateReceiptStudentDropdown();
    openModal('receiptModal');
}

function openReceiptModalForStudent(studentId) {
    openReceiptModal();
    document.getElementById('receiptStudentId').value = studentId;
    fillReceiptStudentInfo();
}

function populateReceiptStudentDropdown() {
    const eligible = students.filter(s => s.status === 'ƒê√£ ƒêƒÉng K√Ω');
    document.getElementById('receiptStudentId').innerHTML = '<option value="">-- Ch·ªçn h·ªçc vi√™n --</option>' + 
        eligible.map(s => `<option value="${s.id}">${s.name} - ${s.parentPhone}</option>`).join('');
}

function fillReceiptStudentInfo() {
    const student = students.find(s => s.id === document.getElementById('receiptStudentId').value);
    document.getElementById('receiptParentName').value = student?.parentName || '';
    document.getElementById('receiptParentPhone').value = student?.parentPhone || '';
}

function saveReceipt(event) {
    event.preventDefault();
    
    const editId = document.getElementById('editReceiptId').value;
    const studentId = document.getElementById('receiptStudentId').value;
    const student = students.find(s => s.id === studentId);
    
    const data = {
        studentId,
        type: document.getElementById('receiptType').value,
        parentName: student?.parentName || '',
        parentPhone: student?.parentPhone || '',
        description: document.getElementById('receiptDescription').value.trim(),
        amount: parseCurrencyInput(document.getElementById('receiptAmount').value),
        date: document.getElementById('receiptDate').value,
        notes: document.getElementById('receiptNotes').value.trim()
    };
    
    if (editId) {
        const index = receipts.findIndex(r => r.id === editId);
        if (index !== -1) { receipts[index] = { ...receipts[index], ...data, updatedAt: new Date().toISOString() }; }
    } else {
        receipts.push({ id: generateId(), ...data, createdAt: new Date().toISOString() });
        if (student && student.status === 'ƒê√£ ƒêƒÉng K√Ω' && confirm('Chuy·ªÉn tr·∫°ng th√°i HV sang "Ho√†n Th√†nh"?')) {
            student.status = 'Ho√†n Th√†nh';
            student.updatedAt = new Date().toISOString();
            saveData('students', students);
        }
    }
    
    saveData('receipts', receipts);
    closeModal('receiptModal');
    showNotification(editId ? 'C·∫≠p nh·∫≠t th√†nh c√¥ng!' : 'T·∫°o bi√™n lai th√†nh c√¥ng!');
    renderAll();
}

function searchReceipts() {
    paginationState.receipts.page = 1;
    renderReceiptsTable();
}

function getFilteredReceipts() {
    const searchTerm = document.getElementById('searchReceipt')?.value?.toLowerCase() || '';
    let filtered = [...receipts];
    if (searchTerm) {
        filtered = filtered.filter(r => {
            const student = students.find(s => s.id === r.studentId);
            return r.description.toLowerCase().includes(searchTerm) || r.type.toLowerCase().includes(searchTerm) || student?.name.toLowerCase().includes(searchTerm);
        });
    }
    return filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
}

function renderReceiptsTable() {
    const filtered = getFilteredReceipts();
    const { data, total, totalPages, currentPage } = getPaginatedData(filtered, 'receipts');
    const tbody = document.getElementById('receiptsTableBody');
    
    if (data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">üßæ</div><p>Kh√¥ng c√≥ bi√™n lai</p></div></td></tr>`;
        renderPagination('receiptsPagination', 'receipts', 0, 0, 1);
        return;
    }
    
    tbody.innerHTML = data.map((r, idx) => {
        const student = students.find(s => s.id === r.studentId);
        return `
            <tr>
                <td><strong>#${String(total - (paginationState.receipts.page - 1) * paginationState.receipts.pageSize - idx).padStart(4, '0')}</strong></td>
                <td><span class="subject-tag">${r.type}</span></td>
                <td>${student?.name || 'N/A'}</td>
                <td>${r.description}</td>
                <td><strong class="text-success">${formatCurrency(r.amount)}</strong></td>
                <td>${formatDate(r.date)}</td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn action-btn-view" onclick="viewReceipt('${r.id}')" title="Xem">üëÅÔ∏è</button>
                        <button class="action-btn action-btn-edit" onclick="editReceipt('${r.id}')" title="S·ª≠a">‚úèÔ∏è</button>
                        <button class="action-btn action-btn-delete" onclick="deleteReceipt('${r.id}')" title="X√≥a">üóëÔ∏è</button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
    
    renderPagination('receiptsPagination', 'receipts', total, totalPages, currentPage);
}

function viewReceipt(id) {
    const receipt = receipts.find(r => r.id === id);
    if (!receipt) return;
    const student = students.find(s => s.id === receipt.studentId);
    const receiptNumber = String(receipts.indexOf(receipt) + 1).padStart(4, '0');
    
    document.getElementById('receiptPreviewContent').innerHTML = `
        <div style="padding: 25px; border: 2px solid #667eea; border-radius: 12px; max-width: 500px; margin: 0 auto; font-family: 'Segoe UI', sans-serif;">
            <!-- Header -->
            <div style="display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #667eea; padding-bottom: 15px; margin-bottom: 20px;">
                <div>
                    ${centerInfo.logo ? `<img src="${centerInfo.logo}" style="width: 70px; height: 70px; object-fit: contain; border-radius: 8px;">` : '<div style="width: 70px; height: 70px; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.8em; color: #999;">Logo</div>'}
                </div>
                <div style="text-align: right;">
                    <p style="font-weight: 700; color: #667eea; font-size: 1.1em; margin-bottom: 5px;">${centerInfo.name || 'TRUNG T√ÇM'}</p>
                    <p style="font-size: 0.85em; color: #555; margin-bottom: 3px;">${centerInfo.address || ''}</p>
                    <p style="font-size: 0.85em; color: #555;">üìû ${centerInfo.phone || ''}</p>
                </div>
            </div>
            
            <!-- Ti√™u ƒë·ªÅ -->
            <div style="text-align: center; margin-bottom: 25px;">
                <h2 style="color: #667eea; margin-bottom: 5px; font-size: 1.5em;">${receipt.type.toUpperCase()}</h2>
                <p style="color: #666;">S·ªë: <strong>#${receiptNumber}</strong></p>
            </div>
            
            <!-- Th√¥ng tin -->
            <div style="margin-bottom: 20px;">
                <div style="display: flex; padding: 8px 0; border-bottom: 1px solid #eee;">
                    <span style="color: #666; min-width: 110px;">H·ªçc vi√™n:</span>
                    <strong>${student?.name || 'N/A'}</strong>
                </div>
                <div style="display: flex; padding: 8px 0; border-bottom: 1px solid #eee;">
                    <span style="color: #666; min-width: 110px;">Ph·ª• huynh:</span>
                    <span>${receipt.parentName}</span>
                </div>
                <div style="display: flex; padding: 8px 0; border-bottom: 1px solid #eee;">
                    <span style="color: #666; min-width: 110px;">S·ªë ƒëi·ªán tho·∫°i:</span>
                    <span>${receipt.parentPhone}</span>
                </div>
                <div style="display: flex; padding: 8px 0; border-bottom: 1px solid #eee;">
                    <span style="color: #666; min-width: 110px;">N·ªôi dung:</span>
                    <span>${receipt.description}</span>
                </div>
                <div style="display: flex; padding: 8px 0;">
                    <span style="color: #666; min-width: 110px;">Ng√†y:</span>
                    <span>${formatDateFull(receipt.date)}</span>
                </div>
            </div>
            
            <!-- S·ªë ti·ªÅn -->
            <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 15px;">
                <p style="color: #666; margin-bottom: 8px;">S·ªë ti·ªÅn</p>
                <p style="font-size: 2em; font-weight: 200; color: #667eea; margin-bottom: 8px;">${formatCurrencyVND(receipt.amount)}</p>
                <p style="font-style: italic; color: #888; font-size: 0.9em;">(${numberToWords(receipt.amount)})</p>
            </div>
            
            <!-- Footer -->
            <div style="text-align: center; padding-top: 15px; border-top: 1px solid #eee;">
                <p style="color: #555; margin-bottom: 5px;">C·∫£m ∆°n qu√Ω ph·ª• huynh ƒë√£ tin t∆∞·ªüng!</p>
                <p style="color: #999; font-size: 0.8em;">In l√∫c: ${new Date().toLocaleString('vi-VN')}</p>
            </div>
        </div>
    `;
    
    openModal('viewReceiptModal');
}

// Helper function cho format ng√†y ƒë·∫ßy ƒë·ªß
function formatDateFull(dateStr) {
    if (!dateStr) return '';
    const d = new Date(dateStr);
    const days = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
    return `${days[d.getDay()]} ${d.getDate()}/${d.getMonth() + 1}/${d.getFullYear()}`;
}

// Helper function cho format ti·ªÅn VND v·ªõi ƒë
function formatCurrencyVND(amount) {
    return new Intl.NumberFormat('vi-VN').format(amount || 0) + ' ƒë';
}

function editReceipt(id) {
    const r = receipts.find(r => r.id === id);
    if (!r) return;
    populateReceiptStudentDropdown();
    document.getElementById('editReceiptId').value = r.id;
    document.getElementById('receiptType').value = r.type;
    document.getElementById('receiptStudentId').value = r.studentId;
    fillReceiptStudentInfo();
    document.getElementById('receiptDescription').value = r.description;
    document.getElementById('receiptAmount').value = formatNumberInput(r.amount);
    document.getElementById('receiptDate').value = r.date;
    document.getElementById('receiptNotes').value = r.notes || '';
    openModal('receiptModal');
}

function deleteReceipt(id) {
    if (!confirm('X√≥a bi√™n lai n√†y?')) return;
    receipts = receipts.filter(r => r.id !== id);
    saveData('receipts', receipts);
    showNotification('ƒê√£ x√≥a!');
    renderReceiptsTable();
}

function viewStudentReceipts(studentId) {
    const studentReceipts = receipts.filter(r => r.studentId === studentId);
    if (studentReceipts.length === 0) { showNotification('Ch∆∞a c√≥ bi√™n lai!', 'info'); return; }
    
    const student = students.find(s => s.id === studentId);
    document.getElementById('quickViewContent').innerHTML = `
        <div class="quick-view-section">
            <h4>üßæ Bi√™n Lai - ${student?.name || ''}</h4>
            ${studentReceipts.map(r => `
                <div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #e9ecef;">
                    <div class="d-flex justify-between"><strong>${r.type}</strong><span class="text-success">${formatCurrency(r.amount)}</span></div>
                    <p class="text-muted">${r.description} - ${formatDate(r.date)}</p>
                    <button class="btn btn-sm btn-info mt-10" onclick="viewReceipt('${r.id}'); closeModal('quickViewModal');">Xem</button>
                </div>
            `).join('')}
        </div>
    `;
    openModal('quickViewModal');
}

function printReceipt() { window.print(); }
function downloadReceiptPDF() {
    html2pdf().set({ margin: 10, filename: 'BienLai.pdf', html2canvas: { scale: 2 }, jsPDF: { format: 'a4' } }).from(document.getElementById('receiptPreviewContent')).save();
}

// ==========================================
// üìö CATEGORIES
// ==========================================
function renderSubjectsTable() {
    document.getElementById('subjectsTableBody').innerHTML = subjects.map(s => `
        <tr>
            <td style="font-size: 1.5em;">${s.icon}</td>
            <td><strong>${s.name}</strong></td>
            <td>${formatCurrency(s.defaultFee)}</td>
            <td><div class="action-buttons">
                <button class="action-btn action-btn-edit" onclick="editSubject('${s.id}')">‚úèÔ∏è</button>
                <button class="action-btn action-btn-delete" onclick="deleteSubject('${s.id}')">üóëÔ∏è</button>
            </div></td>
        </tr>
    `).join('');
}

function openSubjectModal() {
    document.getElementById('editSubjectId').value = '';
    document.getElementById('subjectForm').reset();
    document.getElementById('subjectModalTitle').textContent = 'üìñ Th√™m M√¥n H·ªçc';
    openModal('subjectModal');
}

function editSubject(id) {
    const s = subjects.find(s => s.id === id);
    if (!s) return;
    document.getElementById('editSubjectId').value = s.id;
    document.getElementById('subjectIcon').value = s.icon;
    document.getElementById('subjectName').value = s.name;
    document.getElementById('subjectDefaultFee').value = formatNumberInput(s.defaultFee);
    document.getElementById('subjectModalTitle').textContent = '‚úèÔ∏è S·ª≠a M√¥n H·ªçc';
    openModal('subjectModal');
}

function saveSubject(event) {
    event.preventDefault();
    const editId = document.getElementById('editSubjectId').value;
    const data = { icon: document.getElementById('subjectIcon').value.trim(), name: document.getElementById('subjectName').value.trim(), defaultFee: parseCurrencyInput(document.getElementById('subjectDefaultFee').value) };
    
    if (editId) {
        const idx = subjects.findIndex(s => s.id === editId);
        if (idx !== -1) subjects[idx] = { ...subjects[idx], ...data };
    } else {
        subjects.push({ id: generateId(), ...data });
    }
    saveData('subjects', subjects);
    closeModal('subjectModal');
    showNotification(editId ? 'C·∫≠p nh·∫≠t!' : 'Th√™m th√†nh c√¥ng!');
    renderSubjectsTable();
    renderSubjectCheckboxes();
}

function deleteSubject(id) {
    if (!confirm('X√≥a m√¥n h·ªçc n√†y?')) return;
    subjects = subjects.filter(s => s.id !== id);
    saveData('subjects', subjects);
    showNotification('ƒê√£ x√≥a!');
    renderSubjectsTable();
    renderSubjectCheckboxes();
}

function renderPackagesTable() {
    const tbody = document.getElementById('packagesTableBody');
    tbody.innerHTML = packages.length === 0 ? `<tr><td colspan="5"><div class="empty-state"><p>Ch∆∞a c√≥ g√≥i</p></div></td></tr>` : packages.map(p => `
        <tr>
            <td><strong>${p.name}</strong></td>
            <td>${p.subjectName}</td>
            <td>${p.sessions} bu·ªïi</td>
            <td>${formatCurrency(p.fee)}</td>
            <td><div class="action-buttons">
                <button class="action-btn action-btn-edit" onclick="editPackage('${p.id}')">‚úèÔ∏è</button>
                <button class="action-btn action-btn-delete" onclick="deletePackage('${p.id}')">üóëÔ∏è</button>
            </div></td>
        </tr>
    `).join('');
}

function openPackageModal() {
    document.getElementById('editPackageId').value = '';
    document.getElementById('packageForm').reset();
    document.getElementById('packageModalTitle').textContent = 'üì¶ Th√™m G√≥i';
    document.getElementById('packageSubject').innerHTML = '<option value="">-- Ch·ªçn m√¥n --</option>' + subjects.map(s => `<option value="${s.name}">${s.icon} ${s.name}</option>`).join('');
    openModal('packageModal');
}

function editPackage(id) {
    const p = packages.find(p => p.id === id);
    if (!p) return;
    document.getElementById('editPackageId').value = p.id;
    document.getElementById('packageName').value = p.name;
    document.getElementById('packageSubject').innerHTML = '<option value="">-- Ch·ªçn m√¥n --</option>' + subjects.map(s => `<option value="${s.name}" ${s.name === p.subjectName ? 'selected' : ''}>${s.icon} ${s.name}</option>`).join('');
    document.getElementById('packageSessions').value = p.sessions;
    document.getElementById('packageFee').value = formatNumberInput(p.fee);
    document.getElementById('packageModalTitle').textContent = '‚úèÔ∏è S·ª≠a G√≥i';
    openModal('packageModal');
}

function savePackage(event) {
    event.preventDefault();
    const editId = document.getElementById('editPackageId').value;
    const data = { name: document.getElementById('packageName').value.trim(), subjectName: document.getElementById('packageSubject').value, sessions: parseInt(document.getElementById('packageSessions').value), fee: parseCurrencyInput(document.getElementById('packageFee').value) };
    
    if (editId) {
        const idx = packages.findIndex(p => p.id === editId);
        if (idx !== -1) packages[idx] = { ...packages[idx], ...data };
    } else {
        packages.push({ id: generateId(), ...data });
    }
    saveData('packages', packages);
    closeModal('packageModal');
    showNotification(editId ? 'C·∫≠p nh·∫≠t!' : 'Th√™m th√†nh c√¥ng!');
    renderPackagesTable();
}

function deletePackage(id) {
    if (!confirm('X√≥a g√≥i n√†y?')) return;
    packages = packages.filter(p => p.id !== id);
    saveData('packages', packages);
    showNotification('ƒê√£ x√≥a!');
    renderPackagesTable();
}

function renderPromotionsTable() {
    const now = new Date();
    const tbody = document.getElementById('promotionsTableBody');
    tbody.innerHTML = promotions.length === 0 ? `<tr><td colspan="6"><div class="empty-state"><p>Ch∆∞a c√≥ KM</p></div></td></tr>` : promotions.map(p => {
        const expired = new Date(p.endDate) < now;
        return `
            <tr style="${expired ? 'opacity: 0.5;' : ''}">
                <td><strong>${p.name}</strong></td>
                <td>${p.type === 'percent' ? '%' : 'VNƒê'}</td>
                <td>${p.type === 'percent' ? p.value + '%' : formatCurrency(p.value)}</td>
                <td>${formatDate(p.startDate)} - ${formatDate(p.endDate)}</td>
                <td>${expired ? '<span class="text-danger">H·∫øt h·∫°n</span>' : '<span class="text-success">Ho·∫°t ƒë·ªông</span>'}</td>
                <td><div class="action-buttons">
                    <button class="action-btn action-btn-edit" onclick="editPromotion('${p.id}')">‚úèÔ∏è</button>
                    <button class="action-btn action-btn-delete" onclick="deletePromotion('${p.id}')">üóëÔ∏è</button>
                </div></td>
            </tr>
        `;
    }).join('');
}

function openPromotionModal() {
    document.getElementById('editPromotionId').value = '';
    document.getElementById('promotionForm').reset();
    document.getElementById('promotionModalTitle').textContent = 'üéÅ Th√™m KM';
    document.getElementById('promotionStartDate').value = new Date().toISOString().split('T')[0];
    openModal('promotionModal');
}

function editPromotion(id) {
    const p = promotions.find(p => p.id === id);
    if (!p) return;
    document.getElementById('editPromotionId').value = p.id;
    document.getElementById('promotionName').value = p.name;
    document.getElementById('promotionType').value = p.type;
    document.getElementById('promotionValue').value = p.value;
    document.getElementById('promotionStartDate').value = p.startDate;
    document.getElementById('promotionEndDate').value = p.endDate;
    document.getElementById('promotionModalTitle').textContent = '‚úèÔ∏è S·ª≠a KM';
    openModal('promotionModal');
}

function savePromotion(event) {
    event.preventDefault();
    const editId = document.getElementById('editPromotionId').value;
    const data = { name: document.getElementById('promotionName').value.trim(), type: document.getElementById('promotionType').value, value: parseFloat(document.getElementById('promotionValue').value), startDate: document.getElementById('promotionStartDate').value, endDate: document.getElementById('promotionEndDate').value };
    
    if (editId) {
        const idx = promotions.findIndex(p => p.id === editId);
        if (idx !== -1) promotions[idx] = { ...promotions[idx], ...data };
    } else {
        promotions.push({ id: generateId(), ...data });
    }
    saveData('promotions', promotions);
    closeModal('promotionModal');
    showNotification(editId ? 'C·∫≠p nh·∫≠t!' : 'Th√™m th√†nh c√¥ng!');
    renderPromotionsTable();
}

function deletePromotion(id) {
    if (!confirm('X√≥a KM n√†y?')) return;
    promotions = promotions.filter(p => p.id !== id);
    saveData('promotions', promotions);
    showNotification('ƒê√£ x√≥a!');
    renderPromotionsTable();
}

// ==========================================
// üì§ EXPORT & BACKUP
// ==========================================
function exportAllToExcel() {
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(students.map(s => ({ T√™n: s.name, Tu·ªïi: s.age, 'Ph·ª• huynh': s.parentName, SƒêT: s.parentPhone, Email: s.parentEmail, 'M√¥n h·ªçc': s.subjects.join(', '), 'Tr·∫°ng th√°i': s.status }))), 'H·ªçc Vi√™n');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(appointments.map(a => { const s = students.find(st => st.id === a.studentId); return { 'H·ªçc vi√™n': s?.name, M√¥n: a.subject, Ng√†y: a.date, Gi·ªù: a.time }; })), 'L·ªãch H·∫πn');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(registrations.map(r => ({ 'M√£ phi·∫øu': r.regCode, 'H·ªçc vi√™n': r.studentName, M√¥n: r.subject, 'H·ªçc ph√≠': r.tuitionFee, 'Gi·∫£m gi√°': r.discountAmount, 'Th√†nh ti·ªÅn': r.finalAmount, Ng√†y: r.registrationDate }))), 'Phi·∫øu ƒêK');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(receipts.map(r => { const s = students.find(st => st.id === r.studentId); return { Lo·∫°i: r.type, 'H·ªçc vi√™n': s?.name, 'N·ªôi dung': r.description, 'S·ªë ti·ªÅn': r.amount, Ng√†y: r.date }; })), 'Bi√™n Lai');
    XLSX.writeFile(wb, `BaoCao_${formatDateFile()}.xlsx`);
    showNotification('Xu·∫•t Excel th√†nh c√¥ng!');
}

function exportStudentsToExcel() {
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(students.map(s => ({ T√™n: s.name, Tu·ªïi: s.age, 'Ph·ª• huynh': s.parentName, SƒêT: s.parentPhone, Email: s.parentEmail || '', 'M√¥n h·ªçc': s.subjects.join(', '), 'Tr·∫°ng th√°i': s.status, 'Ghi ch√∫': s.notes || '' }))), 'H·ªçc Vi√™n');
    XLSX.writeFile(wb, `HocVien_${formatDateFile()}.xlsx`);
    showNotification('Xu·∫•t th√†nh c√¥ng!');
}

function exportTrialStudentsToExcel() {
    const data = students.filter(s => s.status === 'H·ªçc Th·ª≠' || s.status === 'Ch·ªù ƒêƒÉng K√Ω');
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data.map(s => ({ T√™n: s.name, Tu·ªïi: s.age, 'Ph·ª• huynh': s.parentName, SƒêT: s.parentPhone, 'M√¥n h·ªçc': s.subjects.join(', '), 'Tr·∫°ng th√°i': s.status }))), 'H·ªçc Th·ª≠');
    XLSX.writeFile(wb, `HocThu_${formatDateFile()}.xlsx`);
    showNotification('Xu·∫•t th√†nh c√¥ng!');
}

function exportAppointmentsToExcel() {
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(appointments.map(a => { const s = students.find(st => st.id === a.studentId); return { 'H·ªçc vi√™n': s?.name || '', 'Ph·ª• huynh': s?.parentName || '', SƒêT: s?.parentPhone || '', M√¥n: a.subject, Ng√†y: a.date, Gi·ªù: a.time, 'Ghi ch√∫': a.notes || '' }; })), 'L·ªãch H·∫πn');
    XLSX.writeFile(wb, `LichHen_${formatDateFile()}.xlsx`);
    showNotification('Xu·∫•t th√†nh c√¥ng!');
}

function exportRegistrationsToExcel() {
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(registrations.map(r => ({ 'M√£ phi·∫øu': r.regCode, 'H·ªçc vi√™n': r.studentName, 'Ph·ª• huynh': r.parentName, SƒêT: r.parentPhone, M√¥n: r.subject, 'H·ªçc ph√≠': r.tuitionFee, 'Gi·∫£m gi√°': r.discountAmount, 'Th√†nh ti·ªÅn': r.finalAmount, 'Ng√†y ƒêK': r.registrationDate }))), 'Phi·∫øu ƒêK');
    XLSX.writeFile(wb, `PhieuDK_${formatDateFile()}.xlsx`);
    showNotification('Xu·∫•t th√†nh c√¥ng!');
}

function exportReceiptsToExcel() {
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(receipts.map(r => { const s = students.find(st => st.id === r.studentId); return { Lo·∫°i: r.type, 'H·ªçc vi√™n': s?.name || '', 'Ph·ª• huynh': r.parentName, SƒêT: r.parentPhone, 'N·ªôi dung': r.description, 'S·ªë ti·ªÅn': r.amount, Ng√†y: r.date }; })), 'Bi√™n Lai');
    XLSX.writeFile(wb, `BienLai_${formatDateFile()}.xlsx`);
    showNotification('Xu·∫•t th√†nh c√¥ng!');
}

function exportBackupJSON() {
    const backup = { version: '3.1', exportDate: new Date().toISOString(), data: { students, appointments, registrations, receipts, subjects, packages, promotions, centerInfo, bankInfo } };
    const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Backup_${formatDateFile()}.json`; a.click();
    showNotification('T·∫£i backup th√†nh c√¥ng!');
}

function restoreFromJSON(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const backup = JSON.parse(e.target.result);
            if (!backup.data) throw new Error('File kh√¥ng h·ª£p l·ªá!');
            if (!confirm('Ghi ƒë√® to√†n b·ªô d·ªØ li·ªáu?')) return;
            
            students = backup.data.students || [];
            appointments = backup.data.appointments || [];
            registrations = backup.data.registrations || [];
            receipts = backup.data.receipts || [];
            subjects = backup.data.subjects || subjects;
            packages = backup.data.packages || [];
            promotions = backup.data.promotions || [];
            centerInfo = backup.data.centerInfo || {};
            bankInfo = backup.data.bankInfo || {};
            
            ['students', 'appointments', 'registrations', 'receipts', 'subjects', 'packages', 'promotions'].forEach(key => localStorage.setItem(key, JSON.stringify(eval(key))));
            localStorage.setItem('centerInfo', JSON.stringify(centerInfo));
            localStorage.setItem('bankInfo', JSON.stringify(bankInfo));
            
            renderAll(); loadCenterInfo(); loadBankInfo();
            showNotification('Kh√¥i ph·ª•c th√†nh c√¥ng!');
        } catch (err) { showNotification('L·ªói: ' + err.message, 'error'); }
    };
    reader.readAsText(file);
    event.target.value = '';
}

function importFromExcel(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const wb = XLSX.read(e.target.result, { type: 'binary' });
            const sheet = wb.Sheets[wb.SheetNames[0]];
            const data = XLSX.utils.sheet_to_json(sheet);
            
            if (!confirm(`Import ${data.length} d√≤ng d·ªØ li·ªáu?`)) return;
            
            data.forEach(row => {
                const existing = students.find(s => normalizePhone(s.parentPhone) === normalizePhone(row['SƒêT'] || ''));
                if (!existing) {
                    students.push({
                        id: generateId(),
                        name: row['T√™n'] || '',
                        age: parseInt(row['Tu·ªïi']) || 0,
                        parentName: row['Ph·ª• huynh'] || '',
                        parentPhone: row['SƒêT'] || '',
                        parentEmail: row['Email'] || '',
                        subjects: (row['M√¥n h·ªçc'] || '').split(',').map(s => s.trim()).filter(s => s),
                        status: row['Tr·∫°ng th√°i'] || 'H·ªçc Th·ª≠',
                        notes: row['Ghi ch√∫'] || '',
                        previousStatus: null,
                        registrations: [],
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });
                }
            });
            
            saveData('students', students);
            renderAll();
            showNotification(`Import th√†nh c√¥ng!`);
        } catch (err) { showNotification('L·ªói: ' + err.message, 'error'); }
    };
    reader.readAsBinaryString(file);
    event.target.value = '';
}

function createAutoBackup() {
    const backup = { id: generateId(), date: new Date().toISOString(), type: 'auto', data: { students, appointments, registrations, receipts, subjects, packages, promotions, centerInfo, bankInfo } };
    backupHistory.unshift(backup);
    if (backupHistory.length > 10) backupHistory = backupHistory.slice(0, 10);
    localStorage.setItem('backupHistory', JSON.stringify(backupHistory));
}

function createManualBackup() {
    const backup = { id: generateId(), date: new Date().toISOString(), type: 'manual', data: { students, appointments, registrations, receipts, subjects, packages, promotions, centerInfo, bankInfo } };
    backupHistory.unshift(backup);
    if (backupHistory.length > 10) backupHistory = backupHistory.slice(0, 10);
    localStorage.setItem('backupHistory', JSON.stringify(backupHistory));
    renderBackupHistory();
    showNotification('Backup th√†nh c√¥ng!');
}

function toggleAutoBackup() {
    autoBackupEnabled = document.getElementById('autoBackupToggle').checked;
    localStorage.setItem('autoBackupEnabled', autoBackupEnabled);
    updateAutoBackupStatus();
    if (autoBackupEnabled) { createAutoBackup(); showNotification('B·∫≠t auto backup!'); }
}

function updateAutoBackupStatus() {
    document.getElementById('autoBackupStatus').innerHTML = autoBackupEnabled ? '<span class="text-success">‚úÖ ƒêang ho·∫°t ƒë·ªông</span>' : '<span class="text-danger">‚ùå T·∫Øt</span>';
}

function renderBackupHistory() {
    const container = document.getElementById('backupHistoryList');
    container.innerHTML = backupHistory.length === 0 ? '<p class="text-muted">Ch∆∞a c√≥ backup</p>' : backupHistory.slice(0, 5).map(b => `
        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <strong>${b.type === 'auto' ? 'üîÑ T·ª± ƒë·ªông' : 'üíæ Th·ªß c√¥ng'}</strong><br>
                <small class="text-muted">${new Date(b.date).toLocaleString('vi-VN')}</small>
            </div>
            <button class="btn btn-sm btn-info" onclick="restoreFromBackupHistory('${b.id}')">Kh√¥i ph·ª•c</button>
        </div>
    `).join('');
}

function restoreFromBackupHistory(id) {
    const backup = backupHistory.find(b => b.id === id);
    if (!backup || !confirm('Kh√¥i ph·ª•c t·ª´ backup n√†y?')) return;
    
    students = backup.data.students || [];
    appointments = backup.data.appointments || [];
    registrations = backup.data.registrations || [];
    receipts = backup.data.receipts || [];
    subjects = backup.data.subjects || subjects;
    packages = backup.data.packages || [];
    promotions = backup.data.promotions || [];
    centerInfo = backup.data.centerInfo || {};
    bankInfo = backup.data.bankInfo || {};
    
    ['students', 'appointments', 'registrations', 'receipts', 'subjects', 'packages', 'promotions'].forEach(key => localStorage.setItem(key, JSON.stringify(eval(key))));
    localStorage.setItem('centerInfo', JSON.stringify(centerInfo));
    localStorage.setItem('bankInfo', JSON.stringify(bankInfo));
    
    renderAll(); loadCenterInfo(); loadBankInfo();
    showNotification('Kh√¥i ph·ª•c th√†nh c√¥ng!');
}

// ==========================================
// ‚öôÔ∏è SETTINGS
// ==========================================
function saveCenterInfo(event) {
    event.preventDefault();
    centerInfo = { name: document.getElementById('centerName').value.trim(), phone: document.getElementById('centerPhone').value.trim(), address: document.getElementById('centerAddress').value.trim(), email: document.getElementById('centerEmail').value.trim(), website: document.getElementById('centerWebsite').value.trim(), logo: centerInfo.logo || '' };
    localStorage.setItem('centerInfo', JSON.stringify(centerInfo));
    showNotification('L∆∞u th√†nh c√¥ng!');
}

function loadCenterInfo() {
    document.getElementById('centerName').value = centerInfo.name || '';
    document.getElementById('centerPhone').value = centerInfo.phone || '';
    document.getElementById('centerAddress').value = centerInfo.address || '';
    document.getElementById('centerEmail').value = centerInfo.email || '';
    document.getElementById('centerWebsite').value = centerInfo.website || '';
    if (centerInfo.logo) document.getElementById('logoPreview').innerHTML = `<img src="${centerInfo.logo}">`;
}

function previewLogo(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        centerInfo.logo = e.target.result;
        document.getElementById('logoPreview').innerHTML = `<img src="${e.target.result}">`;
    };
    reader.readAsDataURL(file);
}

function saveBankInfo(event) {
    event.preventDefault();
    bankInfo = { bankName: document.getElementById('bankName').value.trim(), accountNumber: document.getElementById('bankAccount').value.trim(), accountName: document.getElementById('bankAccountName').value.trim(), branch: document.getElementById('bankBranch').value.trim() };
    localStorage.setItem('bankInfo', JSON.stringify(bankInfo));
    generateBankQR();
    showNotification('L∆∞u th√†nh c√¥ng!');
}

function loadBankInfo() {
    document.getElementById('bankName').value = bankInfo.bankName || '';
    document.getElementById('bankAccount').value = bankInfo.accountNumber || '';
    document.getElementById('bankAccountName').value = bankInfo.accountName || '';
    document.getElementById('bankBranch').value = bankInfo.branch || '';
    generateBankQR();
}

function generateBankQR() {
    const container = document.getElementById('bankQRCode');
    container.innerHTML = '';
    if (bankInfo.accountNumber) {
        new QRCode(container, { text: `${bankInfo.bankName}|${bankInfo.accountNumber}|${bankInfo.accountName}`, width: 120, height: 120 });
    }
}

function clearAllData() {
    if (!confirm('X√ìA TO√ÄN B·ªò D·ªÆ LI·ªÜU?')) return;
    if (prompt('Nh·∫≠p "XOA" ƒë·ªÉ x√°c nh·∫≠n:') !== 'XOA') return;
    localStorage.clear();
    location.reload();
}

// ==========================================
// üõ†Ô∏è UTILITIES
// ==========================================
function renderAll() {
    renderDashboard();
    renderStudentsTable();
    updateStudentCounts();
    renderTrialStudentsTable();
    updateTrialCounts();
    renderAppointmentsTable();
    renderRegistrationsTable();
    renderReceiptsTable();
    renderSubjectsTable();
    renderPackagesTable();
    renderPromotionsTable();
    renderBackupHistory();
    renderSubjectCheckboxes();
}

function formatDate(dateStr) {
    if (!dateStr) return '';
    const d = new Date(dateStr);
    return `${d.getDate()}/${d.getMonth() + 1}/${d.getFullYear()}`;
}

function formatDateFile() {
    const d = new Date();
    return `${d.getFullYear()}${String(d.getMonth() + 1).padStart(2, '0')}${String(d.getDate()).padStart(2, '0')}`;
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount || 0);
}

function formatCurrencyShort(amount) {
    if (amount >= 1000000) return (amount / 1000000).toFixed(1) + 'tr';
    if (amount >= 1000) return (amount / 1000).toFixed(0) + 'k';
    return amount.toString();
}

function formatNumberInput(num) {
    return new Intl.NumberFormat('vi-VN').format(num || 0);
}

function formatCurrencyInput(input) {
    let v = input.value.replace(/\D/g, '');
    input.value = v ? parseInt(v).toLocaleString('vi-VN') : '';
}

function parseCurrencyInput(str) {
    return parseInt((str || '').replace(/\D/g, '')) || 0;
}

function normalizePhone(phone) {
    let n = (phone || '').replace(/[\s\-\.]/g, '');
    if (n.startsWith('+84')) n = '0' + n.substring(3);
    else if (n.startsWith('84') && n.length > 10) n = '0' + n.substring(2);
    return n;
}

function numberToWords(num) {
    if (!num) return 'Kh√¥ng ƒë·ªìng';
    const ones = ['', 'm·ªôt', 'hai', 'ba', 'b·ªën', 'nƒÉm', 's√°u', 'b·∫£y', 't√°m', 'ch√≠n'];
    const convert = (n) => {
        if (n === 0) return '';
        let r = '';
        const h = Math.floor(n / 100), rm = n % 100, t = Math.floor(rm / 10), o = rm % 10;
        if (h > 0) r += ones[h] + ' trƒÉm ';
        if (t > 1) { r += ['', '', 'hai m∆∞∆°i', 'ba m∆∞∆°i', 'b·ªën m∆∞∆°i', 'nƒÉm m∆∞∆°i', 's√°u m∆∞∆°i', 'b·∫£y m∆∞∆°i', 't√°m m∆∞∆°i', 'ch√≠n m∆∞∆°i'][t] + ' '; if (o === 1) r += 'm·ªët '; else if (o === 5) r += 'lƒÉm '; else if (o > 0) r += ones[o] + ' '; }
        else if (t === 1) { r += 'm∆∞·ªùi '; if (o === 5) r += 'lƒÉm '; else if (o > 0) r += ones[o] + ' '; }
        else if (o > 0) { if (h > 0) r += 'l·∫ª '; r += ones[o] + ' '; }
        return r;
    };
    let result = '';
    const b = Math.floor(num / 1000000000), m = Math.floor((num % 1000000000) / 1000000), k = Math.floor((num % 1000000) / 1000), r = num % 1000;
    if (b > 0) result += convert(b) + 't·ª∑ ';
    if (m > 0) result += convert(m) + 'tri·ªáu ';
    if (k > 0) result += convert(k) + 'ngh√¨n ';
    if (r > 0) result += convert(r);
    return (result.trim() + ' ƒë·ªìng').replace(/^\w/, c => c.toUpperCase());
}
    </script>
</body>
</html>
